name: GitHub Pages Deployment (CI)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to compare changes

      - name: ğŸ“‚ Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v41

      # ============================================
      # SASS COMPILATION (Conditional)
      # ============================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            landpage/src_static/scss/package-lock.json
            cv_web/src_static/scss/package-lock.json
            landpage/src_static/typescript/package-lock.json

      - name: ğŸ¨ Build CSS from Sass (Landpage)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'landpage/src_static/scss/')
        run: |
          echo "ğŸ“ Building Landpage Sass..."
          cd landpage/src_static/scss
          npm install
          npm run sass:build
          cd ../../..
          echo "âœ… Landpage style.css created"

      - name: ğŸ¨ Build CSS from Sass (cv_web)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'cv_web/src_static/scss/')
        run: |
          echo "ğŸ“ Building cv_web Sass..."
          cd cv_web/src_static/scss
          npm install
          npm run sass:build
          cd ../../..
          echo "âœ… cv_web/style.css created"

      # ============================================
      # TYPESCRIPT COMPILATION (Conditional)
      # ============================================
      - name: ğŸ“œ Build JS from TypeScript (Landpage)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'landpage/src_static/typescript/')
        run: |
          echo "ğŸ“œ Building Landpage TypeScript..."
          cd landpage/src_static/typescript
          npm install
          npm run ts:build
          cd ../../..
          echo "âœ… Landpage script.js created"

      # ============================================
      # MYFEED BUILD (Vue 3 + Vite - Conditional)
      # ============================================
      - name: ğŸ”¨ Build MyFeed (Vue 3 + Vite)
        id: build-myfeed
        if: contains(steps.changed-files.outputs.all_changed_files, 'myfeed/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyFeed Vue application..."
          cd myfeed
          npm install
          npm run build
          echo "âœ… MyFeed Vue build complete"

      - name: â™»ï¸ Cache MyGames Build
        id: cache-mygames
        uses: actions/cache@v4
        with:
          path: mygames/src/build
          key: ${{ runner.os }}-mygames-${{ hashFiles('mygames/src/**') }}

      - name: ğŸ”¨ Build MyGames (SvelteKit)
        id: build-mygames
        if: contains(steps.changed-files.outputs.all_changed_files, 'mygames/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyGames SvelteKit project..."
          cd mygames/src
          npm install
          NODE_ENV=production npm run build
          cd ../..
          echo "âœ… MyGames build complete"

      - name: ğŸ”¨ Build Nexus (Vue 3 + Tailwind)
        id: build-nexus
        if: contains(steps.changed-files.outputs.all_changed_files, 'nexus/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Nexus Holdings application..."
          cd nexus
          npm install
          npm run build
          cd ..
          echo "âœ… Nexus build complete"

      - name: ğŸ”¨ Build Cloud Dashboard (Sass + TypeScript)
        id: build-cloud
        if: contains(steps.changed-files.outputs.all_changed_files, 'cloud/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Cloud Dashboard..."
          cd cloud
          npm install
          npm run build
          cd ..
          echo "âœ… Cloud Dashboard build complete"

      - name: ğŸ”¨ Build Feed Yourself (Static HTML)
        id: build-feed-yourself
        if: contains(steps.changed-files.outputs.all_changed_files, 'feed_yourself/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Feed Yourself application..."
          cd feed_yourself/1.ops
          bash build.sh build
          cd ../..
          echo "âœ… Feed Yourself build complete"

      - name: ğŸ”¨ Build Others Index (Python)
        if: contains(steps.changed-files.outputs.all_changed_files, 'others/')
        run: |
          echo "ğŸ”¨ Building Others index page..."
          cd others
          python3 build_index.py
          cd ..
          echo "âœ… Others index.html generated"

      - name: ğŸ”¨ Build Health Tracker (Static HTML)
        id: build-health-tracker
        if: contains(steps.changed-files.outputs.all_changed_files, 'health_tracker/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Health Tracker application..."
          cd health_tracker/1.ops
          bash build.sh build
          cd ../..
          echo "âœ… Health Tracker build complete"

      - name: ğŸ”¨ Build Market Watch (Sass + TypeScript)
        id: build-market-watch
        if: contains(steps.changed-files.outputs.all_changed_files, 'market_watch/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Market Watch Terminal..."
          cd market_watch
          npm install
          npm run build
          cd ..
          echo "âœ… Market Watch build complete"

      - name: ğŸ”¨ Build Central Bank Forecasting (Tailwind + TypeScript)
        id: build-central-bank
        if: contains(steps.changed-files.outputs.all_changed_files, 'central_bank/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Central Bank Forecasting..."
          cd central_bank/1.ops
          bash build.sh build
          cd ../..
          echo "âœ… Central Bank Forecasting build complete"

      - name: ğŸ”¨ Build MyMaps (Next.js + Sass)
        id: build-mymaps
        if: contains(steps.changed-files.outputs.all_changed_files, 'mymaps/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyMaps..."
          cd mymaps
          npm install
          npm run build
          cd ..
          echo "âœ… MyMaps build complete"

      - name: ğŸ”¨ Build MyProfile (Nuxt 4 + Sass)
        id: build-myprofile
        if: contains(steps.changed-files.outputs.all_changed_files, 'myprofile/')
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyProfile..."
          cd myprofile/src
          npm install
          npm run generate
          cd ../..
          echo "âœ… MyProfile build complete"

      # ============================================
      # BUILD STATUS SUMMARY
      # ============================================
      - name: ğŸ“Š Build Status Summary
        run: |
          echo "============================================"
          echo "ğŸ“Š BUILD STATUS SUMMARY"
          echo "============================================"
          FAILED=""

          if [ "${{ steps.build-myfeed.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: MyFeed (Vue 3)"
            FAILED="$FAILED myfeed"
          elif [ "${{ steps.build-myfeed.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: MyFeed (Vue 3)"
          fi

          if [ "${{ steps.build-mygames.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: MyGames (SvelteKit)"
            FAILED="$FAILED mygames"
          elif [ "${{ steps.build-mygames.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: MyGames (SvelteKit)"
          fi

          if [ "${{ steps.build-nexus.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: Nexus (Vue 3)"
            FAILED="$FAILED nexus"
          elif [ "${{ steps.build-nexus.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: Nexus (Vue 3)"
          fi

          if [ "${{ steps.build-cloud.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: Cloud Dashboard"
            FAILED="$FAILED cloud"
          elif [ "${{ steps.build-cloud.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: Cloud Dashboard"
          fi

          if [ "${{ steps.build-feed-yourself.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: Feed Yourself"
            FAILED="$FAILED feed_yourself"
          elif [ "${{ steps.build-feed-yourself.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: Feed Yourself"
          fi

          if [ "${{ steps.build-health-tracker.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: Health Tracker"
            FAILED="$FAILED health_tracker"
          elif [ "${{ steps.build-health-tracker.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: Health Tracker"
          fi

          if [ "${{ steps.build-market-watch.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: Market Watch"
            FAILED="$FAILED market_watch"
          elif [ "${{ steps.build-market-watch.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: Market Watch"
          fi

          if [ "${{ steps.build-central-bank.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: Central Bank Forecasting"
            FAILED="$FAILED central_bank"
          elif [ "${{ steps.build-central-bank.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: Central Bank Forecasting"
          fi

          if [ "${{ steps.build-mymaps.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: MyMaps"
            FAILED="$FAILED mymaps"
          elif [ "${{ steps.build-mymaps.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: MyMaps"
          fi

          if [ "${{ steps.build-myprofile.outcome }}" == "failure" ]; then
            echo "âŒ FAILED: MyProfile"
            FAILED="$FAILED myprofile"
          elif [ "${{ steps.build-myprofile.outcome }}" == "success" ]; then
            echo "âœ… SUCCESS: MyProfile"
          fi

          echo "============================================"

          if [ -n "$FAILED" ]; then
            echo "âš ï¸ WARNING: Some builds failed:$FAILED"
            echo "âš ï¸ Deployment will continue with existing dist/ files for failed projects"
            echo ""
            echo "::warning::Build failures detected:$FAILED - check logs above for details"
          else
            echo "âœ… All triggered builds completed successfully!"
          fi

      - name: ğŸŒ Setup Pages Environment
        uses: actions/configure-pages@v5

      - name: ğŸ“‚ Prepare Site for Deployment
        run: |
          echo "ğŸ“‹ Creating _site directory and copying all files..."
          mkdir -p _site
          # Copy cv_pdf and others (no build needed)
          cp -r cv_pdf/ others/ _site/ 2>/dev/null || true

          # Copy Linktree build (if dist exists)
          if [ -d "linktree/dist" ]; then
            echo "ğŸ“¦ Copying Linktree build..."
            mkdir -p _site/linktree
            # Use -L to dereference symlinks (dist may contain symlinks to public/)
            cp -rL linktree/dist/* _site/linktree/ 2>/dev/null || cp -r linktree/dist/* _site/linktree/
            cp -r linktree/public/* _site/linktree/ 2>/dev/null || true
            echo "âœ… Linktree build copied to _site/linktree/"
          fi

          # Copy CV Web build (if dist exists)
          if [ -d "cv_web/dist" ]; then
            echo "ğŸ“¦ Copying CV Web build..."
            mkdir -p _site/cv_web
            # Use -L to dereference symlinks (dist contains symlinks to public/)
            cp -rL cv_web/dist/* _site/cv_web/ 2>/dev/null || cp -r cv_web/dist/* _site/cv_web/
            cp -r cv_web/public/* _site/cv_web/ 2>/dev/null || true
            echo "âœ… CV Web build copied to _site/cv_web/"
          fi

          # Copy Landpage (main landing page)
          if [ -d "landpage/dist" ]; then
            echo "ğŸ“¦ Copying Landpage build..."
            mkdir -p _site/landpage
            # Use -L to dereference symlinks (dist contains symlinks to public/)
            cp -rL landpage/dist/* _site/landpage/ 2>/dev/null || cp -r landpage/dist/* _site/landpage/
            echo "âœ… Landpage build copied to _site/landpage/"
          elif [ -d "landpage/src_static" ]; then
            echo "ğŸ“¦ Copying Landpage src_static..."
            mkdir -p _site/landpage
            cp landpage/src_static/index.html landpage/src_static/style.css landpage/src_static/script.js _site/landpage/ 2>/dev/null || true
            cp -r landpage/public _site/landpage/ 2>/dev/null || true
            echo "âœ… Landpage src_static copied to _site/landpage/"
          fi

          # Copy Matomo tracking scripts
          if [ -d "1.ops/matomo-tracking" ]; then
            echo "ğŸ“Š Copying Matomo tracking scripts..."
            mkdir -p _site/1.ops/matomo-tracking
            cp -r 1.ops/matomo-tracking/* _site/1.ops/matomo-tracking/
            echo "âœ… Matomo tracking scripts copied"
          fi

          # Copy MyFeed Vue build (if dist exists)
          if [ -d "myfeed/dist" ]; then
            echo "ğŸ“¦ Copying MyFeed Vue build..."
            mkdir -p _site/myfeed
            cp -rL myfeed/dist/* _site/myfeed/ 2>/dev/null || cp -r myfeed/dist/* _site/myfeed/
            echo "âœ… MyFeed Vue build copied to _site/myfeed/"
          else
            echo "â­ï¸  Skipping MyFeed copy (no dist directory found)"
          fi

          # Copy MyGames SvelteKit build (if build exists)
          if [ -d "mygames/src/build" ]; then
            echo "ğŸ“¦ Copying MyGames SvelteKit build..."
            mkdir -p _site/mygames
            cp -rL mygames/src/build/* _site/mygames/ 2>/dev/null || cp -r mygames/src/build/* _site/mygames/
            echo "âœ… MyGames build copied to _site/mygames/"
          else
            echo "â­ï¸  Skipping MyGames copy (no build directory found)"
          fi

          # Copy Nexus Vue build (if dist exists)
          if [ -d "nexus/dist" ]; then
            echo "ğŸ“¦ Copying Nexus Holdings build..."
            mkdir -p _site/nexus
            cp -rL nexus/dist/* _site/nexus/ 2>/dev/null || cp -r nexus/dist/* _site/nexus/
            echo "âœ… Nexus build copied to _site/nexus/"
          else
            echo "â­ï¸  Skipping Nexus copy (no dist directory found)"
          fi

          # Copy Cloud Dashboard build (if dist exists)
          if [ -d "cloud/dist" ]; then
            echo "ğŸ“¦ Copying Cloud Dashboard build..."
            mkdir -p _site/cloud
            cp -rL cloud/dist/* _site/cloud/ 2>/dev/null || cp -r cloud/dist/* _site/cloud/
            echo "âœ… Cloud Dashboard build copied to _site/cloud/"
          else
            echo "â­ï¸  Skipping Cloud Dashboard copy (no dist directory found)"
          fi

          # Copy Feed Yourself build (if dist exists)
          if [ -d "feed_yourself/dist" ]; then
            echo "ğŸ“¦ Copying Feed Yourself build..."
            mkdir -p _site/feed_yourself
            cp -rL feed_yourself/dist/* _site/feed_yourself/ 2>/dev/null || cp -r feed_yourself/dist/* _site/feed_yourself/
            echo "âœ… Feed Yourself build copied to _site/feed_yourself/"
          else
            echo "â­ï¸  Skipping Feed Yourself copy (no dist directory found)"
          fi

          # Copy Health Tracker build (if dist exists)
          if [ -d "health_tracker/dist" ]; then
            echo "ğŸ“¦ Copying Health Tracker build..."
            mkdir -p _site/health_tracker
            cp -rL health_tracker/dist/* _site/health_tracker/ 2>/dev/null || cp -r health_tracker/dist/* _site/health_tracker/
            echo "âœ… Health Tracker build copied to _site/health_tracker/"
          else
            echo "â­ï¸  Skipping Health Tracker copy (no dist directory found)"
          fi

          # Copy Market Watch build (if dist exists)
          if [ -d "market_watch/dist" ]; then
            echo "ğŸ“¦ Copying Market Watch build..."
            mkdir -p _site/market_watch
            cp -rL market_watch/dist/* _site/market_watch/ 2>/dev/null || cp -r market_watch/dist/* _site/market_watch/
            echo "âœ… Market Watch build copied to _site/market_watch/"
          else
            echo "â­ï¸  Skipping Market Watch copy (no dist directory found)"
          fi

          # Copy Central Bank Forecasting build (if dist exists)
          if [ -d "central_bank/dist" ]; then
            echo "ğŸ“¦ Copying Central Bank Forecasting build..."
            mkdir -p _site/central_bank
            cp -rL central_bank/dist/* _site/central_bank/ 2>/dev/null || cp -r central_bank/dist/* _site/central_bank/
            echo "âœ… Central Bank Forecasting build copied to _site/central_bank/"
          else
            echo "â­ï¸  Skipping Central Bank Forecasting copy (no dist directory found)"
          fi

          # Copy MyMaps build (if out exists - Next.js static export)
          if [ -d "mymaps/out" ]; then
            echo "ğŸ“¦ Copying MyMaps build..."
            mkdir -p _site/mymaps
            cp -rL mymaps/out/* _site/mymaps/ 2>/dev/null || cp -r mymaps/out/* _site/mymaps/
            echo "âœ… MyMaps build copied to _site/mymaps/"
          else
            echo "â­ï¸  Skipping MyMaps copy (no out directory found)"
          fi

          # Copy MyProfile build (if dist exists - Nuxt static export)
          if [ -d "myprofile/dist" ]; then
            echo "ğŸ“¦ Copying MyProfile build..."
            mkdir -p _site/myprofile
            cp -rL myprofile/dist/* _site/myprofile/ 2>/dev/null || cp -r myprofile/dist/* _site/myprofile/
            echo "âœ… MyProfile build copied to _site/myprofile/"
          else
            echo "â­ï¸  Skipping MyProfile copy (no dist directory found)"
          fi

          echo "âœ… All files prepared for deployment"

          # Remove any broken symlinks that could cause tar to fail
          echo "ğŸ”— Checking for broken symlinks..."
          find _site -type l ! -exec test -e {} \; -delete 2>/dev/null || true
          echo "âœ… Broken symlinks removed"

          echo "ğŸ“Š Site structure:"
          ls -lah _site/
          echo ""
          echo "ğŸ“Š MyFeed contents:"
          ls -lah _site/myfeed/ 2>/dev/null || echo "No myfeed directory"

      - name: â¬†ï¸ Upload Site Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4