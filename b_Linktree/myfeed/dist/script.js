"use strict";(()=>{var J=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],T=[{id:"github",name:"GitHub",color:"#238636",url:"https://github.com/diegonmarcos.atom",enabled:!0},{id:"youtube",name:"YouTube",color:"#ff0000",url:"",enabled:!1},{id:"lastfm",name:"Last.fm",color:"#d51007",url:"",enabled:!1},{id:"reddit",name:"Reddit",color:"#ff4500",url:"",enabled:!1},{id:"letterboxd",name:"Letterboxd",color:"#00d735",url:"",enabled:!1},{id:"mastodon",name:"Mastodon",color:"#6364ff",url:"",enabled:!1},{id:"goodreads",name:"Goodreads",color:"#553b08",url:"",enabled:!1},{id:"devto",name:"DEV.to",color:"#0a0a0a",url:"",enabled:!1}];async function Z(e){try{let n=await fetch(e,{mode:"cors"});if(n.ok)return await n.text()}catch{}for(let n of J)try{let t=await fetch(n+encodeURIComponent(e));if(t.ok)return await t.text()}catch{console.warn(`Proxy ${n} failed`)}return null}function G(e){let t=new DOMParser().parseFromString(e,"text/xml"),s=[];return t.querySelectorAll("item").forEach((o,r)=>{if(r>=15)return;let i=o.querySelector("title")?.textContent||"",c=o.querySelector("link")?.textContent||"",l=o.querySelector("pubDate")?.textContent,u=o.querySelector("description")?.textContent||"";s.push({id:`rss-${r}`,title:i.replace(/<!\[CDATA\[|\]\]>/g,"").trim(),link:c,date:l?new Date(l):new Date,description:u.replace(/<[^>]*>/g,"").slice(0,100)})}),s.length===0&&t.querySelectorAll("entry").forEach((o,r)=>{if(r>=15)return;let i=o.querySelector("title")?.textContent||"",l=o.querySelector("link[href]")?.getAttribute("href")||"",u=o.querySelector("updated")?.textContent||o.querySelector("published")?.textContent;s.push({id:`atom-${r}`,title:i.trim(),link:l,date:u?new Date(u):new Date})}),s}var h="apps-feed-cache",Q=5*60*1e3;function Y(e){try{let n=localStorage.getItem(h);if(n){let t=JSON.parse(n);if(t[e]&&Date.now()-t[e].timestamp<Q)return t[e].items.map(s=>({...s,date:new Date(s.date)}))}}catch{}return null}function K(e,n){try{let t=localStorage.getItem(h),s=t?JSON.parse(t):{};s[e]={items:n,timestamp:Date.now()},localStorage.setItem(h,JSON.stringify(s))}catch{}}function X(){localStorage.removeItem(h)}function E(e){let t=new Date().getTime()-e.getTime(),s=Math.floor(t/6e4),o=Math.floor(t/36e5),r=Math.floor(t/864e5);return s<1?"now":s<60?`${s}m`:o<24?`${o}h`:r<7?`${r}d`:e.toLocaleDateString()}function z(e){return`
    <div class="message-item">
      <div class="message-header">
        <span class="message-time">${E(e.date)}</span>
      </div>
      <a href="${e.link}" target="_blank" class="message-title">${e.title}</a>
      ${e.description?`<div class="message-body">${e.description}</div>`:""}
    </div>
  `}function ee(){return'<div class="loading-state"><div class="skeleton-row"></div><div class="skeleton-row"></div></div>'}function x(e="No items"){return`<div class="empty-state">${e}</div>`}async function te(e){if(!e.enabled||!e.url)return[];let n=Y(e.id);if(n)return n;try{let t=await Z(e.url);if(!t)return[];let s=G(t);return K(e.id,s),s}catch(t){return console.warn(`Failed to fetch ${e.name}:`,t),[]}}async function A(e){let n=document.getElementById(`${e.id}-feed`),t=document.getElementById(`${e.id}-count`);if(!n)return;if(!e.enabled||!e.url){n.innerHTML=x("Configure in apps-feed.ts"),t&&(t.textContent="0");return}n.innerHTML=ee();let s=await te(e);s.length===0?n.innerHTML=x("No items"):n.innerHTML=s.map(z).join(""),t&&(t.textContent=String(s.length))}async function F(){await Promise.all(T.map(A));let e=document.getElementById("apps-last-update");e&&(e.textContent=`Updated ${E(new Date)}`);let n=document.getElementById("appsfeed-refresh");n&&n.addEventListener("click",async()=>{X(),await Promise.all(T.map(A)),e&&(e.textContent=`Updated ${E(new Date)}`)})}var ne=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],se={world:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx1YlY4U0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},tech:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGRqTVhZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},science:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRFp0Y1RjU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},markets:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx6TVdZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},hn:{url:"https://hnrss.org/newest?points=50",source:"Hacker News"}},$=new Map,oe=5*60*1e3;async function re(e){for(let n of ne)try{let t=await fetch(n+encodeURIComponent(e));if(t.ok)return await t.text()}catch{console.warn(`Proxy ${n} failed for ${e}`)}return null}function ie(e,n,t){let s=e.querySelector("title")?.textContent||"No title",o=e.querySelector("link")?.textContent||"",r=e.querySelector("pubDate")?.textContent||new Date().toISOString(),i=s.replace(/ - [^-]+$/,"");return{id:`news-${t}`,title:i,source:n,url:o,publishedAt:new Date(r)}}async function ae(e){let n=se[e];if(!n)return[];let t=$.get(e);if(t&&Date.now()-t.timestamp<oe)return t.data;try{let s=await re(n.url);if(!s)return t?.data||[];let i=new DOMParser().parseFromString(s,"text/xml").querySelectorAll("item"),c=[];return i.forEach((l,u)=>{u<15&&c.push(ie(l,n.source,u))}),$.set(e,{data:c,timestamp:Date.now()}),c}catch(s){return console.error(`Error fetching RSS for ${e}:`,s),t?.data||[]}}function R(e){let t=new Date().getTime()-e.getTime(),s=Math.floor(t/6e4),o=Math.floor(t/36e5),r=Math.floor(t/864e5);return s<1?"now":s<60?`${s}m`:o<24?`${o}h`:r<7?`${r}d`:e.toLocaleDateString()}function ce(e){return`
    <div class="message-item">
      <div class="message-header">
        <span class="message-topic">${e.source}</span>
        <span class="message-time">${R(e.publishedAt)}</span>
      </div>
      <a href="${e.url}" target="_blank" class="message-title">${e.title}</a>
    </div>
  `}function le(){return'<div class="loading-state"><div class="skeleton-row"></div><div class="skeleton-row"></div></div>'}function de(){return'<div class="empty-state">No news available</div>'}async function I(){let e=["world","tech","science","markets","hn"];e.forEach(o=>{let r=document.getElementById(`${o}-feed`);r&&(r.innerHTML=le())}),(await Promise.all(e.map(async o=>{let r=await ae(o);return{category:o,items:r}}))).forEach(({category:o,items:r})=>{let i=document.getElementById(`${o}-feed`),c=document.getElementById(`${o}-count`);i&&(r.length===0?i.innerHTML=de():i.innerHTML=r.map(ce).join(""),c&&(c.textContent=String(r.length)))});let t=document.getElementById("news-last-update");t&&(t.textContent=`Updated ${R(new Date)}`);let s=document.getElementById("newsfeed-refresh");s&&s.addEventListener("click",async()=>{$.clear(),await I()})}var m="https://alerts.diegonmarcos.com",ue="https://rss.diegonmarcos.com",me=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],ge=["ssh","auth","sauron","authelia"],pe=["system","docker","npm","mailu","collector"],O=[{name:"gcp-arch",ip:"34.55.55.234"},{name:"oci-flex",ip:"84.235.234.87"},{name:"oci-micro-1",ip:"130.110.251.193"},{name:"oci-micro-2",ip:"129.151.228.66"}],P=["ssh","docker","system","sauron","collector","npm","authelia","mailu"],d=[],a=null,y=[],v=[],C="all",_="24h",D="",L="",M="",k=null,f=!0,w=!1,fe=[{id:1,timestamp:new Date(Date.now()-5*6e4).toISOString(),vm:"gcp-arch",service:"ssh",topic:"auth",title:"SSH: 3 failed logins",message:"[gcp-arch] 3 failed SSH login attempts from 192.168.1.100",priority:"high",tags:"warning,lock",log_cmd:"journalctl -u sshd --since '30s ago' --no-pager",log_path:"",acknowledged:0,ntfy_id:"demo-1"},{id:2,timestamp:new Date(Date.now()-15*6e4).toISOString(),vm:"oci-flex",service:"docker",topic:"system",title:"Docker: container crash",message:"[oci-flex] Container photoprism exited with code 137 (OOM)",priority:"high",tags:"whale,warning",log_cmd:"journalctl -u docker --since '5m ago' | grep -E 'died|killed|OOM'",log_path:"",acknowledged:0,ntfy_id:"demo-2"},{id:3,timestamp:new Date(Date.now()-30*6e4).toISOString(),vm:"gcp-arch",service:"collector",topic:"system",title:"Collector started",message:"[gcp-arch] Log collector is now active",priority:"low",tags:"rocket",log_cmd:"",log_path:"",acknowledged:0,ntfy_id:"demo-3"},{id:4,timestamp:new Date(Date.now()-45*6e4).toISOString(),vm:"oci-micro-1",service:"mailu",topic:"system",title:"Mail queue warning",message:"[oci-micro-1] Mail queue has 15 pending messages",priority:"default",tags:"email",log_cmd:"docker logs mailu-front --since '1h' | grep -i queue",log_path:"",acknowledged:0,ntfy_id:"demo-4"},{id:5,timestamp:new Date(Date.now()-2*36e5).toISOString(),vm:"oci-flex",service:"sauron",topic:"sauron",title:"Malware detected: oci-flex",message:"YARA rule webshell_php matched in /watch/docker-volumes/uploads/shell.php",priority:"urgent",tags:"biohazard,skull",log_cmd:"docker logs sauron --since '1h'",log_path:"",acknowledged:0,ntfy_id:"demo-5"},{id:6,timestamp:new Date(Date.now()-3*36e5).toISOString(),vm:"gcp-arch",service:"authelia",topic:"auth",title:"Authelia: 2FA bypass attempt",message:"[gcp-arch] Failed 2FA verification for user admin from 10.0.0.55",priority:"high",tags:"warning,shield",log_cmd:"docker logs authelia --since '1h' | grep -i failed",log_path:"",acknowledged:0,ntfy_id:"demo-6"},{id:7,timestamp:new Date(Date.now()-6e4).toISOString(),vm:"gcp-arch",service:"npm",topic:"system",title:"NPM: SSL certificate renewed",message:"[gcp-arch] Let's Encrypt certificate renewed for *.diegonmarcos.com",priority:"default",tags:"certificate,check",log_cmd:"",log_path:"",acknowledged:0,ntfy_id:"demo-7"},{id:8,timestamp:new Date(Date.now()-10*6e4).toISOString(),vm:"oci-micro-2",service:"system",topic:"system",title:"Critical: Disk space low",message:"[oci-micro-2] Root partition at 95% capacity",priority:"urgent",tags:"rotating_light",log_cmd:"df -h / && du -sh /var/log/*",log_path:"",acknowledged:0,ntfy_id:"demo-8"}];async function g(e){try{let n=await fetch(e,{mode:"cors"});if(n.ok)return await n.text()}catch{}for(let n of me)try{let t=await fetch(n+encodeURIComponent(e));if(t.ok)return await t.text()}catch{console.warn(`Proxy ${n} failed`)}return null}function U(e){let n=typeof e=="string"?new Date(e):new Date(e*1e3),s=new Date().getTime()-n.getTime(),o=Math.floor(s/6e4),r=Math.floor(s/36e5),i=Math.floor(s/864e5);return o<1?"now":o<60?`${o}m ago`:r<24?`${r}h ago`:i<7?`${i}d ago`:n.toLocaleDateString()}function he(e){return new Date(e).toLocaleString()}function ye(e){let n=typeof e=="number"?e:e==="urgent"||e==="critical"?5:e==="high"?4:e==="default"?3:2;return n>=5?"priority-urgent":n>=4?"priority-high":n>=3?"priority-default":"priority-low"}function q(e){return{ssh:"#3fb950",auth:"#a371f7",sauron:"#f85149",docker:"#2496ed",system:"#8b949e",npm:"#f85149",mailu:"#d29922",authelia:"#a371f7",collector:"#58a6ff"}[e]||"#8b949e"}function V(e,n){return ge.includes(e)||n==="auth"||n==="sauron"?"security":pe.includes(e)||n==="system"?"health":"debug"}function S(e,n=3e3){let t=document.getElementById("toast"),s=t?.querySelector(".toast-message");t&&s&&(s.textContent=e,t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),n))}async function ve(e){try{await navigator.clipboard.writeText(e),S("Copied to clipboard!")}catch{let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),S("Copied to clipboard!")}}async function we(){try{let e=`${m}/api/alerts?since=${_}&limit=200`,n=await g(e);n&&(d=JSON.parse(n).alerts||[]);let t=`${m}/api/stats?since=${_}`,s=await g(t);s&&(a=JSON.parse(s));let o=`${m}/api/vms`,r=await g(o);r&&(y=JSON.parse(r).vms||[]);let i=`${m}/api/services`,c=await g(i);return c&&(v=JSON.parse(c).services||[]),!0}catch(e){return console.warn("API fetch failed, falling back to ntfy:",e),!1}}async function Se(){let e=["system","auth","sauron"],n=[];for(let t of e)try{let s=`${ue}/${t}/json?poll=1`,o=await g(s);if(o){let r=o.trim().split(`
`).filter(i=>i);for(let i of r)try{let c=JSON.parse(i);c.event==="message"&&n.push(c)}catch{}}}catch{console.warn(`Failed to fetch ntfy topic ${t}`)}return n.length===0?!1:(d=n.map((t,s)=>({id:s,timestamp:new Date(t.time*1e3).toISOString(),vm:be(t.message||t.title||""),service:Ee(t.topic),topic:t.topic,title:t.title||"Notification",message:t.message||"",priority:t.priority?.toString()||"default",tags:t.tags?.join(",")||"",log_cmd:"",log_path:"",acknowledged:0,ntfy_id:t.id})).sort((t,s)=>new Date(s.timestamp).getTime()-new Date(t.timestamp).getTime()),j(),!0)}function N(){w=!0,d=fe,j(),console.log("CloudFeed: Loaded demo data (API/ntfy unavailable)")}function j(){a={total:d.length,by_priority:{},by_service:{},by_vm:{}},d.forEach(e=>{a.by_priority[e.priority]=(a.by_priority[e.priority]||0)+1,a.by_service[e.service]=(a.by_service[e.service]||0)+1,a.by_vm[e.vm]=(a.by_vm[e.vm]||0)+1}),y=O.map(e=>({name:e.name,status:"unknown",last_seen:""})),v=P.map(e=>({name:e,vm:"",status:"unknown",last_seen:""}))}function be(e){let n=e.match(/\[([\w-]+)\]/);return n?n[1]:"unknown"}function Ee(e){return e==="auth"?"ssh":e==="sauron"?"sauron":"system"}function $e(){let e=document.querySelector("#counter-critical .counter-value"),n=document.querySelector("#counter-high .counter-value"),t=document.querySelector("#counter-default .counter-value"),s=document.querySelector("#counter-total .counter-value");if(a){let o=(a.by_priority.urgent||0)+(a.by_priority.critical||0)+(a.by_priority[5]||0),r=(a.by_priority.high||0)+(a.by_priority[4]||0),i=(a.by_priority.default||0)+(a.by_priority[3]||0);e&&(e.textContent=String(o)),n&&(n.textContent=String(r)),t&&(t.textContent=String(i)),s&&(s.textContent=String(a.total))}}function Ie(){let e=document.getElementById("vm-status");if(!e)return;let n=y.length>0?y:O.map(t=>({name:t.name,status:"unknown",last_seen:""}));e.innerHTML=n.map(t=>{let s=t.status==="online"?"online":t.status==="offline"?"offline":"unknown",o=a?.by_vm[t.name]||0;return`
      <div class="status-card ${s}">
        <div class="status-indicator"></div>
        <div class="status-info">
          <span class="status-name">${t.name}</span>
          <span class="status-detail">${o} alerts</span>
        </div>
      </div>
    `}).join("")}function ke(){let e=document.getElementById("service-status");if(!e)return;let n=v.length>0?v:P.map(t=>({name:t,vm:"",status:"unknown",last_seen:""}));e.innerHTML=n.map(t=>{let s=q(t.name),o=a?.by_service[t.name]||0;return`
      <div class="status-card service ${t.status==="active"?"online":t.status==="error"?"offline":"unknown"}" style="--service-color: ${s}">
        <div class="status-indicator" style="background: ${s}"></div>
        <div class="status-info">
          <span class="status-name">${t.name}</span>
          <span class="status-detail">${o} alerts</span>
        </div>
      </div>
    `}).join("")}function p(){let e=document.getElementById("alert-feed");if(!e)return;let n=d.filter(t=>{if(C!=="all"&&V(t.service,t.topic)!==C||L&&t.vm!==L||M&&t.service!==M)return!1;if(D){let s=D.toLowerCase();if(!`${t.title} ${t.message} ${t.vm} ${t.service}`.toLowerCase().includes(s))return!1}return!0});if(n.length===0){e.innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">&#128269;</div>
        <p>No alerts found</p>
        <span>Try adjusting your filters or time range</span>
      </div>
    `;return}e.innerHTML=n.map(t=>Ce(t)).join(""),e.querySelectorAll(".copy-btn").forEach(t=>{t.addEventListener("click",s=>{let r=s.currentTarget.dataset.copy||"";ve(r)})}),e.querySelectorAll(".ack-btn").forEach(t=>{t.addEventListener("click",async s=>{let o=s.currentTarget,r=o.dataset.alertId;if(r&&f)try{await fetch(`${m}/api/alerts/${r}/ack`,{method:"POST"}),o.closest(".alert-card")?.classList.add("acknowledged"),S("Alert acknowledged")}catch{S("Failed to acknowledge")}})})}function Ce(e){let n=ye(e.priority),t=q(e.service),s=V(e.service,e.topic),o=s==="security"?"&#128274;":s==="health"?"&#128153;":"&#128736;",r=e.acknowledged?"acknowledged":"";return`
    <div class="alert-card ${n} ${r}" data-category="${s}">
      <div class="alert-header">
        <div class="alert-meta">
          <span class="alert-category" title="${s}">${o}</span>
          <span class="alert-service" style="background: ${t}">${e.service}</span>
          <span class="alert-vm">${e.vm}</span>
          <span class="alert-topic">${e.topic}</span>
        </div>
        <div class="alert-time" title="${he(e.timestamp)}">
          ${U(e.timestamp)}
        </div>
      </div>

      <div class="alert-body">
        <div class="alert-title">${e.title}</div>
        ${e.message?`<div class="alert-message">${e.message}</div>`:""}
      </div>

      ${e.log_cmd?`
        <div class="alert-log-cmd">
          <code>${e.log_cmd}</code>
          <button class="copy-btn" data-copy="${H(e.log_cmd)}" title="Copy command">
            &#128203;
          </button>
        </div>
      `:""}

      <div class="alert-actions">
        ${e.tags?`<span class="alert-tags">${_e(e.tags)}</span>`:""}
        <div class="alert-buttons">
          ${!e.acknowledged&&f?`
            <button class="ack-btn" data-alert-id="${e.id}" title="Acknowledge">
              &#10003;
            </button>
          `:""}
          ${e.log_cmd?`
            <button class="copy-btn" data-copy="ssh ${De(e.vm)} '${H(e.log_cmd)}'" title="Copy SSH command">
              &#128187;
            </button>
          `:""}
        </div>
      </div>
    </div>
  `}function H(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function _e(e){return e?e.split(",").map(n=>`<span class="tag">${n.trim()}</span>`).join(""):""}function De(e){return{"gcp-arch":"diego@34.55.55.234","oci-flex":"ubuntu@84.235.234.87","oci-micro-1":"ubuntu@130.110.251.193","oci-micro-2":"ubuntu@129.151.228.66"}[e]||`user@${e}`}function Le(){let e=document.getElementById("vm-filter"),n=document.getElementById("service-filter");if(e){let t=[...new Set(d.map(s=>s.vm))].filter(Boolean);e.innerHTML='<option value="">All VMs</option>'+t.map(s=>`<option value="${s}">${s}</option>`).join("")}if(n){let t=[...new Set(d.map(s=>s.service))].filter(Boolean);n.innerHTML='<option value="">All Services</option>'+t.map(s=>`<option value="${s}">${s}</option>`).join("")}}function Me(){let e=document.getElementById("last-update");if(e){let t=w?" [DEMO]":f?"":" [ntfy]";e.textContent=`Updated ${U(new Date().toISOString())}${t}`}let n=document.getElementById("live-indicator");n&&w&&(n.innerHTML='<span class="pulse"></span> DEMO',n.classList.add("demo"))}function B(e){let n=document.getElementById("live-indicator"),t=document.getElementById("refresh-icon");n&&n.classList.toggle("loading",e),t&&t.classList.toggle("spinning",e)}async function b(){B(!0),window.location.protocol==="file:"?N():await we()?(f=!0,w=!1):(f=!1,await Se()||N()),$e(),Ie(),ke(),p(),Le(),Me(),B(!1)}function Te(){document.getElementById("refresh-btn")?.addEventListener("click",b);let n=document.getElementById("time-filter");n?.addEventListener("change",()=>{_=n.value,b()}),document.querySelectorAll(".tab-btn").forEach(i=>{i.addEventListener("click",()=>{document.querySelectorAll(".tab-btn").forEach(c=>c.classList.remove("active")),i.classList.add("active"),C=i.dataset.category||"all",p()})});let t=document.getElementById("search-input"),s;t?.addEventListener("input",()=>{clearTimeout(s),s=setTimeout(()=>{D=t.value,p()},300)});let o=document.getElementById("vm-filter");o?.addEventListener("change",()=>{L=o.value,p()});let r=document.getElementById("service-filter");r?.addEventListener("change",()=>{M=r.value,p()})}function W(){b(),Te(),k=setInterval(b,3e4),window.addEventListener("beforeunload",()=>{k&&clearInterval(k)})}function xe(){let e=window.location.pathname;return e.includes("appsfeed.html")?"appsfeed":e.includes("newsfeed.html")?"newsfeed":e.includes("cloudfeed.html")?"cloudfeed":"index"}document.addEventListener("DOMContentLoaded",()=>{switch(xe()){case"appsfeed":F();break;case"newsfeed":I();break;case"cloudfeed":W(),Ae();break;default:break}});function Ae(){let e=document.querySelectorAll(".mode-btn"),n=document.getElementById("api-mode"),t=document.getElementById("rss-mode");e.forEach(s=>{s.addEventListener("click",()=>{let o=s.dataset.mode;e.forEach(r=>r.classList.remove("active")),s.classList.add("active"),o==="api"?(n?.style.setProperty("display","block"),t?.style.setProperty("display","none")):(n?.style.setProperty("display","none"),t?.style.setProperty("display","block"))})})}})();
