name: GitHub Pages Deployment (Static Files)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout Code
        uses: actions/checkout@v4

      - name: 💎 Setup Ruby and Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: 📦 Install Jekyll
        run: |
          gem install jekyll bundler

      - name: 🔨 Build Blog HTML (Jekyll)
        run: |
          cd blog
          chmod +x build.sh
          ./build.sh build
          echo "✅ Blog HTML files generated and copied to blog/ directory"

      - name: 🌐 Setup Pages Environment
        uses: actions/configure-pages@v5

      - name: 📂 Prepare Site for Deployment
        run: |
          echo "📋 Creating _site directory and copying all files..."
          mkdir -p _site

          # Copy root files
          echo "Copying root HTML, CSS, and JS files..."
          cp -v index.html _site/ 2>/dev/null || true
          cp -v *.css _site/ 2>/dev/null || true
          cp -v *.js _site/ 2>/dev/null || true

          # Copy static directories
          echo "Copying static directories..."
          cp -r linktree _site/ 2>/dev/null || true
          cp -r cv_web _site/ 2>/dev/null || true
          cp -r cv_pdf _site/ 2>/dev/null || true
          cp -r assets _site/ 2>/dev/null || true
          cp -r others _site/ 2>/dev/null || true

          # Copy blog directory (includes both .md and .html files)
          echo "Copying blog directory..."
          mkdir -p _site/blog
          cp -r blog/* _site/blog/

          # Clean up source files from deployment (keep only HTML)
          echo "Cleaning up source files..."
          find _site/blog -name "*.md" -type f -delete
          rm -f _site/blog/_config.yml
          rm -f _site/blog/build.sh
          rm -rf _site/blog/_layouts
          rm -rf _site/blog/.jekyll-cache

          echo "✅ All files prepared for deployment"
          echo "📋 Final site structure:"
          ls -lah _site/
          echo "📋 Blog directory (HTML only):"
          ls -lah _site/blog/ || true

      - name: ⬆️ Upload Site Artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
