"use strict";(()=>{var F=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],b=[{id:"github",name:"GitHub",color:"#238636",url:"https://github.com/diegonmarcos.atom",enabled:!0},{id:"youtube",name:"YouTube",color:"#ff0000",url:"",enabled:!1},{id:"lastfm",name:"Last.fm",color:"#d51007",url:"",enabled:!1},{id:"reddit",name:"Reddit",color:"#ff4500",url:"",enabled:!1},{id:"letterboxd",name:"Letterboxd",color:"#00d735",url:"",enabled:!1},{id:"mastodon",name:"Mastodon",color:"#6364ff",url:"",enabled:!1},{id:"goodreads",name:"Goodreads",color:"#553b08",url:"",enabled:!1},{id:"devto",name:"DEV.to",color:"#0a0a0a",url:"",enabled:!1}];async function A(e){try{let t=await fetch(e,{mode:"cors"});if(t.ok)return await t.text()}catch{}for(let t of F)try{let n=await fetch(t+encodeURIComponent(e));if(n.ok)return await n.text()}catch{console.warn(`Proxy ${t} failed`)}return null}function T(e){let n=new DOMParser().parseFromString(e,"text/xml"),s=[];return n.querySelectorAll("item").forEach((o,r)=>{if(r>=15)return;let i=o.querySelector("title")?.textContent||"",a=o.querySelector("link")?.textContent||"",l=o.querySelector("pubDate")?.textContent,c=o.querySelector("description")?.textContent||"";s.push({id:`rss-${r}`,title:i.replace(/<!\[CDATA\[|\]\]>/g,"").trim(),link:a,date:l?new Date(l):new Date,description:c.replace(/<[^>]*>/g,"").slice(0,100)})}),s.length===0&&n.querySelectorAll("entry").forEach((o,r)=>{if(r>=15)return;let i=o.querySelector("title")?.textContent||"",l=o.querySelector("link[href]")?.getAttribute("href")||"",c=o.querySelector("updated")?.textContent||o.querySelector("published")?.textContent;s.push({id:`atom-${r}`,title:i.trim(),link:l,date:c?new Date(c):new Date})}),s}var m="apps-feed-cache",B=5*60*1e3;function P(e){try{let t=localStorage.getItem(m);if(t){let n=JSON.parse(t);if(n[e]&&Date.now()-n[e].timestamp<B)return n[e].items.map(s=>({...s,date:new Date(s.date)}))}}catch{}return null}function R(e,t){try{let n=localStorage.getItem(m),s=n?JSON.parse(n):{};s[e]={items:t,timestamp:Date.now()},localStorage.setItem(m,JSON.stringify(s))}catch{}}function U(){localStorage.removeItem(m)}function f(e){let n=new Date().getTime()-e.getTime(),s=Math.floor(n/6e4),o=Math.floor(n/36e5),r=Math.floor(n/864e5);return s<1?"now":s<60?`${s}m`:o<24?`${o}h`:r<7?`${r}d`:e.toLocaleDateString()}function L(e){return`
    <div class="message-item">
      <div class="message-header">
        <span class="message-time">${f(e.date)}</span>
      </div>
      <a href="${e.link}" target="_blank" class="message-title">${e.title}</a>
      ${e.description?`<div class="message-body">${e.description}</div>`:""}
    </div>
  `}function H(){return'<div class="loading-state"><div class="skeleton-row"></div><div class="skeleton-row"></div></div>'}function C(e="No items"){return`<div class="empty-state">${e}</div>`}async function q(e){if(!e.enabled||!e.url)return[];let t=P(e.id);if(t)return t;try{let n=await A(e.url);if(!n)return[];let s=T(n);return R(e.id,s),s}catch(n){return console.warn(`Failed to fetch ${e.name}:`,n),[]}}async function E(e){let t=document.getElementById(`${e.id}-feed`),n=document.getElementById(`${e.id}-count`);if(!t)return;if(!e.enabled||!e.url){t.innerHTML=C("Configure in apps-feed.ts"),n&&(n.textContent="0");return}t.innerHTML=H();let s=await q(e);s.length===0?t.innerHTML=C("No items"):t.innerHTML=s.map(L).join(""),n&&(n.textContent=String(s.length))}async function $(){await Promise.all(b.map(E));let e=document.getElementById("apps-last-update");e&&(e.textContent=`Updated ${f(new Date)}`);let t=document.getElementById("appsfeed-refresh");t&&t.addEventListener("click",async()=>{U(),await Promise.all(b.map(E)),e&&(e.textContent=`Updated ${f(new Date)}`)})}var V=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],O={world:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx1YlY4U0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},tech:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGRqTVhZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},science:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRFp0Y1RjU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},markets:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx6TVdZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},hn:{url:"https://hnrss.org/newest?points=50",source:"Hacker News"}},g=new Map,j=5*60*1e3;async function _(e){for(let t of V)try{let n=await fetch(t+encodeURIComponent(e));if(n.ok)return await n.text()}catch{console.warn(`Proxy ${t} failed for ${e}`)}return null}function W(e,t,n){let s=e.querySelector("title")?.textContent||"No title",o=e.querySelector("link")?.textContent||"",r=e.querySelector("pubDate")?.textContent||new Date().toISOString(),i=s.replace(/ - [^-]+$/,"");return{id:`news-${n}`,title:i,source:t,url:o,publishedAt:new Date(r)}}async function G(e){let t=O[e];if(!t)return[];let n=g.get(e);if(n&&Date.now()-n.timestamp<j)return n.data;try{let s=await _(t.url);if(!s)return n?.data||[];let i=new DOMParser().parseFromString(s,"text/xml").querySelectorAll("item"),a=[];return i.forEach((l,c)=>{c<15&&a.push(W(l,t.source,c))}),g.set(e,{data:a,timestamp:Date.now()}),a}catch(s){return console.error(`Error fetching RSS for ${e}:`,s),n?.data||[]}}function I(e){let n=new Date().getTime()-e.getTime(),s=Math.floor(n/6e4),o=Math.floor(n/36e5),r=Math.floor(n/864e5);return s<1?"now":s<60?`${s}m`:o<24?`${o}h`:r<7?`${r}d`:e.toLocaleDateString()}function Z(e){return`
    <div class="message-item">
      <div class="message-header">
        <span class="message-topic">${e.source}</span>
        <span class="message-time">${I(e.publishedAt)}</span>
      </div>
      <a href="${e.url}" target="_blank" class="message-title">${e.title}</a>
    </div>
  `}function J(){return'<div class="loading-state"><div class="skeleton-row"></div><div class="skeleton-row"></div></div>'}function Q(){return'<div class="empty-state">No news available</div>'}async function p(){let e=["world","tech","science","markets","hn"];e.forEach(o=>{let r=document.getElementById(`${o}-feed`);r&&(r.innerHTML=J())}),(await Promise.all(e.map(async o=>{let r=await G(o);return{category:o,items:r}}))).forEach(({category:o,items:r})=>{let i=document.getElementById(`${o}-feed`),a=document.getElementById(`${o}-count`);i&&(r.length===0?i.innerHTML=Q():i.innerHTML=r.map(Z).join(""),a&&(a.textContent=String(r.length)))});let n=document.getElementById("news-last-update");n&&(n.textContent=`Updated ${I(new Date)}`);let s=document.getElementById("newsfeed-refresh");s&&s.addEventListener("click",async()=>{g.clear(),await p()})}var d="https://rss.diegonmarcos.com",X=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],v=[{id:"github",name:"GitHub",color:"#238636",description:"Repository activity, commits, PRs"}],S=[{id:"system",name:"System",color:"#d29922",description:"Health What/How"},{id:"auth",name:"Auth",color:"#a371f7",description:"Security Who"},{id:"sauron",name:"Sauron",color:"#f85149",description:"Security scans"},{id:"public",name:"Public",color:"#58a6ff",description:"General"}],D=[...v,...S],u=new Map,w=null,h=null;async function Y(e){try{let t=await fetch(e,{mode:"cors"});if(t.ok)return await t.text()}catch{}for(let t of X)try{let n=await fetch(t+encodeURIComponent(e));if(n.ok)return await n.text()}catch{console.warn(`Proxy ${t} failed`)}return null}async function K(e){let t=`${d}/${e.id}/json?poll=1`;try{let n=await Y(t);if(!n)return[];let s=n.trim().split(`
`).filter(r=>r),o=[];for(let r of s)try{let i=JSON.parse(r);i.event==="message"&&o.push(i)}catch{}return o.sort((r,i)=>i.time-r.time).slice(0,50)}catch(n){return console.warn(`Failed to fetch ${e.id}:`,n),[]}}async function y(){k(!0),ie();let e=await Promise.allSettled(D.map(async n=>{let s=await K(n);return{id:n.id,msgs:s}}));u.clear();let t=0;for(let n of e)n.status==="fulfilled"&&(u.set(n.value.id,n.value.msgs),t+=n.value.msgs.length);w=new Date,k(!1),t===0&&re("No messages fetched. Check network or CORS."),te(),se(),oe()}function M(e){let t=new Date(e*1e3),s=new Date().getTime()-t.getTime(),o=Math.floor(s/6e4),r=Math.floor(s/36e5),i=Math.floor(s/864e5);return o<1?"now":o<60?`${o}m`:r<24?`${r}h`:i<7?`${i}d`:t.toLocaleDateString()}function z(e){return!e||e<=2?"priority-low":e===3?"priority-default":e===4?"priority-high":"priority-urgent"}function ee(e){return`
    <div class="message-item ${z(e.priority)}">
      <div class="message-header">
        <span class="message-topic">${e.topic}</span>
        <span class="message-time">${M(e.time)}</span>
      </div>
      <div class="message-title">${e.title||"Notification"}</div>
      ${e.message?`<div class="message-body">${e.message}</div>`:""}
    </div>
  `}function x(e){let t=u.get(e.id)||[],n=t.length,s;return n===0?s='<div class="empty-state">No messages</div>':s=t.map(ee).join(""),`
    <div class="channel-card">
      <div class="channel-header" style="border-color: ${e.color}">
        <div class="channel-info">
          <h3>${e.name}</h3>
          <span class="channel-desc">${e.description}</span>
        </div>
        <span class="channel-count" style="background: ${e.color}">${n}</span>
      </div>
      <div class="messages-container">${s}</div>
      <div class="channel-footer">
        <a href="${d}/${e.id}/json?poll=1" target="_blank">JSON</a>
        <a href="${d}/${e.id}" target="_blank">ntfy</a>
      </div>
    </div>
  `}function te(){let e=document.getElementById("apps-channels"),t=document.getElementById("jornald-channels");e&&(e.innerHTML=v.map(x).join("")),t&&(t.innerHTML=S.map(x).join("")),ne()}function ne(){let e=document.getElementById("channels-table-body");e&&(e.innerHTML=D.map(t=>`
    <tr>
      <td><span class="channel-badge" style="background: ${t.color}">${t.name}</span></td>
      <td class="desc-cell">${t.description}</td>
      <td><a href="${d}/${t.id}/json?poll=1" target="_blank">json</a></td>
      <td><a href="${d}/${t.id}/sse" target="_blank">sse</a></td>
      <td><a href="${d}/${t.id}/ws" target="_blank">ws</a></td>
    </tr>
  `).join(""))}function se(){let e=document.getElementById("last-update");e&&w&&(e.textContent=M(w.getTime()/1e3))}function oe(){let e=0,t=0;v.forEach(o=>{e+=u.get(o.id)?.length||0}),S.forEach(o=>{t+=u.get(o.id)?.length||0});let n=document.getElementById("apps-count"),s=document.getElementById("jornald-count");n&&(n.textContent=String(e)),s&&(s.textContent=String(t))}function k(e){let t=document.getElementById("refresh-icon");t&&(e?t.classList.add("spinning"):t.classList.remove("spinning"))}function re(e){let t=document.getElementById("error-banner");t&&(t.textContent=e,t.style.display="block")}function ie(){let e=document.getElementById("error-banner");e&&(e.style.display="none")}function N(){y(),h=setInterval(y,6e4);let e=document.getElementById("cloudfeed-refresh");e&&e.addEventListener("click",y),window.addEventListener("beforeunload",()=>{h&&clearInterval(h)})}function ae(){let e=window.location.pathname;return e.includes("appsfeed.html")?"appsfeed":e.includes("newsfeed.html")?"newsfeed":e.includes("cloudfeed.html")?"cloudfeed":"index"}document.addEventListener("DOMContentLoaded",()=>{switch(ae()){case"appsfeed":$();break;case"newsfeed":p();break;case"cloudfeed":N(),ce();break;default:break}});function ce(){let e=document.querySelectorAll(".mode-btn"),t=document.getElementById("api-mode"),n=document.getElementById("rss-mode");e.forEach(s=>{s.addEventListener("click",()=>{let o=s.dataset.mode;e.forEach(r=>r.classList.remove("active")),s.classList.add("active"),o==="api"?(t?.style.setProperty("display","block"),n?.style.setProperty("display","none")):(t?.style.setProperty("display","none"),n?.style.setProperty("display","block"))})})}})();
