<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultural Regions - Terrain Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
@keyframes spin{to{transform:rotate(360deg)}}@keyframes fadeSlideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;width:100%;overflow:hidden}body{font-family:"Inter","Segoe UI",-apple-system,BlinkMacSystemFont,sans-serif;background-color:#1a1a1a;color:#f1f5f9;line-height:1.5;-webkit-font-smoothing:antialiased}#loader{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;flex-direction:column;background:#1a1a1a;z-index:9999;transition:opacity .5s}#loader h2{font-size:1.25rem;font-weight:600;margin-bottom:.5rem}#loader p{color:#64748b;font-size:.875rem}.loader-spinner{width:48px;height:48px;border:3px solid hsla(0,0%,100%,.12);border-top-color:#3b82f6;border-radius:50%;animation:spin .8s linear infinite;margin-bottom:24px}.map-wrapper{position:absolute;inset:0;background:#1a2634;z-index:1;cursor:pointer}#world-map{width:100%;height:100%;display:block}.graticule{fill:none;stroke:rgba(255,255,255,0.08);stroke-width:.3px}.country{stroke:rgba(0,0,0,0.6);stroke-width:.3px;cursor:pointer;transition:opacity .3s ease,filter .2s ease}.country:hover{filter:brightness(1.2) saturate(1.1)}.sidebar{position:fixed;top:0;left:0;bottom:0;width:380px;background:rgba(15,15,20,.97);backdrop-filter:blur(16px);border-right:1px solid hsla(0,0%,100%,.06);transform:translateX(0);transition:transform .35s cubic-bezier(0.4,0,0.2,1);z-index:100;display:flex;flex-direction:column;box-shadow:4px 0 32px rgba(0,0,0,.5)}.sidebar.collapsed{transform:translateX(-100%)}.sidebar-header{padding:20px 24px;border-bottom:1px solid hsla(0,0%,100%,.06);display:flex;justify-content:space-between;align-items:center}.sidebar-header h1{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;display:flex;align-items:center;gap:10px;color:#f1f5f9}.sidebar-header h1::before{content:"üó∫Ô∏è";font-size:1.1rem}.close-btn{background:none;border:none;cursor:pointer;width:32px;height:32px;color:#64748b;font-size:1.1rem;border-radius:6px;transition:all .2s}.close-btn:hover{color:#f1f5f9;background:hsla(0,0%,100%,.08)}.search-container{padding:14px 24px;border-bottom:1px solid hsla(0,0%,100%,.06)}.search-wrapper{position:relative}.search-wrapper::before{content:"üîç";position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:.75rem;opacity:.4;pointer-events:none}.search-input{width:100%;padding:10px 14px 10px 38px;background:rgba(0,0,0,.3);border:1px solid hsla(0,0%,100%,.06);border-radius:8px;color:#f1f5f9;font-size:.8rem;font-family:inherit;outline:none;transition:all .2s}.search-input::placeholder{color:#64748b}.search-input:focus{border-color:hsla(220,70%,60%,.5);background:rgba(0,0,0,.4)}.stats-bar{display:flex;padding:14px 24px;gap:10px;border-bottom:1px solid hsla(0,0%,100%,.06);background:rgba(0,0,0,.2)}.stat{flex:1;text-align:center}.stat-value{font-size:1.3rem;font-weight:700;color:#f1f5f9;line-height:1}.stat-label{font-size:.55rem;color:#64748b;text-transform:uppercase;letter-spacing:.08em;margin-top:4px;font-weight:500}.sidebar-content{flex:1;overflow-y:auto;padding-bottom:48px;scrollbar-width:thin;scrollbar-color:#334155 transparent}.sidebar-content::-webkit-scrollbar{width:4px}.sidebar-content::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}.region-block{animation:fadeSlideIn .4s ease-out backwards}.region-block:nth-child(1){animation-delay:.05s}.region-block:nth-child(2){animation-delay:.1s}.region-block:nth-child(3){animation-delay:.15s}.region-block:nth-child(4){animation-delay:.2s}.region-block:nth-child(5){animation-delay:.25s}.region-title{padding:20px 24px 10px;font-size:.6rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.12em;display:flex;align-items:center;gap:10px}.region-title::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,hsla(0,0%,100%,.1) 0%,transparent 100%)}.group-block{border-left:3px solid transparent;transition:all .2s;margin:1px 0}.group-block.pinned{background:hsla(0,0%,100%,.04)}.group-block.pinned .pin-indicator{opacity:1}.group-block.pinned .subgroup-list{display:block}.group-header{padding:12px 24px;cursor:pointer;display:flex;align-items:center;font-size:.85rem;color:#cbd5e1;transition:all .2s}.group-header:hover{color:#f1f5f9;background:hsla(0,0%,100%,.03)}.color-dot{width:14px;height:14px;border-radius:3px;margin-right:12px;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.4),inset 0 1px 0 hsla(0,0%,100%,.2)}.group-name{flex:1;font-weight:500}.group-count{font-size:.65rem;color:#64748b;background:rgba(0,0,0,.3);padding:3px 8px;border-radius:10px;margin-right:10px;font-weight:600}.pin-indicator{font-size:.5rem;opacity:0;color:#f1f5f9;background:hsla(220,70%,50%,.25);border:1px solid hsla(220,70%,50%,.4);border-radius:3px;padding:2px 6px;text-transform:uppercase;letter-spacing:.05em;font-weight:600;transition:opacity .2s}.subgroup-list{display:none;background:rgba(0,0,0,.25);padding:6px 0;border-top:1px solid hsla(0,0%,100%,.03)}.subgroup-item{padding:8px 24px 8px 50px;font-size:.75rem;color:#64748b;display:flex;justify-content:space-between;align-items:center;transition:all .2s}.subgroup-item:hover{background:hsla(0,0%,100%,.02);color:#cbd5e1}.subgroup-name{font-weight:500}.subgroup-flags{opacity:.8;font-size:.85rem;letter-spacing:1px}.controls{position:fixed;top:16px;left:16px;z-index:50;display:flex;gap:8px}.menu-btn{background:rgba(15,15,20,.9);backdrop-filter:blur(12px);border:1px solid hsla(0,0%,100%,.06);width:44px;height:44px;border-radius:12px;color:#f1f5f9;font-size:1.2rem;cursor:pointer;transition:all .2s}.menu-btn:hover{background:rgba(30,30,40,.95);border-color:hsla(0,0%,100%,.12);transform:scale(1.04)}.zoom-controls{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:6px;z-index:50}.zoom-btn{background:rgba(15,15,20,.9);backdrop-filter:blur(12px);border:1px solid hsla(0,0%,100%,.06);width:38px;height:38px;border-radius:10px;color:#f1f5f9;font-size:1.2rem;cursor:pointer;transition:all .2s}.zoom-btn:hover{background:rgba(30,30,40,.95);border-color:hsla(0,0%,100%,.12)}.tooltip{position:fixed;background:rgba(15,15,20,.96);backdrop-filter:blur(16px);border:1px solid hsla(0,0%,100%,.1);padding:12px 16px;border-radius:10px;font-size:.8rem;pointer-events:none;display:none;z-index:1000;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:160px;max-width:240px}.tooltip-title{font-weight:700;font-size:.95rem;border-bottom:1px solid hsla(0,0%,100%,.08);padding-bottom:6px;margin-bottom:8px}.tooltip-region{font-size:.6rem;color:#64748b;text-transform:uppercase;letter-spacing:.08em;font-weight:500}.tooltip-group{font-weight:600;font-size:.85rem;margin:4px 0 2px}.tooltip-subgroup{font-size:.75rem;color:#cbd5e1}.tooltip-unassigned{color:#64748b;font-style:italic}.legend{position:fixed;bottom:20px;left:20px;background:rgba(15,15,20,.9);backdrop-filter:blur(12px);border:1px solid hsla(0,0%,100%,.06);border-radius:12px;padding:14px;z-index:50;max-width:300px}.legend-title{font-size:.55rem;color:#64748b;text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px;font-weight:600}.legend-items{display:flex;flex-wrap:wrap;gap:6px}.legend-item{display:flex;align-items:center;gap:6px;padding:5px 10px;background:rgba(0,0,0,.3);border-radius:6px;cursor:pointer;transition:all .2s;font-size:.7rem;color:#64748b;font-weight:500}.legend-item:hover{background:hsla(0,0%,100%,.06);color:#f1f5f9}.legend-item.active{outline:2px solid;outline-offset:2px;color:#f1f5f9;background:hsla(0,0%,100%,.08)}.legend-dot{width:10px;height:10px;border-radius:3px;box-shadow:0 1px 4px rgba(0,0,0,.4)}@media(max-width:768px){.sidebar{width:100%}.legend{display:none}.controls{top:10px;left:10px}.zoom-controls{bottom:12px;right:12px}.menu-btn{width:40px;height:40px}.zoom-btn{width:36px;height:36px}}
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-spinner"></div>
    <h2>Loading Terrain Map</h2>
    <p>Generating topography...</p>
</div>

<div class="controls">
    <a href="./index.html" class="menu-btn" title="Back to MyTrips" style="display: flex; align-items: center; justify-content: center; text-decoration: none;">‚Üê</a>
    <button class="menu-btn" id="menu-btn" title="Toggle Menu (M)">‚ò∞</button>
</div>

<aside class="sidebar" id="sidebar">
    <header class="sidebar-header">
        <h1>Cultural Regions</h1>
        <button class="close-btn" id="close-btn" title="Close">√ó</button>
    </header>
    <div class="search-container">
        <div class="search-wrapper">
            <input type="text" class="search-input" id="search-input" placeholder="Search countries or regions...">
        </div>
    </div>
    <div class="stats-bar">
        <div class="stat"><div class="stat-value" id="stat-countries">0</div><div class="stat-label">Countries</div></div>
        <div class="stat"><div class="stat-value" id="stat-regions">0</div><div class="stat-label">Continents</div></div>
        <div class="stat"><div class="stat-value" id="stat-groups">0</div><div class="stat-label">Groups</div></div>
    </div>
    <div class="sidebar-content" id="sidebar-content"></div>
</aside>

<main class="map-wrapper" id="map-wrapper">
    <div id="tooltip" class="tooltip"></div>
    <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
        <button class="zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
        <button class="zoom-btn" id="reset-zoom" title="Reset (Esc)">‚ü≤</button>
    </div>
    <div class="legend" id="legend">
        <div class="legend-title">Continents</div>
        <div class="legend-items" id="legend-items"></div>
    </div>
    <svg id="world-map">
        <defs>
            <!-- Terrain texture filters for 3D topography effect -->
            <filter id="terrain-texture" x="-5%" y="-5%" width="110%" height="110%">
                <feTurbulence type="fractalNoise" baseFrequency="0.012" numOctaves="8" seed="3" result="noise"/>
                <feDiffuseLighting in="noise" lighting-color="white" surfaceScale="12" result="light">
                    <feDistantLight azimuth="315" elevation="45"/>
                </feDiffuseLighting>
                <feBlend in="SourceGraphic" in2="light" mode="overlay" result="textured"/>
                <feComposite in="textured" in2="SourceGraphic" operator="in"/>
            </filter>

            <!-- Mountain ridge enhancement -->
            <filter id="terrain-mountains" x="-5%" y="-5%" width="110%" height="110%">
                <feTurbulence type="fractalNoise" baseFrequency="0.008" numOctaves="6" seed="7" result="mountains"/>
                <feColorMatrix type="matrix" in="mountains" result="mono"
                    values="0.5 0.5 0.5 0 0
                            0.5 0.5 0.5 0 0
                            0.5 0.5 0.5 0 0
                            0 0 0 1 0"/>
                <feDiffuseLighting in="mono" lighting-color="white" surfaceScale="15" result="ridges">
                    <feDistantLight azimuth="300" elevation="50"/>
                </feDiffuseLighting>
                <feBlend in="SourceGraphic" in2="ridges" mode="soft-light" result="terrain"/>
                <feComposite in="terrain" in2="SourceGraphic" operator="in"/>
            </filter>
        </defs>
    </svg>
</main>

<script>
(function() {
    const libs = [
        ['https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js'],
        ['https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js']
    ];
    let i = 0;
    function load() {
        if (i >= libs.length) { if (typeof startApp === 'function') startApp(); return; }
        const s = document.createElement('script');
        s.src = libs[i][0];
        s.onload = () => { i++; load(); };
        s.onerror = () => { document.getElementById('loader').innerHTML = '<h2 style="color:#ef4444">Failed to load</h2>'; };
        document.head.appendChild(s);
    }
    load();
})();
</script>

<script>
// ============================================================================
// 19 UNIQUE COLORS - HIGH CONTRAST WITHIN EACH CONTINENT
// ============================================================================

const COLORS = {
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üî∑ EUROPE - IRON/BLUE/METALLIC (4 very different)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    "GERMANICS":    "#1e3a8a",  // Deep Navy Blue
    "GRECO-ROMANS": "#60a5fa",  // Bright Sky Blue
    "SLAVS":        "#a1a1aa",  // Silver Gray
    "EU_OTHERS":    "#06b6d4",  // Cyan Teal

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üåé AMERICAS - Wine/Green/Yellow (3 very different)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    "AM_GERMANICS": "#881337",  // Wine Red (Anglo)
    "SPANISH":      "#eab308",  // Golden Yellow
    "ROMANCE":      "#15803d",  // Forest Green (Brazil)

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üî• OCEANIA - Fire/Orange (3 very different)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    "AUSTRALASIA":    "#991b1b",  // Deep Crimson
    "POLYNESIA":      "#ea580c",  // Bright Orange
    "MICROMELANESIA": "#fbbf24",  // Golden Yellow

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üü£ ASIA - Purple/Pink/Red (4 very different)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    "ABRAHAMIC":   "#581c87",  // Deep Purple
    "HINDUS":      "#ec4899",  // Hot Pink
    "BUDDHIST":    "#dc2626",  // Crimson Red

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ü™® AFRICA - Earth/Brown/Orange (4 very different)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    "MAGHREB":      "#451a03",  // Dark Coffee
    "AF_ANGLOPHONE":"#92400e",  // Leather Brown
    "FRANCOPHONE":  "#ea580c",  // Bright Orange
    "LUSO_OTHERS":  "#fcd34d"   // Sand/Gold
};

// Verify uniqueness
(function() {
    const seen = new Map();
    for (const [k,v] of Object.entries(COLORS)) {
        if (seen.has(v)) console.error('DUPE:', k, v);
        seen.set(v, k);
    }
    console.log('‚úÖ Colors:', seen.size, 'unique');
})();

const REGION_COLORS = {
    "EUROPE":   "#60a5fa",
    "AMERICAS": "#881337",
    "OCEANIA":  "#ea580c",
    "ASIA":     "#581c87",
    "AFRICA":   "#92400e"
};

const REGION_ELEMENTS = {
    "EUROPE":   "üî∑",
    "AMERICAS": "üåé",
    "OCEANIA":  "üî•",
    "ASIA":     "üü£",
    "AFRICA":   "ü™®"
};

function getGroupColor(groupName) {
    const n = groupName.toUpperCase();

    // Europe
    if (n.includes("GERMANIC") && !n.includes("AMERICA")) return COLORS["GERMANICS"];
    if (n.includes("GRECO") || n.includes("ROMAN")) return COLORS["GRECO-ROMANS"];
    if (n.includes("SLAV")) return COLORS["SLAVS"];
    if (n.includes("OTHER") && !n.includes("LUSO")) return COLORS["EU_OTHERS"];

    // Americas
    if (n.includes("GERMANIC") && n.includes("ü¶Ö")) return COLORS["AM_GERMANICS"];
    if (n.includes("ANGLO-AMERICA") || n.includes("ü¶Ö")) return COLORS["AM_GERMANICS"];
    if (n.includes("SPANISH") || n.includes("ü™≠")) return COLORS["SPANISH"];
    if (n.includes("ROMANCE") || n.includes("ü¶ú") || n.includes("LUSO-AFRICAN")) return COLORS["ROMANCE"];

    // Oceania
    if (n.includes("AUSTRALASIA") || n.includes("ü¶ò")) return COLORS["AUSTRALASIA"];
    if (n.includes("POLYNESIA") || n.includes("ü™∂")) return COLORS["POLYNESIA"];
    if (n.includes("MICRO") || n.includes("MELANESIA") || n.includes("üóø")) return COLORS["MICROMELANESIA"];

    // Asia
    if (n.includes("ABRAHAMIC") || n.includes("üïØÔ∏è")) return COLORS["ABRAHAMIC"];
    if (n.includes("HINDU") || n.includes("üßò ")) return COLORS["HINDUS"];
    if (n.includes("BUDDHIST") || n.includes("TAO") || n.includes("üßòüèª")) return COLORS["BUDDHIST"];

    // Africa
    if (n.includes("MAGHREB") || n.includes("NORTH") || n.includes("ü´ñ")) return COLORS["MAGHREB"];
    if (n.includes("ANGLOPHONE") || n.includes("üíé")) return COLORS["AF_ANGLOPHONE"];
    if (n.includes("FRANCOPHONE") || n.includes("ü™ò")) return COLORS["FRANCOPHONE"];
    if (n.includes("LUSO") || n.includes("ü•Å")) return COLORS["LUSO_OTHERS"];

    return "#64748b";
}

const NAME_TO_ISO = {
    "Germany": "DE", "Switzerland": "CH", "Netherlands": "NL", "Austria": "AT",
    "Liechtenstein": "LI", "Luxembourg": "LU", "United Kingdom": "GB", "Ireland": "IE",
    "Sweden": "SE", "Norway": "NO", "Denmark": "DK", "Iceland": "IS",
    "France": "FR", "Belgium": "BE", "Monaco": "MC", "Spain": "ES",
    "Portugal": "PT", "Andorra": "AD", "Italy": "IT", "Vatican": "VA",
    "Malta": "MT", "San Marino": "SM", "Greece": "GR", "Cyprus": "CY",
    "Romania": "RO", "Moldova": "MD", "Bulgaria": "BG", "Macedonia": "MK",
    "North Macedonia": "MK", "Serbia": "RS", "Bosnia and Herz.": "BA",
    "Montenegro": "ME", "Croatia": "HR", "Slovenia": "SI", "Poland": "PL",
    "Czechia": "CZ", "Czech Rep.": "CZ", "Slovakia": "SK", "Ukraine": "UA",
    "Belarus": "BY", "Russia": "RU", "Estonia": "EE", "Hungary": "HU",
    "Finland": "FI", "Lithuania": "LT", "Latvia": "LV", "Albania": "AL",
    "Kosovo": "XK", "Georgia": "GE", "Armenia": "AM", "Azerbaijan": "AZ",
    "United States": "US", "United States of America": "US", "Canada": "CA",
    "Haiti": "HT", "Mexico": "MX", "Guatemala": "GT", "Honduras": "HN",
    "El Salvador": "SV", "Nicaragua": "NI", "Costa Rica": "CR", "Panama": "PA",
    "Argentina": "AR", "Chile": "CL", "Peru": "PE", "Bolivia": "BO",
    "Ecuador": "EC", "Colombia": "CO", "Venezuela": "VE", "Paraguay": "PY",
    "Cuba": "CU", "Dominican Rep.": "DO", "Uruguay": "UY", "Brazil": "BR",
    "Australia": "AU", "New Zealand": "NZ", "Samoa": "WS", "Tonga": "TO",
    "Tuvalu": "TV", "Palau": "PW", "Micronesia": "FM", "Marshall Is.": "MH",
    "Nauru": "NR", "Kiribati": "KI", "Fiji": "FJ", "Papua New Guinea": "PG",
    "Solomon Is.": "SB", "Vanuatu": "VU",
    "Jordan": "JO", "Qatar": "QA", "Saudi Arabia": "SA", "United Arab Emirates": "AE",
    "Kuwait": "KW", "Bahrain": "BH", "Oman": "OM", "Yemen": "YE", "Iraq": "IQ",
    "Syria": "SY", "Lebanon": "LB", "Palestine": "PS", "Turkey": "TR",
    "Kazakhstan": "KZ", "Uzbekistan": "UZ", "Turkmenistan": "TM", "Kyrgyzstan": "KG",
    "Iran": "IR", "Afghanistan": "AF", "Pakistan": "PK", "Tajikistan": "TJ",
    "Indonesia": "ID", "Malaysia": "MY", "Bangladesh": "BD", "Brunei": "BN",
    "Maldives": "MV", "Philippines": "PH", "Timor-Leste": "TL", "Israel": "IL",
    "India": "IN", "Nepal": "NP", "Thailand": "TH", "Myanmar": "MM",
    "Cambodia": "KH", "Laos": "LA", "Sri Lanka": "LK", "Mongolia": "MN",
    "Bhutan": "BT", "Japan": "JP", "South Korea": "KR", "Korea": "KR",
    "Vietnam": "VN", "China": "CN", "Taiwan": "TW", "North Korea": "KP",
    "Dem. Rep. Korea": "KP",
    "Morocco": "MA", "Algeria": "DZ", "Tunisia": "TN", "Libya": "LY",
    "Mauritania": "MR", "Egypt": "EG", "Sudan": "SD",
    "Nigeria": "NG", "Ghana": "GH", "Sierra Leone": "SL", "Liberia": "LR",
    "Gambia": "GM", "Kenya": "KE", "Tanzania": "TZ", "Uganda": "UG",
    "Rwanda": "RW", "Burundi": "BI", "S. Sudan": "SS", "South Sudan": "SS",
    "South Africa": "ZA", "Zimbabwe": "ZW", "Zambia": "ZM", "Botswana": "BW",
    "Namibia": "NA", "Lesotho": "LS", "Swaziland": "SZ", "eSwatini": "SZ", "Malawi": "MW",
    "Senegal": "SN", "Mali": "ML", "C√¥te d'Ivoire": "CI", "Ivory Coast": "CI",
    "Burkina Faso": "BF", "Niger": "NE", "Togo": "TG", "Benin": "BJ", "Guinea": "GN",
    "Dem. Rep. Congo": "CD", "Congo": "CG", "Gabon": "GA", "Cameroon": "CM",
    "Chad": "TD", "Central African Rep.": "CF",
    "Angola": "AO", "Mozambique": "MZ", "Guinea-Bissau": "GW", "Cabo Verde": "CV",
    "Cape Verde": "CV", "S√£o Tom√© and Pr√≠ncipe": "ST",
    "Ethiopia": "ET", "Somalia": "SO", "Eritrea": "ER", "Djibouti": "DJ",
    "Madagascar": "MG", "Mauritius": "MU", "Seychelles": "SC", "Comoros": "KM",
    "Eq. Guinea": "GQ", "Antarctica": "AQ", "N. Cyprus": "CY", "Greenland": "GL",
    "Singapore": "SG"
};

// ============================================================================
// UPDATED REGIONS CONFIG - Following user's exact structure
// ============================================================================

const REGIONS_CONFIG = [
    {
        region: "EUROPE",
        groups: [
            { name: "‚öôÔ∏è GERMANICS", subgroups: [
                { name: "Central", countries: ["DE", "CH", "NL", "AT", "LI", "LU"] },
                { name: "Anglo", countries: ["GB", "IE"] },
                { name: "Norse-Scand", countries: ["SE", "NO", "DK", "IS"] }
            ]},
            { name: "üèõÔ∏è GRECO-ROMANS", subgroups: [
                { name: "Franco", countries: ["FR", "BE", "MC"] },
                { name: "Iberians", countries: ["ES", "PT", "AD"] },
                { name: "Italics", countries: ["IT", "VA", "MT", "SM"] },
                { name: "Hellenics", countries: ["GR", "CY"] },
                { name: "Romance", countries: ["RO", "MD"] }
            ]},
            { name: "ü™Ü SLAVS", subgroups: [
                { name: "Balkan Slavs", countries: ["BG", "MK", "RS", "BA", "ME", "HR", "SI"] },
                { name: "West Slavs", countries: ["PL", "CZ", "SK"] },
                { name: "East Slavs", countries: ["UA", "RU", "BY"] }
            ]},
            { name: "ü™® OTHERS", subgroups: [
                { name: "Finno-Ugric", countries: ["EE", "HU", "FI"] },
                { name: "Baltic", countries: ["LT", "LV"] },
                { name: "Uniq-Caucasu", countries: ["AL", "XK", "GE", "AM", "AZ"] }
            ]}
        ]
    },
    {
        region: "AMERICAS",
        groups: [
            { name: "ü¶Ö GERMANICS", subgroups: [
                { name: "Anglo-America", countries: ["US", "CA"] },
                { name: "Francophone", countries: ["HT"] }
            ]},
            { name: "ü™≠ SPANISH", subgroups: [
                { name: "Aztec & Maya", countries: ["MX", "GT", "HN", "SV", "NI", "CR", "PA"] },
                { name: "Inca-Andeans", countries: ["AR", "CL", "PE", "BO", "EC", "CO", "VE"] },
                { name: "Caribbean&Other", countries: ["PY", "CU", "DO", "UY"] }
            ]},
            { name: "ü¶ú ROMANCE", subgroups: [
                { name: "Luso-African", countries: ["BR"] }
            ]}
        ]
    },
    {
        region: "OCEANIA",
        groups: [
            { name: "ü¶ò AUSTRALASIA", subgroups: [
                { name: "Anglo-Abo", countries: ["AU"] }
            ]},
            { name: "ü™∂ POLYNESIA", subgroups: [
                { name: "Anglo-Mao", countries: ["NZ"] },
                { name: "Island Polynesia", countries: ["WS", "TO", "TV"] }
            ]},
            { name: "üóø MICROMELANESIA", subgroups: [
                { name: "Small Islands", countries: ["PW", "FM", "MH", "NR", "KI"] },
                { name: "Black Islands", countries: ["FJ", "PG", "SB", "VU"] }
            ]}
        ]
    },
    {
        region: "ASIA",
        groups: [
            { name: "üïØÔ∏è ABRAHAMIC", subgroups: [
                { name: "Muslims Arabs", countries: ["JO", "QA", "SA", "AE", "KW", "BH", "OM", "YE", "IQ", "SY", "LB", "PS"] },
                { name: "Muslims Turkish", countries: ["TR", "KZ", "UZ", "TM", "KG"] },
                { name: "Muslims Persians", countries: ["IR", "AF", "PK", "TJ"] },
                { name: "Muslims SE", countries: ["ID", "MY", "BD", "BN", "MV"] },
                { name: "Catholic", countries: ["PH", "TL"] },
                { name: "Jews", countries: ["IL"] }
            ]},
            { name: "üßò HINDUS", subgroups: [
                { name: "Hindus", countries: ["IN", "NP"] }
            ]},
            { name: "üßòüèª‚Äç‚ôÇÔ∏è BUDDHIST & TAO", subgroups: [
                { name: "Theravada Budd.", countries: ["TH", "MM", "KH", "LA", "LK"] },
                { name: "Vajrayana Budd.", countries: ["MN", "BT"] },
                { name: "Mahayana Budd.", countries: ["JP", "KR", "VN"] },
                { name: "Taoist, Conf.", countries: ["CN", "TW", "KP", "SG"] }
            ]}
        ]
    },
    {
        region: "AFRICA",
        groups: [
            { name: "ü´ñ MAGHREB & NORTH", subgroups: [
                { name: "Arab-Berber", countries: ["MA", "DZ", "TN", "LY", "MR"] },
                { name: "Nile Valley", countries: ["EG", "SD"] }
            ]},
            { name: "üíé ANGLOPHONE", subgroups: [
                { name: "West (English)", countries: ["NG", "GH", "SL", "LR", "GM"] },
                { name: "East (Swahili)", countries: ["KE", "TZ", "UG", "RW", "BI", "SS"] },
                { name: "Southern Africa", countries: ["ZA", "ZW", "ZM", "BW", "NA", "LS", "SZ", "MW"] }
            ]},
            { name: "ü™ò FRANCOPHONE", subgroups: [
                { name: "West (French)", countries: ["SN", "ML", "CI", "BF", "NE", "TG", "BJ", "GN"] },
                { name: "Central Africa", countries: ["CD", "CG", "GA", "CM", "TD", "CF"] }
            ]},
            { name: "ü•Å LUSO & OTHERS", subgroups: [
                { name: "Portuguese Speak", countries: ["AO", "MZ", "GW", "CV", "ST"] },
                { name: "Horn (Cushitic)", countries: ["ET", "SO", "ER", "DJ"] },
                { name: "Indian Ocean", countries: ["MG", "MU", "SC", "KM"] }
            ]}
        ]
    }
];

let countryMap = {};
let hierarchy = [];
let totalCountries = 0;
let lockedGroupId = null;
let svg, g, zoom, projection, path, tooltip;

function isoToFlag(iso) {
    if (!iso || iso.length !== 2) return '';
    return String.fromCodePoint(iso.charCodeAt(0) - 65 + 0x1F1E6, iso.charCodeAt(1) - 65 + 0x1F1E6);
}

function buildData() {
    hierarchy = [];
    countryMap = {};
    totalCountries = 0;
    let gid = 0;

    for (const rc of REGIONS_CONFIG) {
        const region = {
            name: rc.region,
            groups: [],
            baseColor: REGION_COLORS[rc.region],
            element: REGION_ELEMENTS[rc.region]
        };

        for (const gc of rc.groups) {
            gid++;
            const color = getGroupColor(gc.name);
            const group = { name: gc.name, id: 'g' + gid, color, subgroups: [], countryCount: 0 };

            for (const sc of gc.subgroups) {
                const sub = { name: sc.name, flags: sc.countries.map(isoToFlag).join(' '), count: sc.countries.length };
                for (const iso of sc.countries) {
                    countryMap[iso] = {
                        region: rc.region,
                        group: gc.name,
                        groupId: group.id,
                        subgroup: sc.name,
                        color
                    };
                    group.countryCount++;
                    totalCountries++;
                }
                group.subgroups.push(sub);
            }
            region.groups.push(group);
        }
        hierarchy.push(region);
    }
}

function startApp() {
    console.log('üó∫Ô∏è Cultural Regions Terrain Map');
    buildData();

    document.getElementById('stat-countries').textContent = totalCountries;
    document.getElementById('stat-regions').textContent = hierarchy.length;
    document.getElementById('stat-groups').textContent = hierarchy.reduce((s, r) => s + r.groups.length, 0);

    setupMap();
    setupUI();
    renderSidebar();
    renderLegend();
    loadMap();
}

function setupMap() {
    const wrapper = document.querySelector('.map-wrapper');
    const w = wrapper.clientWidth, h = wrapper.clientHeight;

    svg = d3.select('#world-map');
    g = svg.append('g');
    tooltip = d3.select('#tooltip');

    projection = d3.geoNaturalEarth1().scale(w / 5.5).translate([w / 2, h / 2]);
    path = d3.geoPath().projection(projection);
    zoom = d3.zoom().scaleExtent([1, 8]).on('zoom', e => g.attr('transform', e.transform));
    svg.call(zoom);

    // Ocean background
    g.append('rect')
        .attr('x', -5000).attr('y', -5000)
        .attr('width', 15000).attr('height', 15000)
        .attr('fill', '#1a2634')
        .style('cursor', 'pointer')
        .on('click', resetView);

    g.append('path').datum(d3.geoGraticule()()).attr('class', 'graticule').attr('d', path);

    window.addEventListener('resize', () => {
        const nw = wrapper.clientWidth, nh = wrapper.clientHeight;
        projection.translate([nw / 2, nh / 2]).scale(nw / 5.5);
        g.selectAll('path').attr('d', path);
    });
}

function loadMap() {
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
        .then(r => r.json())
        .then(renderCountries)
        .catch(() => document.getElementById('loader').innerHTML = '<h2 style="color:#ef4444">Failed to load map</h2>');
}

function renderCountries(world) {
    const features = topojson.feature(world, world.objects.countries).features;
    let matched = 0;

    g.selectAll('.country').data(features).enter().append('path')
        .attr('d', path)
        .attr('class', 'country')
        .attr('fill', d => {
            const iso = NAME_TO_ISO[d.properties?.name];
            const data = iso ? countryMap[iso] : null;
            if (data) { matched++; return data.color; }
            return '#2a3441';
        })
        .attr('filter', 'url(#terrain-mountains)')
        .attr('data-gid', d => { const iso = NAME_TO_ISO[d.properties?.name]; return (iso && countryMap[iso]) ? countryMap[iso].groupId : ''; })
        .attr('data-region', d => { const iso = NAME_TO_ISO[d.properties?.name]; return (iso && countryMap[iso]) ? countryMap[iso].region : ''; })
        .on('click', onCountryClick)
        .on('mouseover', onCountryOver)
        .on('mousemove', e => tooltip.style('left', (e.pageX + 12) + 'px').style('top', (e.pageY + 12) + 'px'))
        .on('mouseout', () => { tooltip.style('display', 'none'); if (!lockedGroupId) resetOpacity(); });

    console.log('üó∫Ô∏è Rendered:', matched, 'countries');
    document.getElementById('loader').style.opacity = '0';
    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
}

function onCountryClick(e, d) {
    e.stopPropagation();
    const gid = d3.select(e.currentTarget).attr('data-gid');
    if (!gid) return;
    if (lockedGroupId === gid) {
        lockedGroupId = null;
        resetOpacity();
        document.querySelectorAll('.group-block').forEach(el => el.classList.remove('pinned'));
    } else {
        lockedGroupId = gid;
        highlightGroup(gid);
        document.querySelectorAll('.group-block').forEach(el => el.classList.toggle('pinned', el.dataset.groupId === gid));
    }
}

function onCountryOver(e, d) {
    const name = d.properties?.name || 'Unknown';
    const iso = NAME_TO_ISO[name];
    const data = iso ? countryMap[iso] : null;
    tooltip.style('display', 'block').html(
        '<div class="tooltip-title">' + name + '</div>' +
        (data ? '<div class="tooltip-region">' + data.region + '</div><div class="tooltip-group" style="color:' + data.color + '">' + data.group + '</div><div class="tooltip-subgroup">' + data.subgroup + '</div>'
        : '<div class="tooltip-unassigned">Not classified</div>')
    );
    if (!lockedGroupId && data) highlightGroup(data.groupId);
}

function highlightGroup(gid) { g.selectAll('.country').style('opacity', function() { return d3.select(this).attr('data-gid') === gid ? 1 : 0.08; }); }
function highlightRegion(reg) { g.selectAll('.country').style('opacity', function() { return d3.select(this).attr('data-region') === reg ? 1 : 0.08; }); }
function resetOpacity() { g.selectAll('.country').style('opacity', 1); }

function resetView() {
    lockedGroupId = null;
    resetOpacity();
    document.querySelectorAll('.group-block').forEach(el => el.classList.remove('pinned'));
    document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('active'));
}

function setupUI() {
    document.getElementById('menu-btn').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('close-btn').onclick = () => document.getElementById('sidebar').classList.add('collapsed');
    document.getElementById('zoom-in').onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 1.5);
    document.getElementById('zoom-out').onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 0.67);
    document.getElementById('reset-zoom').onclick = () => {
        svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        resetView();
    };
    document.getElementById('search-input').oninput = onSearch;
    document.onkeydown = e => {
        if (e.key === 'Escape') { svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity); resetView(); }
        if (e.key === 'm' || e.key === 'M') document.getElementById('sidebar').classList.toggle('collapsed');
    };
    svg.on('click', function(e) { if (e.target.tagName === 'svg') resetView(); });
}

function onSearch(e) {
    const q = e.target.value.toLowerCase().trim();
    document.querySelectorAll('.region-block').forEach(rb => {
        let m = false;
        rb.querySelectorAll('.group-block').forEach(gb => {
            let gm = gb.querySelector('.group-name').textContent.toLowerCase().includes(q);
            gb.querySelectorAll('.subgroup-item').forEach(si => { if (si.textContent.toLowerCase().includes(q)) gm = true; });
            gb.style.display = (!q || gm) ? '' : 'none';
            if (gm) m = true;
        });
        rb.style.display = (!q || m) ? '' : 'none';
    });
}

function renderSidebar() {
    const c = document.getElementById('sidebar-content');
    c.innerHTML = '';
    for (const r of hierarchy) {
        const rd = document.createElement('div'); rd.className = 'region-block';
        rd.innerHTML = '<div class="region-title">' + (r.element || '') + ' ' + r.name + '</div>';
        for (const gr of r.groups) {
            const gd = document.createElement('div'); gd.className = 'group-block'; gd.dataset.groupId = gr.id; gd.style.borderLeftColor = gr.color;
            const hd = document.createElement('div'); hd.className = 'group-header';
            hd.innerHTML = '<div class="color-dot" style="background:' + gr.color + '"></div><span class="group-name">' + gr.name + '</span><span class="group-count">' + gr.countryCount + '</span><div class="pin-indicator">PIN</div>';
            hd.onclick = () => { if (lockedGroupId === gr.id) { lockedGroupId = null; gd.classList.remove('pinned'); resetOpacity(); } else { document.querySelectorAll('.group-block').forEach(el => el.classList.remove('pinned')); lockedGroupId = gr.id; gd.classList.add('pinned'); highlightGroup(gr.id); } };
            hd.onmouseenter = () => { if (!lockedGroupId) highlightGroup(gr.id); };
            hd.onmouseleave = () => { if (!lockedGroupId) resetOpacity(); };
            const sl = document.createElement('div'); sl.className = 'subgroup-list';
            for (const s of gr.subgroups) { const si = document.createElement('div'); si.className = 'subgroup-item'; si.innerHTML = '<span class="subgroup-name">' + s.name + '</span><span class="subgroup-flags">' + s.flags + '</span>'; sl.appendChild(si); }
            gd.appendChild(hd); gd.appendChild(sl); rd.appendChild(gd);
        }
        c.appendChild(rd);
    }
}

function renderLegend() {
    const c = document.getElementById('legend-items');
    c.innerHTML = '';
    for (const r of hierarchy) {
        const it = document.createElement('div'); it.className = 'legend-item'; it.dataset.region = r.name;
        it.innerHTML = '<div class="legend-dot" style="background:' + r.baseColor + '"></div><span>' + r.element + ' ' + r.name + '</span>';
        it.onclick = () => {
            const active = it.classList.contains('active');
            c.querySelectorAll('.legend-item').forEach(i => i.classList.remove('active'));
            if (active) { resetView(); }
            else { it.classList.add('active'); highlightRegion(r.name); document.querySelectorAll('.group-block').forEach(el => el.classList.remove('pinned')); }
        };
        c.appendChild(it);
    }
}
</script>
</body>
</html>
