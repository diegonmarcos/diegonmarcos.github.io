<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Dashboard | Live Monitoring</title>

    <!-- Matomo Tag Manager -->
    <script>
      var _mtm = window._mtm = window._mtm || [];
      _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
      (function() {
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src='https://analytics.diegonmarcos.com/js/container_odwLIyPV.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Tag Manager -->

    <link rel="stylesheet" href="styles.css">
    <style>
        /* Dashboard-specific styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dashboard-title h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: var(--accent-red);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--accent-green); }
            50% { opacity: 0.6; box-shadow: 0 0 8px var(--accent-green); }
        }

        .dashboard-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .auto-refresh-toggle input {
            accent-color: var(--accent-primary);
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--border-radius);
            color: #000;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            transform: scale(1.02);
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .last-updated {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Live status badge that gets updated by JS */
        .live-status {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .live-status.checking {
            background: rgba(156, 163, 175, 0.15);
            color: var(--text-tertiary);
        }

        .live-status.online {
            background: rgba(74, 222, 128, 0.15);
            color: var(--accent-green);
        }

        .live-status.offline {
            background: rgba(248, 113, 113, 0.15);
            color: var(--accent-red);
        }

        .live-status.pending {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-yellow);
        }

        .live-status.dev {
            background: rgba(96, 165, 250, 0.15);
            color: var(--accent-blue);
        }

        .live-status.hold {
            background: rgba(251, 191, 36, 0.15);
            color: var(--accent-yellow);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .live-status.online .live-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 2px currentColor; }
            50% { box-shadow: 0 0 6px currentColor; }
        }
    </style>
    <script>
        // Apply saved theme immediately
        (function() {
            var theme = localStorage.getItem('cloud-dashboard-theme') || 'blurred';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>Cloud Services Dashboard</h1>
            <p class="subtitle">Manage your infrastructure</p>
            <div class="view-toggle">
                <div class="view-group">
                    <span class="view-group-label">Services</span>
                    <div class="view-group-buttons">
                        <a href="index.html#cards-front" class="view-btn">Cards-F</a>
                        <a href="index.html#cards-back" class="view-btn">Cards-B</a>
                        <a href="index.html#list-front" class="view-btn">List-F</a>
                        <a href="index.html#list-back" class="view-btn">List-B</a>
                    </div>
                </div>
                <span class="view-separator"></span>
                <div class="view-group">
                    <span class="view-group-label">Architecture</span>
                    <div class="view-group-buttons">
                        <a href="index.html#resources" class="view-btn">Resources</a>
                        <a href="arch.html" class="view-btn">Server</a>
                        <a href="ai-arch.html" class="view-btn">AI</a>
                    </div>
                </div>
                <span class="view-separator"></span>
                <div class="view-group">
                    <span class="view-group-label">Monitoring</span>
                    <div class="view-group-buttons">
                        <a href="index.html#backlog" class="view-btn">Backlog</a>
                        <a href="index.html#tree" class="view-btn">Tree</a>
                        <span class="view-btn active">List</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Controls -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <div class="status-dot" id="connection-status"></div>
                <h2>Live Monitoring</h2>
            </div>
            <div class="dashboard-controls">
                <span class="last-updated">Last: <span id="last-updated">--:--:--</span></span>
                <label class="auto-refresh-toggle">
                    <input type="checkbox" id="auto-refresh" checked>
                    Auto (30s)
                </label>
                <button class="refresh-btn" id="refresh-btn" onclick="refreshAll()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- VMs Section - Back/Infra -->
        <div class="resources-category">
            <h3 class="resources-category-title">VMs</h3>
            <div class="resources-section">
                <div class="resources-table-container">
                    <table class="resources-table status-table">
                        <thead><tr><th>Mode</th><th>VM</th><th>IP</th><th>SSH</th><th>RAM</th><th>Storage</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr class="vm-row"><td><span class="status-badge on">ON</span></td><td><strong>Oracle Web Server 1</strong></td><td>130.110.251.193</td><td>ssh ubuntu@130.110.251.193</td><td>800MB-1.5GB</td><td>5-15GB</td><td><span class="live-status checking" data-vm="oracle-web-server-1"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="vm-row"><td><span class="status-badge on">ON</span></td><td><strong>Oracle Services Server 1</strong></td><td>129.151.228.66</td><td>ssh ubuntu@129.151.228.66</td><td>600MB-1.2GB</td><td>5-15GB</td><td><span class="live-status checking" data-vm="oracle-services-server-1"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="vm-row"><td><span class="status-badge dev">DEV</span></td><td><strong>GCloud Arch 1</strong></td><td>pending</td><td>-</td><td>800MB-1.5GB</td><td>10-50GB</td><td><span class="live-status pending" data-vm="gcloud-arch-1"><span class="live-dot"></span>Pending</span></td></tr>
                            <tr class="vm-row"><td><span class="status-badge hold">HOLD</span></td><td><strong>Oracle ARM Server</strong></td><td>pending</td><td>-</td><td>6-24GB</td><td>5-20GB</td><td><span class="live-status hold" data-vm="oracle-arm-server"><span class="live-dot"></span>Hold</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- User Services -->
        <div class="resources-category">
            <h3 class="resources-category-title">User Services</h3>
            <div class="resources-section">
                <div class="resources-table-container">
                    <table class="resources-table status-table">
                        <thead><tr><th>Mode</th><th>Service</th><th>URL</th><th>IP:Port</th><th>RAM</th><th>Storage</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>Sync</strong></td><td>sync.diegonmarcos.com</td><td>130.110.251.193:8384</td><td>128-256MB</td><td>5.2-106GB</td><td><span class="live-status checking" data-service="sync-app"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="component-row"><td></td><td class="component-name">↳ syncthing</td><td></td><td>:8384</td><td>128-256MB</td><td>100-500MB</td><td></td></tr>
                            <tr class="component-row"><td></td><td class="component-name">↳ sync-index-db</td><td></td><td>-</td><td>-</td><td>100-500MB</td><td></td></tr>
                            <tr class="service-row"><td><span class="status-badge dev">DEV</span></td><td><strong>Mail Server</strong></td><td>mail.diegonmarcos.com</td><td>-</td><td>520MB-1GB</td><td>5-50GB</td><td><span class="live-status dev" data-service="mail-app"><span class="live-dot"></span>Dev</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge dev">DEV</span></td><td><strong>OpenVPN</strong></td><td>-</td><td>:1194</td><td>64-128MB</td><td>50-100MB</td><td><span class="live-status dev" data-service="vpn-app"><span class="live-dot"></span>Dev</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Coder Services -->
        <div class="resources-category">
            <h3 class="resources-category-title">Coder Services</h3>
            <div class="resources-section">
                <div class="resources-table-container">
                    <table class="resources-table status-table">
                        <thead><tr><th>Mode</th><th>Service</th><th>URL</th><th>IP:Port</th><th>RAM</th><th>Storage</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>Matomo</strong></td><td>analytics.diegonmarcos.com</td><td>129.151.228.66:8080</td><td>512MB-1GB</td><td>3-15GB</td><td><span class="live-status checking" data-service="analytics-app"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="component-row"><td></td><td class="component-name">↳ matomo-app</td><td></td><td>:8080</td><td>256-512MB</td><td>2-5GB</td><td></td></tr>
                            <tr class="component-row"><td></td><td class="component-name">↳ matomo-db (MariaDB)</td><td></td><td>:3306</td><td>256-512MB</td><td>1-10GB</td><td></td></tr>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>Cloud Dashboard</strong></td><td>cloud.diegonmarcos.com</td><td>130.110.251.193:5000</td><td>64-128MB</td><td>50-100MB</td><td><span class="live-status checking" data-service="cloud-app"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge dev">DEV</span></td><td><strong>Gitea</strong></td><td>git.diegonmarcos.com</td><td>:3000</td><td>264-544MB</td><td>11-15GB</td><td><span class="live-status dev" data-service="git-app"><span class="live-dot"></span>Dev</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge dev">DEV</span></td><td><strong>Web Terminal</strong></td><td>terminal.diegonmarcos.com</td><td>:7681</td><td>64-128MB</td><td>50-100MB</td><td><span class="live-status dev" data-service="terminal-app"><span class="live-dot"></span>Dev</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Services -->
        <div class="resources-category">
            <h3 class="resources-category-title">AI Services</h3>
            <div class="resources-section">
                <div class="resources-table-container">
                    <table class="resources-table status-table">
                        <thead><tr><th>Mode</th><th>Service</th><th>URL</th><th>IP:Port</th><th>RAM</th><th>Storage</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr class="service-row"><td><span class="status-badge hold">HOLD</span></td><td><strong>n8n (AI)</strong></td><td>ai.diegonmarcos.com</td><td>-</td><td>1.3-48GB</td><td>3-20GB</td><td><span class="live-status hold" data-service="n8n-ai-app"><span class="live-dot"></span>Hold</span></td></tr>
                            <tr class="component-row"><td></td><td class="component-name">↳ n8n-ai-app</td><td></td><td>:5678</td><td>1-48GB</td><td>2-10GB</td><td></td></tr>
                            <tr class="component-row"><td></td><td class="component-name">↳ n8n-ai-db (PostgreSQL)</td><td></td><td>-</td><td>256-512MB</td><td>1-10GB</td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Infra Services -->
        <div class="resources-category">
            <h3 class="resources-category-title">Infra Services</h3>
            <div class="resources-section">
                <div class="resources-table-container">
                    <table class="resources-table status-table">
                        <thead><tr><th>Mode</th><th>Service</th><th>URL</th><th>IP:Port</th><th>RAM</th><th>Storage</th><th>Status</th></tr></thead>
                        <tbody>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>NPM (Oracle Web)</strong></td><td>-</td><td>130.110.251.193:81</td><td>128-256MB</td><td>100-500MB</td><td><span class="live-status checking" data-service="npm-oracle-web"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>NPM (Oracle Services)</strong></td><td>-</td><td>129.151.228.66:81</td><td>128-256MB</td><td>100-500MB</td><td><span class="live-status checking" data-service="npm-oracle-services"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge hold">HOLD</span></td><td><strong>NPM (Oracle ARM)</strong></td><td>-</td><td>pending</td><td>128-256MB</td><td>100-500MB</td><td><span class="live-status hold" data-service="npm-oracle-arm"><span class="live-dot"></span>Hold</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge dev">DEV</span></td><td><strong>NPM (GCloud)</strong></td><td>-</td><td>pending</td><td>128-256MB</td><td>100-500MB</td><td><span class="live-status dev" data-service="npm-gcloud"><span class="live-dot"></span>Dev</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>n8n (Infra)</strong></td><td>n8n.diegonmarcos.com</td><td>130.110.251.193:5678</td><td>256-512MB</td><td>500MB-2GB</td><td><span class="live-status checking" data-service="n8n-infra-app"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge on">ON</span></td><td><strong>Cloud Dashboard API</strong></td><td>-</td><td>130.110.251.193:5000</td><td>64-128MB</td><td>50-100MB</td><td><span class="live-status checking" data-service="cloud-api"><span class="live-dot"></span>Checking...</span></td></tr>
                            <tr class="service-row"><td><span class="status-badge dev">DEV</span></td><td><strong>Redis</strong></td><td>-</td><td>:6379</td><td>64-256MB</td><td>100MB-1GB</td><td><span class="live-status dev" data-service="cache-app"><span class="live-dot"></span>Dev</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Configuration
        const apiUrl = 'http://130.110.251.193:5000/api';
        let autoRefreshInterval = null;
        let isLoading = false;

        // Auto-refresh toggle
        document.getElementById('auto-refresh').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(refreshAll, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Update a single status badge
        function updateStatus(element, status, label) {
            element.className = 'live-status ' + status;
            element.innerHTML = `<span class="live-dot"></span>${label}`;
        }

        // Fetch API and update status badges
        async function refreshAll() {
            if (isLoading) return;
            isLoading = true;

            const refreshBtn = document.getElementById('refresh-btn');
            const connectionStatus = document.getElementById('connection-status');
            refreshBtn.classList.add('loading');

            try {
                const response = await fetch(`${apiUrl}/dashboard/summary`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                connectionStatus.classList.remove('disconnected');

                // Update VM statuses
                data.vms.forEach(cat => {
                    cat.vms.forEach(vm => {
                        const el = document.querySelector(`[data-vm="${vm.id}"]`);
                        if (el) {
                            const status = vm.status.toLowerCase().replace(' ', '-');
                            const statusMap = {
                                'online': { class: 'online', label: 'Online' },
                                'offline': { class: 'offline', label: 'Offline' },
                                'no-ssh': { class: 'pending', label: 'No SSH' },
                                'pending': { class: 'pending', label: 'Pending' }
                            };
                            const s = statusMap[status] || { class: 'checking', label: vm.status };
                            updateStatus(el, s.class, s.label);
                        }
                    });
                });

                // Update Service statuses
                data.services.forEach(cat => {
                    cat.services.forEach(svc => {
                        const el = document.querySelector(`[data-service="${svc.id}"]`);
                        if (el) {
                            const statusMap = {
                                'healthy': { class: 'online', label: 'Healthy' },
                                'error': { class: 'offline', label: 'Error' },
                                'development': { class: 'dev', label: 'Dev' },
                                'hold': { class: 'hold', label: 'Hold' },
                                'tbd': { class: 'pending', label: 'TBD' },
                                'no_url': { class: 'pending', label: 'N/A' }
                            };
                            const s = statusMap[svc.health_status] || { class: 'checking', label: svc.health_status };
                            updateStatus(el, s.class, s.label);
                        }
                    });
                });

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('API Error:', error);
                connectionStatus.classList.add('disconnected');

                // Mark all checking statuses as offline
                document.querySelectorAll('.live-status.checking').forEach(el => {
                    updateStatus(el, 'offline', 'Error');
                });
            } finally {
                refreshBtn.classList.remove('loading');
                isLoading = false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();
            if (document.getElementById('auto-refresh').checked) {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
