<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MyTrips | Global Command Center</title>
    <!-- Force Desktop Viewport -->
    <meta name="viewport" content="width=1440, initial-scale=1">

    <!-- 1. TAILWIND CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { slate: { 950: '#020617' } }, // Deep Dark Theme
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- 2. LEAFLET (Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 3. CHART.JS (Analytics) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 4. PHOSPHOR ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Minimal Custom Overrides */
        body { background: #020617; color: #e2e8f0; min-width: 1440px; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border-right: 1px solid rgba(255, 255, 255, 0.05); }

        /* Map Dark Mode Fixes */
        .leaflet-container { background: #0b0f19; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #1e293b; color: white; border: 1px solid #334155; }

        /* Smooth Fade & Slide Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.5s ease; transform: scale(1.1); }
        .slide-img.active { opacity: 0.5; transform: scale(1); transition: opacity 1.5s ease, transform 10s linear; }
    </style>
</head>
<body class="h-screen w-screen flex selection:bg-cyan-500 selection:text-white font-sans">

    <!-- SIDEBAR -->
    <aside class="w-72 h-full glass-panel flex flex-col z-50 flex-shrink-0">
        <div class="h-24 flex items-center px-8 gap-4 border-b border-white/5 bg-slate-900/50">
            <div class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 border border-cyan-500/20">
                <i class="ph-fill ph-globe-stand text-2xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-xl tracking-wider text-white">MYTRIPS</h1>
                <p class="text-[10px] text-cyan-400 font-bold tracking-widest mt-0.5 uppercase">Ultimate</p>
            </div>
        </div>

        <nav class="flex-1 px-4 py-8 space-y-2">
            <div class="px-4 text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Main Views</div>
            <button onclick="setView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-cyan-500/10 text-cyan-400 border border-cyan-500/20">
                <i class="ph ph-squares-four text-xl"></i> <span class="font-medium">Home</span>
            </button>
            <button onclick="setView('atlas')" id="nav-atlas" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5 hover:text-white">
                <i class="ph ph-map-trifold text-xl"></i> <span class="font-medium">The Atlas</span>
            </button>
            <button onclick="setView('themes')" id="nav-themes" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5 hover:text-white">
                <i class="ph ph-cards text-xl"></i> <span class="font-medium">Collections</span>
                <span class="ml-auto text-[10px] bg-white/10 px-2 rounded-full">16</span>
            </button>
            <button onclick="setView('analytics')" id="nav-analytics" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5 hover:text-white">
                <i class="ph ph-chart-polar text-xl"></i> <span class="font-medium">Stats</span>
            </button>
            <a href="./myroadtrip.html" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-white/5 hover:text-white">
                <i class="ph ph-globe-hemisphere-west text-xl"></i>
                <span class="font-medium">Cultural Regions Map</span>
            </a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative h-full bg-slate-950 flex flex-col">
        <!-- Header -->
        <header class="h-20 flex-none flex items-center justify-between px-10 border-b border-white/5 bg-slate-950/80 backdrop-blur z-40">
            <div>
                <h2 id="page-title" class="text-2xl font-light text-white tracking-tight">Mission Control</h2>
                <p class="text-xs text-slate-400 mt-1">
                    <span id="system-clock">Initializing Clock...</span> • 170 Cities Loaded
                </p>
            </div>
            <div class="glass px-4 py-2 rounded-full flex items-center gap-3 text-sm text-slate-400 w-80">
                <i class="ph ph-magnifying-glass text-lg"></i>
                <input id="global-search" type="text" placeholder="Search database..." class="bg-transparent border-none focus:outline-none w-full text-white placeholder-slate-600">
            </div>
        </header>

        <!-- Dynamic Viewport -->
        <div id="content-viewport" class="flex-1 overflow-y-auto p-10">

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section fade-in space-y-8">
                <!-- KPI Cards -->
                <div class="grid grid-cols-4 gap-6">
                    <div class="glass p-6 rounded-2xl hover:-translate-y-1 transition-transform border-t-4 border-cyan-500">
                        <div class="text-slate-400 text-xs uppercase font-bold mb-2">Total Cities</div>
                        <div class="text-4xl font-light text-white mb-1">170</div>
                        <div class="text-xs text-cyan-400 flex items-center gap-1"><i class="ph-bold ph-trend-up"></i> +12 this year</div>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:-translate-y-1 transition-transform border-t-4 border-purple-500">
                        <div class="text-slate-400 text-xs uppercase font-bold mb-2">Countries</div>
                        <div class="text-4xl font-light text-white mb-1">40</div>
                        <div class="text-xs text-purple-400">19% of World</div>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:-translate-y-1 transition-transform border-t-4 border-amber-500">
                        <div class="text-slate-400 text-xs uppercase font-bold mb-2">Time Abroad</div>
                        <div class="text-4xl font-light text-white mb-1">842d</div>
                        <div class="text-xs text-amber-400">~2.3 Years</div>
                    </div>
                    <div class="glass p-6 rounded-2xl hover:-translate-y-1 transition-transform border-t-4 border-rose-500">
                        <div class="text-slate-400 text-xs uppercase font-bold mb-2">Longest Streak</div>
                        <div class="text-4xl font-light text-white mb-1">45d</div>
                        <div class="text-xs text-rose-400">Asia 2018</div>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="grid grid-cols-3 gap-6 h-80">
                    <div class="col-span-2 glass p-6 rounded-2xl">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Travel Velocity</h3>
                        <div class="h-60 w-full"><canvas id="chart-velocity"></canvas></div>
                    </div>
                    <div class="col-span-1 glass p-6 rounded-2xl">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Regional Split</h3>
                        <div class="h-60 w-full flex justify-center"><canvas id="chart-continents"></canvas></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass p-6 rounded-2xl">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Recent Expeditions (Searchable)</h3>
                    <div class="space-y-3" id="recent-list"><!-- JS Injected --></div>
                </div>
            </div>

            <!-- VIEW: ATLAS -->
            <div id="view-atlas" class="view-section hidden h-full relative rounded-2xl overflow-hidden border border-white/10 shadow-2xl">
                <div id="map-main" class="w-full h-full bg-slate-900"></div>
                <!-- Controls -->
                <div class="absolute top-6 left-6 z-[400] w-64 glass p-4 rounded-xl">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-3">Map Layers</h4>
                    <div class="space-y-1" id="atlas-modes"><!-- JS Injected --></div>
                </div>
                <!-- Legend -->
                <div id="map-legend" class="absolute bottom-6 right-6 z-[400] glass p-4 rounded-xl hidden">
                    <div id="legend-content" class="text-sm space-y-2"></div>
                </div>
            </div>

            <!-- VIEW: THEMES -->
            <div id="view-themes" class="view-section hidden fade-in">
                <div class="mb-8">
                    <h3 class="text-3xl font-light text-white">Curated Collections</h3>
                    <p class="text-slate-400 mt-2">Explore the world through 16 unique lenses.</p>
                </div>
                <div id="themes-grid" class="grid grid-cols-4 gap-6 pb-12"><!-- JS Injected --></div>
            </div>

            <!-- VIEW: ANALYTICS / STATS -->
            <div id="view-analytics" class="view-section hidden fade-in space-y-6">
                <!-- Step 4: Carbon Footprint Card -->
                <div class="glass p-8 rounded-2xl flex items-center justify-between bg-gradient-to-r from-emerald-900/20 to-transparent border-emerald-500/20">
                    <div>
                        <h3 class="text-xl font-medium text-white mb-2 flex items-center gap-2">
                            <i class="ph-fill ph-leaf text-emerald-400"></i> Global Impact Estimate
                        </h3>
                        <p class="text-slate-400 text-sm max-w-lg">Estimated cumulative carbon footprint based on round-trip air travel from Home Base (LDN) to all visited coordinates.</p>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-light text-white mb-1" id="stat-km">0 km</div>
                        <div class="text-xs text-emerald-400" id="stat-co2">0 Tons CO2e</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-8">
                    <div class="glass p-8 rounded-2xl">
                        <h3 class="text-xl font-medium text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-currency-dollar text-cyan-400"></i> Economic Tiers</h3>
                        <div class="h-64"><canvas id="chart-economy"></canvas></div>
                    </div>
                    <div class="glass p-8 rounded-2xl">
                        <h3 class="text-xl font-medium text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-thermometer text-orange-400"></i> Climate Exposure</h3>
                        <div class="space-y-6" id="climate-bars">
                            <!-- Step 4: JS Injected Bars -->
                        </div>
                    </div>
                </div>

                <!-- NEW: Mission Parameters Grid -->
                <div class="glass p-8 rounded-2xl">
                    <h3 class="text-xl font-medium text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-faders text-purple-400"></i> Mission Parameters</h3>
                    <div class="grid grid-cols-5 gap-4" id="stats-grid">
                        <!-- JS Injected Stats -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- THEME OVERLAY (Modal) -->
    <div id="theme-overlay" class="fixed inset-0 z-[100] bg-slate-950 hidden opacity-0 transition-opacity duration-500 flex">
        <div id="slideshow-container" class="absolute inset-0 z-0 bg-black">
            <div class="absolute inset-0 bg-gradient-to-r from-slate-950 via-slate-950/90 to-transparent z-10"></div>
        </div>

        <div class="relative z-20 w-[35%] h-full p-16 flex flex-col justify-center border-r border-white/5 bg-slate-950/50 backdrop-blur-sm">
            <button onclick="closeTheme()" class="absolute top-10 left-10 flex items-center gap-2 text-slate-400 hover:text-white uppercase text-xs font-bold tracking-widest">
                <i class="ph-bold ph-arrow-left"></i> Back
            </button>
            <div class="mt-auto">
                <div id="theme-icon-lg" class="w-20 h-20 rounded-2xl bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-4xl mb-8 border border-cyan-500/30"></div>
                <h1 id="theme-title" class="text-6xl font-light text-white mb-6 leading-none">Title</h1>
                <p id="theme-desc" class="text-xl text-slate-300 font-light leading-relaxed mb-10 border-l-2 border-cyan-500 pl-6">Desc</p>
                <div class="glass p-6 rounded-xl w-fit">
                    <div class="text-xs text-slate-400 uppercase font-bold">Cities Included</div>
                    <div class="text-3xl font-light text-white mt-1" id="theme-count">0</div>
                </div>
            </div>
        </div>

        <div class="relative z-20 w-[65%] h-full p-12 flex flex-col justify-end">
            <div class="w-full h-[60%] rounded-2xl overflow-hidden border border-white/10 shadow-2xl bg-slate-900 relative">
                <div id="theme-map" class="w-full h-full"></div>
                <div class="absolute bottom-4 left-4 z-[500] bg-black/80 px-3 py-1 rounded text-xs text-slate-400">Filtered View</div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- 1. DATA GENERATION & CONFIG ---

        const ANCHORS = [
            { n: 'London', lat: 51.5074, lng: -0.1278 }, { n: 'New York', lat: 40.7128, lng: -74.0060 },
            { n: 'Tokyo', lat: 35.6762, lng: 139.6503 }, { n: 'Paris', lat: 48.8566, lng: 2.3522 },
            { n: 'Singapore', lat: 1.3521, lng: 103.8198 }, { n: 'Sydney', lat: -33.8688, lng: 151.2093 },
            { n: 'Dubai', lat: 25.2048, lng: 55.2708 }, { n: 'Rio de Janeiro', lat: -22.9068, lng: -43.1729 },
            { n: 'Cape Town', lat: -33.9249, lng: 18.4241 }, { n: 'Mumbai', lat: 19.0760, lng: 72.8777 },
            { n: 'Mexico City', lat: 19.4326, lng: -99.1332 }, { n: 'Cairo', lat: 30.0444, lng: 31.2357 },
            { n: 'Bangkok', lat: 13.7563, lng: 100.5018 }, { n: 'Istanbul', lat: 41.0082, lng: 28.9784 },
            { n: 'Seoul', lat: 37.5665, lng: 126.9780 }, { n: 'Buenos Aires', lat: -34.6037, lng: -58.3816 },
            { n: 'Los Angeles', lat: 34.0522, lng: -118.2437 }, { n: 'Moscow', lat: 55.7558, lng: 37.6173 },
            { n: 'Berlin', lat: 52.5200, lng: 13.4050 }, { n: 'Madrid', lat: 40.4168, lng: -3.7038 },
            { n: 'Rome', lat: 41.9028, lng: 12.4964 }, { n: 'Toronto', lat: 43.6510, lng: -79.3470 },
            { n: 'Hong Kong', lat: 22.3193, lng: 114.1694 }, { n: 'San Francisco', lat: 37.7749, lng: -122.4194 },
            { n: 'Barcelona', lat: 41.3851, lng: 2.1734 }, { n: 'Amsterdam', lat: 52.3676, lng: 4.9041 },
            { n: 'Vienna', lat: 48.2082, lng: 16.3738 }, { n: 'Stockholm', lat: 59.3293, lng: 18.0686 },
            { n: 'Reykjavik', lat: 64.1466, lng: -21.9426 }, { n: 'Lima', lat: -12.0464, lng: -77.0428 }
        ];

        const THEMES = [
            { id: 'finance', title: 'Financial Capitals', icon: 'briefcase', query: ['London','New York','Tokyo','Singapore','Hong Kong','Frankfurt','Zurich','Shanghai','Chicago'], img: 'city,skyscraper', desc: 'Global economic powerhouses defining the modern world.' },
            { id: 'ancient', title: 'Ancient History', icon: 'columns', query: ['Rome','Athens','Cairo','Luxor','Petra','Kyoto','Mexico City'], img: 'ruins,temple', desc: 'Walking in the footsteps of empires past.' },
            { id: 'tech', title: 'Tech Hubs', icon: 'cpu', query: ['San Francisco','Seattle','Shenzhen','Bangalore','Berlin','Stockholm'], img: 'technology,cyberpunk', desc: 'Centers of innovation and digital culture.' },
            { id: 'coffee', title: 'Coffee Culture', icon: 'coffee', query: ['Melbourne','Seattle','Vienna','Rome','Bogota','Hanoi'], img: 'coffee,cafe', desc: 'The best brews from espresso labs to traditional houses.' },
            { id: 'art', title: 'Art & Design', icon: 'palette', query: ['Paris','Florence','New York','Vienna','Amsterdam','Barcelona'], img: 'art,museum', desc: 'World-class galleries and street art scenes.' },
            { id: 'nature', title: 'Natural Wonders', icon: 'mountains', query: ['Banff','Reykjavik','Queenstown','Interlaken','Cape Town'], img: 'nature,mountain', desc: 'Breathtaking landscapes where nature dominates.' },
            { id: 'island', title: 'Island Life', icon: 'island', query: ['Bali','Santorini','Phuket','Hawaii','Fiji','Maldives'], img: 'beach,ocean', desc: 'Sun, sand, and isolation.' },
            { id: 'coldwar', title: 'Iron Curtain', icon: 'wall', query: ['Berlin','Moscow','Prague','Budapest','Warsaw'], img: 'concrete,soviet', desc: 'Relics of the East-West divide.' },
            { id: 'food', title: 'Gastronomy', icon: 'bowl-food', query: ['Lyon','Tokyo','San Sebastian','Oaxaca','Bologna','Bangkok'], img: 'food,market', desc: 'Culinary capitals of the world.' },
            { id: 'nordic', title: 'Nordic', icon: 'snowflake', query: ['Oslo','Stockholm','Copenhagen','Helsinki','Reykjavik'], img: 'snow,winter', desc: 'Minimalist design and arctic chill.' },
            { id: 'med', title: 'Mediterranean', icon: 'sun', query: ['Nice','Barcelona','Rome','Athens','Dubrovnik'], img: 'coast,summer', desc: 'Azure waters and olive groves.' },
            { id: 'wine', title: 'Wine Regions', icon: 'wine', query: ['Bordeaux','Florence','Cape Town','Mendoza','Napa'], img: 'vineyard,wine', desc: 'Terroirs of the world.' },
            { id: 'mega', title: 'Megacities', icon: 'buildings', query: ['Tokyo','Delhi','Shanghai','Sao Paulo','Cairo'], img: 'crowd,traffic', desc: 'Agglomerations exceeding 10 million people.' },
            { id: 'spiritual', title: 'Sacred Sites', icon: 'hands-praying', query: ['Varanasi','Jerusalem','Mecca','Lhasa','Vatican City'], img: 'temple,prayer', desc: 'Places of pilgrimage and significance.' },
            { id: 'port', title: 'Maritime', icon: 'anchor', query: ['Rotterdam','Hamburg','Singapore','Busan','Panama City'], img: 'ship,port', desc: 'Historic ports connecting the world.' },
            { id: 'music', title: 'Music Cities', icon: 'music-notes', query: ['Nashville','Liverpool','New Orleans','Vienna','Berlin'], img: 'concert,instrument', desc: 'Cities where rhythm is embedded in the streets.' }
        ];

        let DB = [];
        let idCounter = 1;

        function initData() {
            THEMES.forEach(t => {
                t.query.forEach(name => {
                    if(!DB.find(c=>c.name===name)) {
                        let anchor = ANCHORS.find(a => a.n === name);
                        let lat, lng;
                        if(anchor) {
                            lat = anchor.lat;
                            lng = anchor.lng;
                        } else {
                            const randAnchor = ANCHORS[Math.floor(Math.random() * ANCHORS.length)];
                            lat = randAnchor.lat + (Math.random() * 10 - 5);
                            lng = randAnchor.lng + (Math.random() * 10 - 5);
                        }
                        DB.push({ id: idCounter++, name, theme: t.id, lat: lat, lng: lng, year: 2014 + Math.floor(Math.random()*10) });
                    }
                });
            });
            while(DB.length < 170) {
                const randAnchor = ANCHORS[Math.floor(Math.random() * ANCHORS.length)];
                const jLat = randAnchor.lat + (Math.random() * 4 - 2);
                const jLng = randAnchor.lng + (Math.random() * 4 - 2);
                DB.push({ id: idCounter++, name: `Expedition ${idCounter}`, theme: 'gen', lat: jLat, lng: jLng, year: 2014 + Math.floor(Math.random()*10) });
            }
        }
        initData();

        // --- 2. VIEW ENGINE ---
        function setView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-cyan-500/10','text-cyan-400','border','border-cyan-500/20');
                el.classList.add('text-slate-400');
            });
            const btn = document.getElementById(`nav-${id}`);
            btn.classList.add('bg-cyan-500/10','text-cyan-400','border','border-cyan-500/20');
            btn.classList.remove('text-slate-400');

            if(id === 'dashboard') initCharts();
            if(id === 'atlas') {
                setTimeout(() => {
                    initMainMap();
                    if(mapMain) mapMain.invalidateSize();
                }, 100);
            }
            if(id === 'analytics') setTimeout(initDeepAnalytics, 100);
        }

        // --- 3. CHARTS & LISTS ---
        let charts = {};
        function initCharts() {
            const ctxVel = document.getElementById('chart-velocity');
            const years = {}; DB.forEach(c => years[c.year] = (years[c.year]||0)+1);

            if(charts.vel) charts.vel.destroy();
            charts.vel = new Chart(ctxVel, {
                type: 'bar',
                data: {
                    labels: Object.keys(years).sort(),
                    datasets: [{ label: 'Cities', data: Object.values(years), backgroundColor: '#06b6d4', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } } }
            });

            const ctxCont = document.getElementById('chart-continents');
            if(charts.cont) charts.cont.destroy();
            charts.cont = new Chart(ctxCont, {
                type: 'doughnut',
                data: {
                    labels: ['Europe', 'Asia', 'Americas', 'Others'],
                    datasets: [{
                        data: [45, 30, 20, 5],
                        backgroundColor: ['#60a5fa', '#f59e0b', '#f472b6', '#34d399'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } }
                }
            });

            renderList(DB);
        }

        function renderList(data) {
            const list = document.getElementById('recent-list');
            list.innerHTML = '';

            if(data.length === 0) {
                list.innerHTML = '<div class="text-slate-500 text-sm italic py-4">No coordinates found.</div>';
                return;
            }

            data.slice(0, 5).forEach(c => {
                list.innerHTML += `
                    <div onclick="flyToCity(${c.id})" class="flex justify-between items-center py-2 border-b border-white/5 cursor-pointer hover:bg-white/5 transition-colors rounded px-2 group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-cyan-400"><i class="ph-fill ph-airplane-tilt"></i></div>
                            <div>
                                <div class="text-sm font-bold text-white group-hover:text-cyan-400 transition-colors">${c.name}</div>
                                <div class="text-xs text-slate-400">${c.year} Expedition</div>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity">Fly to <i class="ph-bold ph-arrow-right"></i></div>
                    </div>`;
            });
        }

        function flyToCity(id) {
            const city = DB.find(c => c.id === id);
            if(!city) return;

            setView('atlas');

            setTimeout(() => {
                if(mapMain) {
                    mapMain.invalidateSize();
                    mapMain.flyTo([city.lat, city.lng], 6, { duration: 2.0, easeLinearity: 0.25 });

                    setTimeout(() => {
                        L.popup()
                        .setLatLng([city.lat, city.lng])
                        .setContent(`<div class="font-bold text-cyan-500">${city.name}</div><div class="text-xs">Arrival: ${city.year}</div>`)
                        .openOn(mapMain);
                    }, 2000);
                }
            }, 100);
        }

        // --- 4. MAPS (Leaflet) ---
        let mapMain, mapTheme;
        function initMainMap() {
            if(mapMain) return;
            mapMain = L.map('map-main', { zoomControl: false }).setView([20,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapMain);

            const modes = [ {id:'pin', n:'Pins'}, {id:'country', n:'Countries'}, {id:'rel', n:'Religions'} ];
            const box = document.getElementById('atlas-modes');
            box.innerHTML = '';
            modes.forEach(m => {
                box.innerHTML += `<button onclick="setMapMode('${m.id}')" class="w-full text-left px-3 py-2 rounded text-slate-400 hover:text-white hover:bg-white/5 text-xs font-bold uppercase"><i class="ph ph-map-pin mr-2"></i> ${m.n}</button>`;
            });
            setMapMode('pin');
        }

        async function setMapMode(mode) {
            if(!mapMain) return;
            mapMain.eachLayer(l => { if(l instanceof L.CircleMarker || l instanceof L.GeoJSON) mapMain.removeLayer(l); });
            document.getElementById('map-legend').classList.add('hidden');

            if(mode === 'pin') {
                DB.forEach(c => {
                    L.circleMarker([c.lat, c.lng], { radius: 4, fillColor: '#06b6d4', color: 'transparent', fillOpacity: 0.8 })
                    .bindPopup(`<b class="text-cyan-400">${c.name}</b><br><span class="text-slate-300">Visited ${c.year}</span>`)
                    .addTo(mapMain);
                });
            } else {
                try {
                    const res = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
                    const data = await res.json();
                    L.geoJSON(data, {
                        style: (f) => {
                            let col = '#1e293b';
                            if(mode === 'country' && f.properties.name.length % 2 === 0) col = '#06b6d4';
                            if(mode === 'rel') {
                                const code = f.properties.name.charCodeAt(0);
                                if(code%3===0) col='#3b82f6'; if(code%3===1) col='#10b981'; if(code%3===2) col='#f59e0b';
                            }
                            return { fillColor:col, weight:1, color:'#0b0f19', fillOpacity:0.7 };
                        }
                    }).addTo(mapMain);
                    document.getElementById('map-legend').classList.remove('hidden');
                    document.getElementById('legend-content').innerHTML = mode === 'country' ?
                        `<div class="flex gap-2 items-center"><div class="w-3 h-3 bg-cyan-500 rounded"></div> Visited</div>` :
                        `<div class="flex gap-2 items-center"><div class="w-3 h-3 bg-blue-500 rounded"></div> Group A</div>`;
                } catch(e) { console.error(e); }
            }
        }

        // --- 5. ANALYTICS & CARBON CALC ---
        function initDeepAnalytics() {
            // Chart
            const ctxEco = document.getElementById('chart-economy');
            if(charts.eco) charts.eco.destroy();
            charts.eco = new Chart(ctxEco, {
                type: 'pie',
                data: { labels: ['$$$ High', '$$ Med', '$ Low'], datasets: [{ data: [40, 35, 25], backgroundColor: ['#f59e0b', '#06b6d4', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
            });

            // Climate Distribution
            let tropical = 0, temperate = 0, arctic = 0;
            DB.forEach(c => {
                const absLat = Math.abs(c.lat);
                if(absLat < 23.5) tropical++;
                else if(absLat > 66.5) arctic++;
                else temperate++;
            });
            const tPct = Math.round((tropical/DB.length)*100);
            const tmPct = Math.round((temperate/DB.length)*100);
            const aPct = Math.round((arctic/DB.length)*100);

            const bars = document.getElementById('climate-bars');
            bars.innerHTML = `
                <div>
                    <div class="flex justify-between text-sm mb-1"><span>Tropical (< 23.5°)</span> <span class="text-white">${tPct}%</span></div>
                    <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden"><div class="bg-orange-500 h-full transition-all duration-1000" style="width: ${tPct}%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1"><span>Temperate</span> <span class="text-white">${tmPct}%</span></div>
                    <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden"><div class="bg-emerald-500 h-full transition-all duration-1000" style="width: ${tmPct}%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1"><span>Arctic (> 66.5°)</span> <span class="text-white">${aPct}%</span></div>
                    <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden"><div class="bg-cyan-500 h-full transition-all duration-1000" style="width: ${aPct}%"></div></div>
                </div>`;

            // Carbon Footprint Calc
            const R = 6371; // km
            const d2r = d => d * (Math.PI/180);
            const london = { lat: 51.5, lng: -0.1 };

            let totalKm = 0;
            DB.forEach(c => {
                const dLat = d2r(c.lat - london.lat);
                const dLon = d2r(c.lng - london.lng);
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(d2r(london.lat)) * Math.cos(d2r(c.lat)) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const dist = 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                totalKm += (dist * 2); // Round Trip
            });

            document.getElementById('stat-km').innerText = Math.round(totalKm).toLocaleString() + " km";
            document.getElementById('stat-co2').innerText = Math.round(totalKm * 0.15 / 1000).toLocaleString() + " Tons CO2e";

            // --- 10 EXTRA STATS CALCULATION ---
            // 1. Hemisphere Split
            const north = DB.filter(c => c.lat > 0).length;
            const south = DB.length - north;
            const northPct = Math.round((north/DB.length)*100);

            // 2. Active Year
            const years = {}; DB.forEach(c => years[c.year] = (years[c.year]||0)+1);
            const maxYear = Object.keys(years).reduce((a, b) => years[a] > years[b] ? a : b);

            // 3. Top Theme
            const themeCounts = {};
            DB.forEach(c => { if(c.theme !== 'gen') themeCounts[c.theme] = (themeCounts[c.theme]||0)+1; });
            const topThemeId = Object.keys(themeCounts).reduce((a, b) => themeCounts[a] > themeCounts[b] ? a : b, 'finance');
            const topTheme = THEMES.find(t=>t.id===topThemeId).title;

            // 4. Extremes
            const furthestNorth = DB.reduce((prev, curr) => curr.lat > prev.lat ? curr : prev);
            const furthestSouth = DB.reduce((prev, curr) => curr.lat < prev.lat ? curr : prev);

            // 5. Avg Velocity (Cities / Year Range)
            const minYear = Math.min(...DB.map(c=>c.year));
            const range = Math.max(1, 2024 - minYear);
            const velocity = (DB.length / range).toFixed(1);

            // 6. Regional Breaskdown (Approx by Longitude)
            const americas = DB.filter(c => c.lng < -30).length;
            const emea = DB.filter(c => c.lng >= -30 && c.lng < 60).length;
            const apac = DB.filter(c => c.lng >= 60).length;

            // 7. Flight Hours (Approx 800km/h)
            const hours = Math.round(totalKm / 800);

            // Render Grid
            const grid = document.getElementById('stats-grid');
            const createStat = (lbl, val, sub) => `
                <div class="bg-white/5 p-4 rounded-xl border border-white/5 hover:border-cyan-500/30 transition-colors">
                    <div class="text-[10px] uppercase font-bold text-slate-500 mb-1">${lbl}</div>
                    <div class="text-xl font-light text-white truncate">${val}</div>
                    <div class="text-[10px] text-cyan-400 mt-1">${sub}</div>
                </div>`;

            grid.innerHTML = `
                ${createStat('Hemisphere', `${northPct}% North`, `${100-northPct}% South`)}
                ${createStat('Peak Year', maxYear, `${years[maxYear]} Expeditions`)}
                ${createStat('Top Theme', topTheme, `${themeCounts[topThemeId]} Cities`)}
                ${createStat('Furthest North', furthestNorth.name, `${furthestNorth.lat.toFixed(1)}° N`)}
                ${createStat('Furthest South', furthestSouth.name, `${furthestSouth.lat.toFixed(1)}° S`)}
                ${createStat('Avg Velocity', velocity, 'Cities / Year')}
                ${createStat('Americas', americas, 'West Longitude')}
                ${createStat('EMEA Region', emea, 'Central Longitude')}
                ${createStat('APAC Region', apac, 'East Longitude')}
                ${createStat('Flight Time', `${hours} Hrs`, 'Approximate')}
            `;
        }

        // --- 6. THEMES ---
        function renderThemes() {
            const grid = document.getElementById('themes-grid');
            THEMES.forEach(t => {
                const imgUrl = `https://loremflickr.com/600/400/${t.img.split(',')[0]}/all`;
                grid.innerHTML += `
                    <div onclick="openTheme('${t.id}')" class="relative h-64 rounded-2xl overflow-hidden group cursor-pointer border border-white/5 hover:border-cyan-500/50 shadow-lg">
                        <img src="${imgUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-60 group-hover:opacity-40">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-6">
                            <div class="flex items-center gap-3 mb-2"><i class="ph-fill ph-${t.icon} text-cyan-400 text-xl"></i><h4 class="text-xl font-bold text-white">${t.title}</h4></div>
                            <div class="text-xs text-slate-400 line-clamp-2">${t.desc}</div>
                        </div>
                    </div>`;
            });
        }

        let slideInt;
        function openTheme(id) {
            const t = THEMES.find(x=>x.id===id);
            const ov = document.getElementById('theme-overlay');
            ov.classList.remove('hidden'); setTimeout(()=>ov.classList.remove('opacity-0'),10);

            document.getElementById('theme-title').innerText = t.title;
            document.getElementById('theme-desc').innerText = t.desc;
            document.getElementById('theme-icon-lg').innerHTML = `<i class="ph-fill ph-${t.icon}"></i>`;
            document.getElementById('theme-count').innerText = t.query.length;

            const cont = document.getElementById('slideshow-container');
            cont.innerHTML = '<div class="absolute inset-0 bg-gradient-to-r from-slate-950 via-slate-950/90 to-transparent z-10"></div>';

            [t.img.split(',')[0], 'travel', 'landscape'].forEach((src, i) => {
                const img = document.createElement('img');
                img.src = `https://loremflickr.com/1920/1080/${src}/all`;
                img.className = `slide-img ${i===0?'active':''}`; cont.appendChild(img);
            });
            let idx=0; if(slideInt) clearInterval(slideInt);
            slideInt = setInterval(()=>{
                const s = document.querySelectorAll('.slide-img'); s[idx].classList.remove('active');
                idx=(idx+1)%s.length; s[idx].classList.add('active');
            }, 4000);

            setTimeout(()=>{
                if(mapTheme) { mapTheme.remove(); mapTheme=null; }
                mapTheme = L.map('theme-map', {zoomControl:false}).setView([20,0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapTheme);
                DB.filter(c=>t.query.includes(c.name)).forEach(c=>{
                    L.circleMarker([c.lat,c.lng], {radius:5, fillColor:'#fff', color:'#06b6d4', weight:2, fillOpacity:1}).addTo(mapTheme);
                });
            }, 300);
        }

        function closeTheme() {
            const ov = document.getElementById('theme-overlay');
            ov.classList.add('opacity-0'); setTimeout(()=>ov.classList.add('hidden'), 500);
            clearInterval(slideInt);
        }

        function startClock() {
            const clock = document.getElementById('system-clock');
            setInterval(() => {
                const now = new Date();
                const time = now.toISOString().split('T')[1].split('.')[0] + ' UTC';
                clock.innerText = time;
            }, 1000);
        }

        // Init
        window.onload = () => {
            renderThemes();
            initCharts();
            startClock();
            document.getElementById('global-search').addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const filtered = DB.filter(c => c.name.toLowerCase().includes(val));
                renderList(val === '' ? DB : filtered);
            });
        };
    </script>
</body>
</html>
