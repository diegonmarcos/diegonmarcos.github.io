<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioMetrics Pro - Health Tracker</title>
    <link rel="icon" type="image/x-icon" href="../favicon.ico">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: rgba(20, 20, 30, 0.7);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-rose: #f43f5e;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-cyan: #06b6d4;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated gradient background */
        .bg-animated {
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism panels */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
        }

        .glass-inner {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        /* Glow effects */
        .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.3); }
        .glow-purple { box-shadow: 0 0 30px rgba(139, 92, 246, 0.3); }
        .glow-rose { box-shadow: 0 0 30px rgba(244, 63, 94, 0.3); }
        .glow-emerald { box-shadow: 0 0 30px rgba(16, 185, 129, 0.3); }

        /* Input styling */
        .input-styled {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 14px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }

        .input-styled:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* Animations */
        .fade-up {
            animation: fadeUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress bars */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* HR Zone colors */
        .zone-1 { background: linear-gradient(135deg, #10b981, #059669); }
        .zone-2 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .zone-3 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .zone-4 { background: linear-gradient(135deg, #f43f5e, #e11d48); }
        .zone-5 { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        /* Stat cards */
        .stat-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: rgba(255,255,255,0.05);
            transform: translateY(-2px);
        }

        /* Tab buttons */
        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
        }

        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .tab-btn:not(.active) {
            background: transparent;
            color: #64748b;
        }

        .tab-btn:not(.active):hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        /* Delta indicators */
        .delta-positive { color: #10b981; }
        .delta-negative { color: #f43f5e; }
        .delta-neutral { color: #64748b; }

        /* Mono font for numbers */
        .mono { font-family: 'JetBrains Mono', 'SF Mono', monospace; }

        /* Navigation links */
        .nav-link {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            border-radius: 6px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-link:hover {
            color: #e2e8f0;
            background: rgba(255,255,255,0.05);
        }

        .nav-link.active {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }

        /* KPI card */
        .kpi-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 16px 20px;
            text-align: center;
        }

        /* Hierarchy indent */
        .indent-1 { padding-left: 20px; }
        .indent-2 { padding-left: 40px; }
    </style>
</head>
<body class="bg-animated">

<!-- Navigation -->
<nav class="fixed top-0 left-0 right-0 z-50 glass !rounded-none border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 py-2">
        <!-- Top row: Logo + Actions -->
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-white text-sm">BioMetrics<span class="text-blue-400">Pro</span></h1>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="exportData()" class="px-3 py-1.5 text-xs font-medium text-slate-400 hover:text-white transition-colors">Export</button>
                <button onclick="clearData()" class="px-3 py-1.5 text-xs font-medium text-rose-400 hover:text-rose-300 transition-colors">Reset</button>
            </div>
        </div>
        <!-- Bottom row: Section Navigation -->
        <div class="flex items-center gap-1 overflow-x-auto pb-1 scrollbar-hide" id="section-nav">
            <a href="#sec-input" class="nav-link active" data-section="sec-input">Input</a>
            <a href="#sec-composition" class="nav-link" data-section="sec-composition">Body Comp</a>
            <a href="#sec-scenarios" class="nav-link" data-section="sec-scenarios">Scenarios</a>
            <a href="#sec-performance" class="nav-link" data-section="sec-performance">Performance</a>
            <a href="#sec-cardio" class="nav-link" data-section="sec-cardio">Cardio Zones</a>
            <a href="#sec-graphics" class="nav-link" data-section="sec-graphics">Graphics</a>
            <a href="#sec-history" class="nav-link" data-section="sec-history">History</a>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="max-w-7xl mx-auto pt-24 pb-12 px-4 space-y-8">

    <!-- Section 1: Input Data -->
    <section id="sec-input" class="fade-up scroll-mt-24" style="animation-delay: 0.1s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-blue-500 to-purple-500 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">Input Data</h2>
        </div>

        <div class="glass p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                <!-- Measurements -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        Measurements
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Height (cm)</label>
                            <input type="number" id="in-height" value="175" class="input-styled text-center" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Weight (kg)</label>
                            <input type="number" id="in-weight" value="74" step="0.1" class="input-styled text-center" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Waist (cm)</label>
                            <input type="number" id="in-waist" value="84" class="input-styled text-center" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Neck (cm)</label>
                            <input type="number" id="in-neck" value="39" class="input-styled text-center" oninput="calculate()">
                        </div>
                        <div class="col-span-2">
                            <div class="flex items-center gap-2 mb-1">
                                <label class="text-[10px] text-slate-500 uppercase">Water (kg)</label>
                                <button type="button" onclick="autoFillWater()" class="text-[8px] px-1.5 py-0.5 rounded bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30 transition-colors" title="Fill with ~50% of body weight">auto</button>
                            </div>
                            <input type="number" id="in-water" value="" placeholder="Auto ~50%" step="0.1" class="input-styled text-center text-cyan-400" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <!-- Personal -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-purple-400 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Personal
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Age</label>
                            <input type="number" id="in-age" value="38" class="input-styled text-center" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Sex</label>
                            <select id="in-sex" class="input-styled text-center" onchange="calculate()">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Heart Rate -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-rose-400 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                        Heart Rate
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">HR Rest</label>
                            <input type="number" id="in-hr-rest" value="52" class="input-styled text-center text-emerald-400" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">HR Max (calc)</label>
                            <input type="number" id="in-hr-max" value="" placeholder="Auto" class="input-styled text-center text-rose-400" oninput="calculate()">
                        </div>
                    </div>
                </div>

                <!-- Goals -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Goals
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Target Fat %</label>
                            <input type="number" id="in-goal-fat" value="12" step="0.5" class="input-styled text-center text-emerald-400" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 uppercase mb-1">Target Muscle %</label>
                            <input type="number" id="in-goal-muscle" value="40" step="0.5" class="input-styled text-center text-emerald-400" oninput="calculate()">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Quick Actions -->
            <div class="mt-6 pt-4 border-t border-white/5 flex flex-wrap gap-3">
                <button onclick="saveEntry()" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg text-xs font-semibold hover:bg-blue-500/30 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                    Save Today's Entry
                </button>
                <span class="text-xs text-slate-600 self-center" id="last-saved">No data saved yet</span>
            </div>
        </div>
    </section>

    <!-- Section 2: Body Composition -->
    <section id="sec-composition" class="fade-up scroll-mt-24" style="animation-delay: 0.2s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-rose-500 to-orange-500 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">Body Composition</h2>
            <!-- Info Button -->
            <div class="relative group">
                <button class="w-6 h-6 rounded-full bg-slate-700/50 hover:bg-slate-600/50 flex items-center justify-center transition-colors">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                <!-- Tooltip -->
                <div class="absolute left-0 top-8 w-80 p-4 bg-slate-900/95 backdrop-blur border border-white/10 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                    <h5 class="text-sm font-semibold text-amber-400 mb-2">US Navy Body Fat Formula</h5>
                    <p class="text-xs text-slate-400 mb-3">Body fat calculated using the US Navy circumference method with height, waist, and neck measurements.</p>
                    <div class="bg-black/40 rounded-lg p-2 mono text-[10px] text-slate-300">
                        <p class="text-amber-400/80 mb-1">// Male Formula:</p>
                        <p class="break-all">BF% = 495 / (1.0324 - 0.19077 × log₁₀(waist - neck) + 0.15456 × log₁₀(height)) - 450</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass p-6">
            <!-- KPIs Row -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="kpi-card border-l-2 border-amber-500">
                    <p class="text-[10px] text-amber-400 uppercase mb-1">BMI</p>
                    <p id="out-bmi" class="mono text-2xl font-bold text-white">--</p>
                    <p class="text-[10px] text-slate-500">Body Mass Index</p>
                </div>
                <div class="kpi-card border-l-2 border-rose-500">
                    <p class="text-[10px] text-rose-400 uppercase mb-1">Body Fat</p>
                    <p id="out-fat-kpi" class="mono text-2xl font-bold text-white">--%</p>
                    <p class="text-[10px] text-slate-500">US Navy Formula</p>
                </div>
                <div class="kpi-card border-l-2 border-purple-500">
                    <p class="text-[10px] text-purple-400 uppercase mb-1">Muscle</p>
                    <p id="out-muscle-kpi" class="mono text-2xl font-bold text-white">--%</p>
                    <p class="text-[10px] text-slate-500">Estimated</p>
                </div>
            </div>

            <!-- Composition Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left: Breakdown -->
                <div class="space-y-4">
                    <div class="glass-inner p-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-white font-semibold">Total Mass</span>
                            <span id="out-total-mass" class="mono text-2xl font-bold text-white">-- kg</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-inner p-4 border-l-2 border-rose-500">
                            <p class="text-[10px] text-rose-400 uppercase mb-1">Fat Mass</p>
                            <p id="out-fat-mass" class="mono text-xl font-bold text-white">-- kg</p>
                            <p id="out-fat-pct" class="mono text-sm text-rose-400">--%</p>
                        </div>
                        <div class="glass-inner p-4 border-l-2 border-blue-500">
                            <p class="text-[10px] text-blue-400 uppercase mb-1">Lean Mass</p>
                            <p id="out-lean-mass" class="mono text-xl font-bold text-white">-- kg</p>
                            <p id="out-lean-pct" class="mono text-sm text-blue-400">--%</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2">
                        <div class="glass-inner p-2 text-center border-t border-rose-500/30">
                            <p class="text-[9px] text-rose-400 uppercase mb-1">Fat</p>
                            <p id="out-fat-mass-2" class="mono text-sm font-bold text-white">--</p>
                            <p id="out-fat-pct-2" class="mono text-[10px] text-rose-400/70">--%</p>
                        </div>
                        <div class="glass-inner p-2 text-center border-t border-purple-500/30">
                            <p class="text-[9px] text-purple-400 uppercase mb-1">Muscle</p>
                            <p id="out-muscle-mass" class="mono text-sm font-bold text-white">--</p>
                            <p id="out-muscle-pct" class="mono text-[10px] text-purple-400/70">--%</p>
                        </div>
                        <div class="glass-inner p-2 text-center border-t border-cyan-500/30">
                            <p class="text-[9px] text-cyan-400 uppercase mb-1">Water</p>
                            <p id="out-water-mass" class="mono text-sm font-bold text-white">--</p>
                            <p id="out-water-pct" class="mono text-[10px] text-cyan-400/70">--%</p>
                        </div>
                        <div class="glass-inner p-2 text-center border-t border-slate-500/30">
                            <p class="text-[9px] text-slate-400 uppercase mb-1">Bone</p>
                            <p id="out-bone-mass" class="mono text-sm font-bold text-white">--</p>
                            <p id="out-bone-pct" class="mono text-[10px] text-slate-400/70">--%</p>
                        </div>
                    </div>
                </div>

                <!-- Right: Benchmark Rulers -->
                <div class="space-y-5">
                    <!-- Body Fat % Ruler -->
                    <div class="glass-inner p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-xs font-semibold text-rose-400 uppercase">Body Fat %</h4>
                            <span id="fat-ruler-value" class="mono text-sm font-bold text-white">--</span>
                        </div>
                        <!-- Ruler -->
                        <div class="relative">
                            <div class="flex h-8 rounded-lg overflow-hidden">
                                <div class="flex-1 bg-emerald-500/30 border-r border-white/10 flex items-center justify-center text-[9px] font-semibold text-emerald-300/90">Athlete</div>
                                <div class="flex-1 bg-blue-500/30 border-r border-white/10 flex items-center justify-center text-[9px] font-semibold text-blue-300/90">Fitness</div>
                                <div class="flex-1 bg-amber-500/30 border-r border-white/10 flex items-center justify-center text-[9px] font-semibold text-amber-300/90">Average</div>
                                <div class="flex-1 bg-rose-500/30 flex items-center justify-center text-[9px] font-semibold text-rose-300/90">Obese</div>
                            </div>
                            <!-- Marker -->
                            <div id="fat-ruler-marker" class="absolute top-0 w-0.5 h-8 bg-white shadow-lg transition-all duration-500" style="left: 50%">
                                <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-white"></div>
                            </div>
                            <!-- Scale labels -->
                            <div class="flex justify-between mt-1 text-[9px] text-slate-500 mono">
                                <span>6%</span>
                                <span>13%</span>
                                <span>17%</span>
                                <span>24%</span>
                                <span>35%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Muscle % Ruler -->
                    <div class="glass-inner p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-xs font-semibold text-purple-400 uppercase">Muscle %</h4>
                            <span id="muscle-ruler-value" class="mono text-sm font-bold text-white">--</span>
                        </div>
                        <!-- Ruler -->
                        <div class="relative">
                            <div class="flex h-8 rounded-lg overflow-hidden">
                                <div class="flex-1 bg-slate-500/30 border-r border-white/10 flex items-center justify-center text-[9px] font-semibold text-slate-300/90">Low</div>
                                <div class="flex-1 bg-amber-500/30 border-r border-white/10 flex items-center justify-center text-[9px] font-semibold text-amber-300/90">Average</div>
                                <div class="flex-1 bg-blue-500/30 border-r border-white/10 flex items-center justify-center text-[9px] font-semibold text-blue-300/90">Fit</div>
                                <div class="flex-1 bg-emerald-500/30 flex items-center justify-center text-[9px] font-semibold text-emerald-300/90">Athletic</div>
                            </div>
                            <!-- Marker -->
                            <div id="muscle-ruler-marker" class="absolute top-0 w-0.5 h-8 bg-white shadow-lg transition-all duration-500" style="left: 50%">
                                <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-white"></div>
                            </div>
                            <!-- Scale labels -->
                            <div class="flex justify-between mt-1 text-[9px] text-slate-500 mono">
                                <span>20%</span>
                                <span>30%</span>
                                <span>35%</span>
                                <span>40%</span>
                                <span>50%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Section 3: Goal Scenarios -->
    <section id="sec-scenarios" class="fade-up scroll-mt-24" style="animation-delay: 0.3s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-emerald-500 to-teal-500 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">Goal Scenarios</h2>
            <div class="ml-auto flex bg-black/30 p-1 rounded-lg">
                <button id="tab-keep-mass" onclick="setScenario('keepMass')" class="tab-btn active">Keep Mass</button>
                <button id="tab-keep-fat" onclick="setScenario('keepFat')" class="tab-btn">Keep Fat</button>
            </div>
        </div>

        <div class="glass p-6">
            <p class="text-sm text-slate-400 mb-6" id="scenario-desc">
                Projection if you maintain your current total mass and only change body composition.
            </p>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-xs text-slate-500 uppercase border-b border-white/10">
                            <th class="text-left py-3 pr-4">Metric</th>
                            <th class="text-right py-3 px-4">Current</th>
                            <th class="text-right py-3 px-4">Goal</th>
                            <th class="text-right py-3 pl-4">Delta</th>
                        </tr>
                    </thead>
                    <tbody id="scenario-table" class="divide-y divide-white/5">
                        <!-- Populated by JS with hierarchy -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Section 4: Performance -->
    <section id="sec-performance" class="fade-up scroll-mt-24" style="animation-delay: 0.35s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-amber-500 to-orange-500 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">Performance</h2>
        </div>

        <div class="glass p-6">
            <!-- Strength Section with Body Diagram -->
            <div class="mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                    </svg>
                    <h4 class="font-semibold text-white">Strength Benchmarks</h4>
                    <span class="ml-auto text-xs text-slate-500">1RM or best set</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Body Diagram -->
                    <div class="glass-inner p-4 flex items-center justify-center">
                        <svg viewBox="0 0 120 200" class="h-64 w-auto">
                            <!-- Body outline - side view -->
                            <ellipse cx="60" cy="22" rx="18" ry="20" fill="none" stroke="#475569" stroke-width="1.5"/>
                            <!-- Neck -->
                            <line x1="60" y1="42" x2="60" y2="52" stroke="#475569" stroke-width="8"/>
                            <!-- Torso -->
                            <path d="M40 52 Q30 80 35 110 L45 140 L75 140 L85 110 Q90 80 80 52 Z" fill="none" stroke="#475569" stroke-width="1.5"/>
                            <!-- Arms -->
                            <path d="M35 58 Q15 75 20 100 Q18 115 25 130" fill="none" stroke="#475569" stroke-width="6" stroke-linecap="round"/>
                            <path d="M85 58 Q105 75 100 100 Q102 115 95 130" fill="none" stroke="#475569" stroke-width="6" stroke-linecap="round"/>
                            <!-- Legs -->
                            <path d="M50 140 L45 175 L42 195" fill="none" stroke="#475569" stroke-width="8" stroke-linecap="round"/>
                            <path d="M70 140 L75 175 L78 195" fill="none" stroke="#475569" stroke-width="8" stroke-linecap="round"/>

                            <!-- Muscle labels with letters -->
                            <circle cx="60" cy="75" r="6" fill="#f59e0b" opacity="0.8"/><text x="60" y="78" text-anchor="middle" fill="white" font-size="8" font-weight="bold">A</text>
                            <circle cx="27" cy="85" r="6" fill="#3b82f6" opacity="0.8"/><text x="27" y="88" text-anchor="middle" fill="white" font-size="8" font-weight="bold">B</text>
                            <circle cx="93" cy="85" r="6" fill="#3b82f6" opacity="0.8"/><text x="93" y="88" text-anchor="middle" fill="white" font-size="8" font-weight="bold">B</text>
                            <circle cx="60" cy="95" r="6" fill="#10b981" opacity="0.8"/><text x="60" y="98" text-anchor="middle" fill="white" font-size="8" font-weight="bold">C</text>
                            <circle cx="40" cy="60" r="6" fill="#8b5cf6" opacity="0.8"/><text x="40" y="63" text-anchor="middle" fill="white" font-size="8" font-weight="bold">D</text>
                            <circle cx="80" cy="60" r="6" fill="#8b5cf6" opacity="0.8"/><text x="80" y="63" text-anchor="middle" fill="white" font-size="8" font-weight="bold">D</text>
                            <circle cx="60" cy="120" r="6" fill="#ef4444" opacity="0.8"/><text x="60" y="123" text-anchor="middle" fill="white" font-size="8" font-weight="bold">E</text>
                            <circle cx="50" cy="165" r="6" fill="#06b6d4" opacity="0.8"/><text x="50" y="168" text-anchor="middle" fill="white" font-size="8" font-weight="bold">F</text>
                            <circle cx="70" cy="165" r="6" fill="#06b6d4" opacity="0.8"/><text x="70" y="168" text-anchor="middle" fill="white" font-size="8" font-weight="bold">F</text>
                            <circle cx="55" cy="185" r="6" fill="#ec4899" opacity="0.8"/><text x="55" y="188" text-anchor="middle" fill="white" font-size="8" font-weight="bold">G</text>
                        </svg>
                    </div>

                    <!-- Exercise List -->
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-amber-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-amber-500/80 text-[10px] font-bold flex items-center justify-center">A</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Bench Press</p>
                                    <p class="text-[10px] text-slate-500">Chest</p>
                                </div>
                            </div>
                            <input type="number" id="in-bench" value="" placeholder="kg" class="input-styled w-16 text-center text-amber-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-blue-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-blue-500/80 text-[10px] font-bold flex items-center justify-center">B</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Bicep Curl</p>
                                    <p class="text-[10px] text-slate-500">Biceps</p>
                                </div>
                            </div>
                            <input type="number" id="in-curl" value="" placeholder="kg" class="input-styled w-16 text-center text-blue-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-emerald-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-emerald-500/80 text-[10px] font-bold flex items-center justify-center">C</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Deadlift</p>
                                    <p class="text-[10px] text-slate-500">Back / Core</p>
                                </div>
                            </div>
                            <input type="number" id="in-deadlift" value="" placeholder="kg" class="input-styled w-16 text-center text-emerald-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-purple-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-purple-500/80 text-[10px] font-bold flex items-center justify-center">D</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Overhead Press</p>
                                    <p class="text-[10px] text-slate-500">Shoulders</p>
                                </div>
                            </div>
                            <input type="number" id="in-ohp" value="" placeholder="kg" class="input-styled w-16 text-center text-purple-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-red-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-red-500/80 text-[10px] font-bold flex items-center justify-center">E</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Squat</p>
                                    <p class="text-[10px] text-slate-500">Glutes / Core</p>
                                </div>
                            </div>
                            <input type="number" id="in-squat" value="" placeholder="kg" class="input-styled w-16 text-center text-red-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-cyan-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-cyan-500/80 text-[10px] font-bold flex items-center justify-center">F</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Leg Press</p>
                                    <p class="text-[10px] text-slate-500">Quads</p>
                                </div>
                            </div>
                            <input type="number" id="in-legpress" value="" placeholder="kg" class="input-styled w-16 text-center text-cyan-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-pink-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-pink-500/80 text-[10px] font-bold flex items-center justify-center">G</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Calf Raise</p>
                                    <p class="text-[10px] text-slate-500">Calves</p>
                                </div>
                            </div>
                            <input type="number" id="in-calf" value="" placeholder="kg" class="input-styled w-16 text-center text-pink-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-3 bg-black/20 rounded-lg border-l-2 border-slate-500">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-slate-500/80 text-[10px] font-bold flex items-center justify-center">+</span>
                                <div>
                                    <p class="text-sm font-medium text-white">Pull-up / Row</p>
                                    <p class="text-[10px] text-slate-500">Lats / Traps</p>
                                </div>
                            </div>
                            <input type="number" id="in-pullup" value="" placeholder="kg" class="input-styled w-16 text-center text-slate-400 text-sm" oninput="saveState()">
                        </div>
                    </div>
                </div>

                <!-- Big 3 Total -->
                <div class="mt-4 pt-4 border-t border-white/5 flex justify-between items-center">
                    <span class="text-xs text-slate-500">Total (Big 3: Squat + Bench + Deadlift)</span>
                    <span id="out-total-lift" class="mono text-lg font-bold text-amber-400">-- kg</span>
                </div>
            </div>

            <!-- Cardio Section: Aerobic vs Anaerobic -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Aerobic -->
                <div class="glass-inner p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <h4 class="font-semibold text-white">Aerobic</h4>
                        <span class="ml-auto text-[10px] text-emerald-400/60 bg-emerald-500/10 px-2 py-0.5 rounded">Zone 2-3</span>
                    </div>
                    <p class="text-[10px] text-slate-500 mb-3">Low-moderate intensity, fat burning, endurance</p>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-2 bg-black/20 rounded">
                            <span class="text-xs text-slate-400">Power (watts)</span>
                            <input type="number" id="in-power-aerobic" value="" placeholder="W" class="input-styled w-20 text-center text-emerald-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-2 bg-black/20 rounded">
                            <span class="text-xs text-slate-400">Duration (min)</span>
                            <input type="number" id="in-duration-aerobic" value="" placeholder="min" class="input-styled w-20 text-center text-emerald-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-2 bg-black/20 rounded">
                            <span class="text-xs text-slate-400">Avg HR</span>
                            <input type="number" id="in-hr-aerobic" value="" placeholder="bpm" class="input-styled w-20 text-center text-rose-400 text-sm" oninput="saveState()">
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-white/5 flex justify-between items-center">
                        <span class="text-[10px] text-slate-500">Power/Weight</span>
                        <span id="out-power-aerobic" class="mono text-sm font-bold text-emerald-400">-- W/kg</span>
                    </div>
                </div>

                <!-- Anaerobic -->
                <div class="glass-inner p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                        </svg>
                        <h4 class="font-semibold text-white">Anaerobic</h4>
                        <span class="ml-auto text-[10px] text-rose-400/60 bg-rose-500/10 px-2 py-0.5 rounded">Zone 4-5</span>
                    </div>
                    <p class="text-[10px] text-slate-500 mb-3">High intensity, power, VO2 max efforts</p>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-2 bg-black/20 rounded">
                            <span class="text-xs text-slate-400">Power (watts)</span>
                            <input type="number" id="in-power-anaerobic" value="" placeholder="W" class="input-styled w-20 text-center text-rose-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-2 bg-black/20 rounded">
                            <span class="text-xs text-slate-400">Duration (min)</span>
                            <input type="number" id="in-duration-anaerobic" value="" placeholder="min" class="input-styled w-20 text-center text-rose-400 text-sm" oninput="saveState()">
                        </div>
                        <div class="flex items-center justify-between p-2 bg-black/20 rounded">
                            <span class="text-xs text-slate-400">Max HR</span>
                            <input type="number" id="in-hr-anaerobic" value="" placeholder="bpm" class="input-styled w-20 text-center text-rose-400 text-sm" oninput="saveState()">
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-white/5 flex justify-between items-center">
                        <span class="text-[10px] text-slate-500">Power/Weight</span>
                        <span id="out-power-anaerobic" class="mono text-sm font-bold text-rose-400">-- W/kg</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Section 5: Heart Rate Zones -->
    <section id="sec-cardio" class="fade-up scroll-mt-24" style="animation-delay: 0.4s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-rose-500 to-pink-500 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">Cardio Zones</h2>
            <div class="ml-auto glass-inner px-4 py-2 flex items-center gap-4">
                <div class="text-center">
                    <p class="text-[10px] text-slate-500 uppercase">HR Max</p>
                    <p id="out-hr-max" class="mono text-lg font-bold text-rose-400">--</p>
                </div>
                <div class="w-px h-8 bg-white/10"></div>
                <div class="text-center">
                    <p class="text-[10px] text-slate-500 uppercase">HR Reserve</p>
                    <p id="out-hr-reserve" class="mono text-lg font-bold text-emerald-400">--</p>
                </div>
            </div>
        </div>

        <div class="glass p-6">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4" id="hr-zones">
                <!-- Populated by JS -->
            </div>
        </div>
    </section>

    <!-- Section 6: Charts -->
    <section id="sec-graphics" class="fade-up scroll-mt-24" style="animation-delay: 0.5s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">Graphics</h2>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Composition Chart -->
            <div class="glass p-6">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Body Composition</h3>
                <div class="h-64">
                    <canvas id="chart-composition"></canvas>
                </div>
            </div>

            <!-- Progress Chart -->
            <div class="glass p-6">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">12-Week Projection</h3>
                <div class="h-64">
                    <canvas id="chart-progress"></canvas>
                </div>
            </div>
        </div>

        <!-- Historic Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Weight History -->
            <div class="glass p-6">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Weight History</h3>
                <div class="h-48">
                    <canvas id="chart-weight-history"></canvas>
                </div>
            </div>

            <!-- Body Fat History -->
            <div class="glass p-6">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Body Fat % History</h3>
                <div class="h-48">
                    <canvas id="chart-fat-history"></canvas>
                </div>
            </div>

            <!-- Measurements History -->
            <div class="glass p-6">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Measurements History</h3>
                <div class="h-48">
                    <canvas id="chart-measurements-history"></canvas>
                </div>
            </div>

            <!-- Performance History -->
            <div class="glass p-6">
                <h3 class="text-sm font-semibold text-slate-300 mb-4">Strength Progress</h3>
                <div class="h-48">
                    <canvas id="chart-strength-history"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Section 7: History -->
    <section id="sec-history" class="fade-up scroll-mt-24" style="animation-delay: 0.6s">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-8 bg-gradient-to-b from-slate-500 to-slate-600 rounded-full"></div>
            <h2 class="text-xl font-bold text-white">History Log</h2>
            <div class="ml-auto flex bg-black/30 p-1 rounded-lg">
                <button id="tab-body-log" onclick="setHistoryTab('body')" class="tab-btn active">Body</button>
                <button id="tab-perf-log" onclick="setHistoryTab('performance')" class="tab-btn">Performance</button>
            </div>
        </div>

        <!-- Body Composition History -->
        <div id="history-body" class="glass overflow-hidden">
            <div class="p-3 border-b border-white/5 flex justify-between items-center">
                <span class="text-xs text-slate-500" id="history-count">0 entries</span>
                <button onclick="saveEntry()" class="px-3 py-1.5 bg-blue-500/20 text-blue-400 rounded text-xs font-semibold hover:bg-blue-500/30 transition-colors">+ Save Entry</button>
            </div>
            <div class="overflow-x-auto max-h-72">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-slate-900/95 backdrop-blur text-xs text-slate-500 uppercase">
                        <tr>
                            <th class="text-left p-3">Date</th>
                            <th class="text-right p-3">Weight</th>
                            <th class="text-right p-3">Waist</th>
                            <th class="text-right p-3">Neck</th>
                            <th class="text-right p-3">HR Rest</th>
                            <th class="text-right p-3">BMI</th>
                            <th class="text-right p-3">Fat %</th>
                            <th class="text-right p-3">Trend</th>
                        </tr>
                    </thead>
                    <tbody id="history-table" class="divide-y divide-white/5 mono text-slate-300">
                        <tr><td colspan="8" class="p-8 text-center text-slate-600">No entries yet. Save today's data to start tracking!</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance History -->
        <div id="history-performance" class="glass overflow-hidden hidden">
            <div class="p-3 border-b border-white/5 flex justify-between items-center">
                <span class="text-xs text-slate-500" id="perf-history-count">0 entries</span>
                <button onclick="savePerfEntry()" class="px-3 py-1.5 bg-amber-500/20 text-amber-400 rounded text-xs font-semibold hover:bg-amber-500/30 transition-colors">+ Save Performance</button>
            </div>
            <div class="overflow-x-auto max-h-72">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-slate-900/95 backdrop-blur text-xs text-slate-500 uppercase">
                        <tr>
                            <th class="text-left p-3">Date</th>
                            <th class="text-right p-3 text-amber-400">Squat</th>
                            <th class="text-right p-3 text-amber-400">Bench</th>
                            <th class="text-right p-3 text-amber-400">Deadlift</th>
                            <th class="text-right p-3 text-amber-400">Total</th>
                            <th class="text-right p-3 text-cyan-400">Power</th>
                            <th class="text-right p-3 text-cyan-400">Duration</th>
                            <th class="text-right p-3 text-rose-400">HR</th>
                        </tr>
                    </thead>
                    <tbody id="perf-history-table" class="divide-y divide-white/5 mono text-slate-300">
                        <tr><td colspan="8" class="p-8 text-center text-slate-600">No performance entries yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

</main>

<!-- Footer -->
<footer class="border-t border-white/5 py-6 text-center">
    <p class="text-xs text-slate-600">BioMetrics Pro - Health Tracker</p>
</footer>

<script>
// ============================================================
// STATE & CONFIG
// ============================================================
let state = {
    scenario: 'keepMass',
    history: [],
    perfHistory: [],
    historyTab: 'body'
};

let charts = {};

// ============================================================
// CALCULATIONS
// ============================================================
function calculate() {
    // Get inputs
    const height = parseFloat(document.getElementById('in-height').value) || 175;
    const weight = parseFloat(document.getElementById('in-weight').value) || 74;
    const waist = parseFloat(document.getElementById('in-waist').value) || 84;
    const neck = parseFloat(document.getElementById('in-neck').value) || 39;
    const waterInput = parseFloat(document.getElementById('in-water').value);
    const age = parseInt(document.getElementById('in-age').value) || 38;
    const sex = document.getElementById('in-sex').value;
    const hrRest = parseInt(document.getElementById('in-hr-rest').value) || 52;
    let hrMax = parseInt(document.getElementById('in-hr-max').value);
    const goalFat = parseFloat(document.getElementById('in-goal-fat').value) || 12;
    const goalMuscle = parseFloat(document.getElementById('in-goal-muscle').value) || 40;

    // Calculate HR Max if not provided (220 - age)
    if (!hrMax || isNaN(hrMax)) {
        hrMax = 220 - age;
        document.getElementById('in-hr-max').placeholder = hrMax;
    }

    // BMI
    const heightM = height / 100;
    const bmi = weight / (heightM * heightM);
    let bmiCategory = 'Normal';
    let bmiColor = 'text-emerald-400';
    if (bmi < 18.5) { bmiCategory = 'Underweight'; bmiColor = 'text-amber-400'; }
    else if (bmi >= 25 && bmi < 30) { bmiCategory = 'Overweight'; bmiColor = 'text-amber-400'; }
    else if (bmi >= 30) { bmiCategory = 'Obese'; bmiColor = 'text-rose-400'; }

    // US Navy Body Fat % (Male formula)
    let bodyFatPct;
    if (sex === 'male') {
        bodyFatPct = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.15456 * Math.log10(height)) - 450;
    } else {
        // Female formula would need hip measurement, using simplified version
        bodyFatPct = 495 / (1.29579 - 0.35004 * Math.log10(waist + 0 - neck) + 0.22100 * Math.log10(height)) - 450;
    }
    bodyFatPct = Math.max(0, Math.min(50, bodyFatPct)); // Clamp

    // Body Composition
    const fatMass = weight * (bodyFatPct / 100);
    const leanMass = weight - fatMass;
    const leanPct = 100 - bodyFatPct;

    // Estimated components (typical ratios)
    const waterMass = !isNaN(waterInput) && waterInput > 0 ? waterInput : weight * 0.50; // Use input or ~50% of body weight
    const boneMass = weight * 0.035; // ~3.5% of body weight
    const muscleMass = leanMass - waterMass - boneMass;
    const musclePct = (muscleMass / weight) * 100;
    const waterPct = (waterMass / weight) * 100;
    const bonePct = (boneMass / weight) * 100;

    // HR Reserve
    const hrReserve = hrMax - hrRest;

    // Update UI
    updateUI({
        bmi, bmiCategory, bmiColor,
        weight, bodyFatPct, leanPct,
        fatMass, leanMass, muscleMass, waterMass, boneMass,
        musclePct, waterPct, bonePct,
        hrMax, hrRest, hrReserve,
        goalFat, goalMuscle, height
    });

    // Save to localStorage
    saveState();
}

function autoFillWater() {
    const weight = parseFloat(document.getElementById('in-weight').value) || 74;
    const waterValue = (weight * 0.50).toFixed(1);
    document.getElementById('in-water').value = waterValue;
    calculate();
}

function updateUI(data) {
    // KPIs
    document.getElementById('out-bmi').textContent = data.bmi.toFixed(1);
    document.getElementById('out-fat-kpi').textContent = `${data.bodyFatPct.toFixed(1)}%`;
    document.getElementById('out-muscle-kpi').textContent = `${data.musclePct.toFixed(1)}%`;

    // Total Mass
    document.getElementById('out-total-mass').textContent = `${data.weight.toFixed(1)} kg`;

    // Fat
    document.getElementById('out-fat-mass').textContent = `${data.fatMass.toFixed(2)} kg`;
    document.getElementById('out-fat-pct').textContent = `${data.bodyFatPct.toFixed(1)}%`;
    document.getElementById('out-fat-mass-2').textContent = `${data.fatMass.toFixed(1)}`;

    // Lean
    document.getElementById('out-lean-mass').textContent = `${data.leanMass.toFixed(2)} kg`;
    document.getElementById('out-lean-pct').textContent = `${data.leanPct.toFixed(1)}%`;

    // Components (mass and percentages)
    document.getElementById('out-muscle-mass').textContent = `${data.muscleMass.toFixed(1)}`;
    document.getElementById('out-water-mass').textContent = `${data.waterMass.toFixed(1)}`;
    document.getElementById('out-bone-mass').textContent = `${data.boneMass.toFixed(1)}`;

    // Component percentages
    document.getElementById('out-fat-pct-2').textContent = `${data.bodyFatPct.toFixed(1)}%`;
    document.getElementById('out-muscle-pct').textContent = `${data.musclePct.toFixed(1)}%`;
    document.getElementById('out-water-pct').textContent = `${((data.waterMass / data.weight) * 100).toFixed(1)}%`;
    document.getElementById('out-bone-pct').textContent = `${((data.boneMass / data.weight) * 100).toFixed(1)}%`;

    // Update Benchmark Rulers
    updateBenchmarkRulers(data.bodyFatPct, data.musclePct);

    // HR
    document.getElementById('out-hr-max').textContent = data.hrMax;
    document.getElementById('out-hr-reserve').textContent = data.hrReserve;

    // Update HR Zones
    updateHRZones(data.hrMax, data.hrRest);

    // Update Scenarios
    updateScenarios(data);

    // Update Charts
    updateCharts(data);
}

function updateHRZones(hrMax, hrRest) {
    const zones = [
        { name: 'Recovery', pct: [0.50, 0.60], color: 'zone-1', desc: 'Warm-up, cool-down' },
        { name: 'Fat Burn', pct: [0.60, 0.70], color: 'zone-2', desc: 'Aerobic base' },
        { name: 'Cardio', pct: [0.70, 0.80], color: 'zone-3', desc: 'Endurance' },
        { name: 'Threshold', pct: [0.80, 0.90], color: 'zone-4', desc: 'Performance' },
        { name: 'VO2 Max', pct: [0.90, 1.00], color: 'zone-5', desc: 'Max effort' }
    ];

    const container = document.getElementById('hr-zones');
    container.innerHTML = zones.map((z, i) => {
        const hrLow = Math.round(hrMax * z.pct[0]);
        const hrHigh = Math.round(hrMax * z.pct[1]);
        return `
            <div class="${z.color} rounded-xl p-4 text-center text-white">
                <p class="text-xs opacity-80 uppercase mb-1">Zone ${i + 1}</p>
                <p class="font-bold text-lg">${z.name}</p>
                <p class="mono text-2xl font-bold my-2">${hrLow}-${hrHigh}</p>
                <p class="text-[10px] opacity-70">${z.desc}</p>
            </div>
        `;
    }).join('');
}

function updateScenarios(data) {
    const tbody = document.getElementById('scenario-table');
    const descEl = document.getElementById('scenario-desc');

    let goalWeight, goalFatMass, goalLeanMass, goalMuscleMass, goalWaterMass, goalBoneMass;

    if (state.scenario === 'keepMass') {
        // Keep total mass, change composition
        goalWeight = data.weight;
        goalFatMass = goalWeight * (data.goalFat / 100);
        goalLeanMass = goalWeight - goalFatMass;
        goalMuscleMass = goalWeight * (data.goalMuscle / 100);
        goalWaterMass = goalWeight * 0.50;
        goalBoneMass = goalWeight * 0.035;
        descEl.textContent = 'Projection if you maintain your current total mass and only change body composition (recomp).';
    } else {
        // Keep fat mass, change total weight
        goalFatMass = data.fatMass;
        goalWeight = goalFatMass / (data.goalFat / 100);
        goalLeanMass = goalWeight - goalFatMass;
        goalMuscleMass = goalWeight * (data.goalMuscle / 100);
        goalWaterMass = goalWeight * 0.50;
        goalBoneMass = goalWeight * 0.035;
        descEl.textContent = 'Projection if you keep your current fat mass and build muscle (bulk).';
    }

    // Hierarchical rows with indent levels
    const rows = [
        { name: 'Body Fat %', current: data.bodyFatPct, goal: data.goalFat, unit: '%', inverse: true, level: 0, highlight: true },
        { name: 'Muscle %', current: data.musclePct, goal: data.goalMuscle, unit: '%', level: 0, highlight: true },
        { name: 'Total Mass', current: data.weight, goal: goalWeight, unit: 'kg', level: 0, header: true },
        { name: 'Fat Mass', current: data.fatMass, goal: goalFatMass, unit: 'kg', inverse: true, level: 1 },
        { name: 'Lean Mass', current: data.leanMass, goal: goalLeanMass, unit: 'kg', level: 1 },
        { name: 'Muscle', current: data.muscleMass, goal: goalMuscleMass, unit: 'kg', level: 2 },
        { name: 'Water', current: data.waterMass, goal: goalWaterMass, unit: 'kg', level: 2 },
        { name: 'Bone', current: data.boneMass, goal: goalBoneMass, unit: 'kg', level: 2 }
    ];

    tbody.innerHTML = rows.map(row => {
        const delta = row.goal - row.current;
        const sign = delta > 0 ? '+' : '';
        let colorClass = 'delta-neutral';

        if (row.inverse) {
            colorClass = delta < 0 ? 'delta-positive' : (delta > 0 ? 'delta-negative' : 'delta-neutral');
        } else {
            colorClass = delta > 0 ? 'delta-positive' : (delta < 0 ? 'delta-negative' : 'delta-neutral');
        }

        // Indent and style based on level
        const indent = row.level === 1 ? 'pl-4' : row.level === 2 ? 'pl-8' : '';
        const nameStyle = row.header ? 'font-semibold text-white' : row.highlight ? 'font-semibold text-emerald-400' : row.level > 0 ? 'text-slate-500' : 'text-slate-300';
        const prefix = row.level === 1 ? '<span class="text-slate-600 mr-1">└</span>' : row.level === 2 ? '<span class="text-slate-700 mr-1">└</span>' : '';

        return `
            <tr class="hover:bg-white/5 transition-colors ${row.header ? 'bg-white/[0.02]' : ''}">
                <td class="py-2 pr-4 ${indent} ${nameStyle}">${prefix}${row.name}</td>
                <td class="py-2 px-4 text-right mono text-slate-400 ${row.level > 0 ? 'text-xs' : ''}">${row.current.toFixed(1)} ${row.unit}</td>
                <td class="py-2 px-4 text-right mono text-blue-400 font-semibold ${row.level > 0 ? 'text-xs' : ''}">${row.goal.toFixed(1)} ${row.unit}</td>
                <td class="py-2 pl-4 text-right mono font-bold ${colorClass} ${row.level > 0 ? 'text-xs' : ''}">${sign}${delta.toFixed(1)}</td>
            </tr>
        `;
    }).join('');
}

function setScenario(scenario) {
    state.scenario = scenario;

    document.getElementById('tab-keep-mass').className = scenario === 'keepMass' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('tab-keep-fat').className = scenario === 'keepFat' ? 'tab-btn active' : 'tab-btn';

    calculate();
}

// ============================================================
// CHARTS
// ============================================================
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } },
        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } }
    },
    plugins: {
        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } }
    }
};

function initCharts() {
    // Composition Doughnut
    const ctxComp = document.getElementById('chart-composition').getContext('2d');
    charts.composition = new Chart(ctxComp, {
        type: 'doughnut',
        data: {
            labels: ['Fat', 'Muscle', 'Water', 'Bone'],
            datasets: [{
                data: [15, 35, 40, 10],
                backgroundColor: ['#f43f5e', '#3b82f6', '#06b6d4', '#64748b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 11 } } }
            }
        }
    });

    // Progress Line Chart
    const ctxProgress = document.getElementById('chart-progress').getContext('2d');
    charts.progress = new Chart(ctxProgress, {
        type: 'line',
        data: {
            labels: ['Now', 'W2', 'W4', 'W6', 'W8', 'W10', 'W12'],
            datasets: [
                { label: 'Body Fat %', data: [], borderColor: '#f43f5e', backgroundColor: 'rgba(244,63,94,0.1)', borderWidth: 2, fill: true, tension: 0.4 },
                { label: 'Muscle %', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', borderWidth: 2, fill: true, tension: 0.4 }
            ]
        },
        options: chartOptions
    });

    // Weight History Chart
    const ctxWeight = document.getElementById('chart-weight-history').getContext('2d');
    charts.weightHistory = new Chart(ctxWeight, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{ label: 'Weight (kg)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 3 }]
        },
        options: chartOptions
    });

    // Body Fat History Chart
    const ctxFat = document.getElementById('chart-fat-history').getContext('2d');
    charts.fatHistory = new Chart(ctxFat, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{ label: 'Body Fat %', data: [], borderColor: '#f43f5e', backgroundColor: 'rgba(244,63,94,0.1)', borderWidth: 2, fill: true, tension: 0.3, pointRadius: 3 }]
        },
        options: chartOptions
    });

    // Measurements History Chart
    const ctxMeas = document.getElementById('chart-measurements-history').getContext('2d');
    charts.measurementsHistory = new Chart(ctxMeas, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Waist (cm)', data: [], borderColor: '#f59e0b', borderWidth: 2, tension: 0.3, pointRadius: 3 },
                { label: 'Neck (cm)', data: [], borderColor: '#8b5cf6', borderWidth: 2, tension: 0.3, pointRadius: 3 }
            ]
        },
        options: chartOptions
    });

    // Strength History Chart
    const ctxStrength = document.getElementById('chart-strength-history').getContext('2d');
    charts.strengthHistory = new Chart(ctxStrength, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Squat', data: [], borderColor: '#ef4444', borderWidth: 2, tension: 0.3, pointRadius: 3 },
                { label: 'Bench', data: [], borderColor: '#f59e0b', borderWidth: 2, tension: 0.3, pointRadius: 3 },
                { label: 'Deadlift', data: [], borderColor: '#10b981', borderWidth: 2, tension: 0.3, pointRadius: 3 }
            ]
        },
        options: chartOptions
    });
}

function updateHistoricCharts() {
    // Get last 20 entries (oldest to newest for chart)
    const bodyData = [...state.history].reverse().slice(-20);
    const perfData = [...state.perfHistory].reverse().slice(-20);

    const bodyLabels = bodyData.map(e => new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    const perfLabels = perfData.map(e => new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

    // Weight History
    if (charts.weightHistory) {
        charts.weightHistory.data.labels = bodyLabels;
        charts.weightHistory.data.datasets[0].data = bodyData.map(e => e.weight);
        charts.weightHistory.update();
    }

    // Body Fat History
    if (charts.fatHistory) {
        charts.fatHistory.data.labels = bodyLabels;
        charts.fatHistory.data.datasets[0].data = bodyData.map(e => e.fatPct);
        charts.fatHistory.update();
    }

    // Measurements History
    if (charts.measurementsHistory) {
        charts.measurementsHistory.data.labels = bodyLabels;
        charts.measurementsHistory.data.datasets[0].data = bodyData.map(e => e.waist || null);
        charts.measurementsHistory.data.datasets[1].data = bodyData.map(e => e.neck || null);
        charts.measurementsHistory.update();
    }

    // Strength History
    if (charts.strengthHistory) {
        charts.strengthHistory.data.labels = perfLabels;
        charts.strengthHistory.data.datasets[0].data = perfData.map(e => e.squat || null);
        charts.strengthHistory.data.datasets[1].data = perfData.map(e => e.bench || null);
        charts.strengthHistory.data.datasets[2].data = perfData.map(e => e.deadlift || null);
        charts.strengthHistory.update();
    }
}

function updateCharts(data) {
    // Update composition chart
    charts.composition.data.datasets[0].data = [
        data.bodyFatPct,
        data.musclePct,
        data.waterPct,
        data.bonePct
    ];
    charts.composition.update();

    // Update progress chart (12-week projection)
    const steps = 7;
    const fatData = [];
    const muscleData = [];

    for (let i = 0; i < steps; i++) {
        const progress = i / (steps - 1);
        fatData.push(data.bodyFatPct + (data.goalFat - data.bodyFatPct) * progress);
        muscleData.push(data.musclePct + (data.goalMuscle - data.musclePct) * progress);
    }

    charts.progress.data.datasets[0].data = fatData;
    charts.progress.data.datasets[1].data = muscleData;
    charts.progress.update();
}

// ============================================================
// HISTORY & PERSISTENCE
// ============================================================
function saveEntry() {
    const entry = {
        date: new Date().toISOString(),
        weight: parseFloat(document.getElementById('in-weight').value),
        height: parseFloat(document.getElementById('in-height').value),
        waist: parseFloat(document.getElementById('in-waist').value),
        neck: parseFloat(document.getElementById('in-neck').value),
        age: parseInt(document.getElementById('in-age').value),
        hrRest: parseInt(document.getElementById('in-hr-rest').value)
    };

    // Calculate derived values
    const heightM = entry.height / 100;
    entry.bmi = entry.weight / (heightM * heightM);
    entry.fatPct = 495 / (1.0324 - 0.19077 * Math.log10(entry.waist - entry.neck) + 0.15456 * Math.log10(entry.height)) - 450;
    entry.fatPct = Math.max(0, Math.min(50, entry.fatPct));
    entry.fatMass = entry.weight * (entry.fatPct / 100);
    entry.leanMass = entry.weight - entry.fatMass;

    state.history.unshift(entry);

    // Keep only last 100 entries
    if (state.history.length > 100) state.history.pop();

    saveState();
    renderHistory();

    document.getElementById('last-saved').textContent = `Saved: ${new Date().toLocaleString()}`;
}

function renderHistory() {
    const tbody = document.getElementById('history-table');
    const countEl = document.getElementById('history-count');

    countEl.textContent = `${state.history.length} entries`;

    if (state.history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-600">No entries yet. Save today\'s data to start tracking!</td></tr>';
        return;
    }

    tbody.innerHTML = state.history.map((entry, idx) => {
        const date = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });

        // Trend compared to next entry (older)
        let trend = '';
        if (idx < state.history.length - 1) {
            const prev = state.history[idx + 1];
            if (entry.weight < prev.weight) trend = '<span class="text-emerald-400">↓</span>';
            else if (entry.weight > prev.weight) trend = '<span class="text-rose-400">↑</span>';
            else trend = '<span class="text-slate-500">→</span>';
        }

        return `
            <tr class="hover:bg-white/5 transition-colors">
                <td class="p-3 text-slate-400">${date}</td>
                <td class="p-3 text-right font-bold text-white">${entry.weight.toFixed(1)}</td>
                <td class="p-3 text-right text-slate-400">${entry.waist || '--'}</td>
                <td class="p-3 text-right text-slate-400">${entry.neck || '--'}</td>
                <td class="p-3 text-right text-emerald-400">${entry.hrRest || '--'}</td>
                <td class="p-3 text-right">${entry.bmi.toFixed(1)}</td>
                <td class="p-3 text-right text-rose-400">${entry.fatPct.toFixed(1)}%</td>
                <td class="p-3 text-right">${trend}</td>
            </tr>
        `;
    }).join('');

    // Update historic charts
    updateHistoricCharts();
}

function setHistoryTab(tab) {
    state.historyTab = tab;

    document.getElementById('tab-body-log').className = tab === 'body' ? 'tab-btn active' : 'tab-btn';
    document.getElementById('tab-perf-log').className = tab === 'performance' ? 'tab-btn active' : 'tab-btn';

    document.getElementById('history-body').classList.toggle('hidden', tab !== 'body');
    document.getElementById('history-performance').classList.toggle('hidden', tab !== 'performance');
}

function savePerfEntry() {
    const entry = {
        date: new Date().toISOString(),
        squat: parseFloat(document.getElementById('in-squat').value) || 0,
        bench: parseFloat(document.getElementById('in-bench').value) || 0,
        deadlift: parseFloat(document.getElementById('in-deadlift').value) || 0,
        curl: parseFloat(document.getElementById('in-curl').value) || 0,
        ohp: parseFloat(document.getElementById('in-ohp').value) || 0,
        legpress: parseFloat(document.getElementById('in-legpress').value) || 0,
        calf: parseFloat(document.getElementById('in-calf').value) || 0,
        pullup: parseFloat(document.getElementById('in-pullup').value) || 0,
        powerAerobic: parseFloat(document.getElementById('in-power-aerobic').value) || 0,
        durationAerobic: parseFloat(document.getElementById('in-duration-aerobic').value) || 0,
        hrAerobic: parseFloat(document.getElementById('in-hr-aerobic').value) || 0,
        powerAnaerobic: parseFloat(document.getElementById('in-power-anaerobic').value) || 0,
        durationAnaerobic: parseFloat(document.getElementById('in-duration-anaerobic').value) || 0,
        hrAnaerobic: parseFloat(document.getElementById('in-hr-anaerobic').value) || 0
    };

    entry.total = entry.squat + entry.bench + entry.deadlift;

    state.perfHistory.unshift(entry);

    if (state.perfHistory.length > 100) state.perfHistory.pop();

    saveState();
    renderPerfHistory();
}

function renderPerfHistory() {
    const tbody = document.getElementById('perf-history-table');
    const countEl = document.getElementById('perf-history-count');

    countEl.textContent = `${state.perfHistory.length} entries`;

    if (state.perfHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-600">No performance entries yet.</td></tr>';
        return;
    }

    tbody.innerHTML = state.perfHistory.map((entry) => {
        const date = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });

        return `
            <tr class="hover:bg-white/5 transition-colors">
                <td class="p-3 text-slate-400">${date}</td>
                <td class="p-3 text-right text-amber-400">${entry.squat || '--'}</td>
                <td class="p-3 text-right text-amber-400">${entry.bench || '--'}</td>
                <td class="p-3 text-right text-amber-400">${entry.deadlift || '--'}</td>
                <td class="p-3 text-right font-bold text-amber-300">${entry.total || '--'}</td>
                <td class="p-3 text-right text-cyan-400">${entry.powerAerobic || '--'}</td>
                <td class="p-3 text-right text-cyan-400">${entry.durationAerobic || '--'}</td>
                <td class="p-3 text-right text-rose-400">${entry.hrAerobic || '--'}</td>
            </tr>
        `;
    }).join('');

    updateHistoricCharts();
}

function saveState() {
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : '';
    };

    const inputs = {
        height: getVal('in-height'),
        weight: getVal('in-weight'),
        waist: getVal('in-waist'),
        neck: getVal('in-neck'),
        water: getVal('in-water'),
        age: getVal('in-age'),
        sex: getVal('in-sex'),
        hrRest: getVal('in-hr-rest'),
        hrMax: getVal('in-hr-max'),
        goalFat: getVal('in-goal-fat'),
        goalMuscle: getVal('in-goal-muscle'),
        // Strength
        squat: getVal('in-squat'),
        bench: getVal('in-bench'),
        deadlift: getVal('in-deadlift'),
        curl: getVal('in-curl'),
        ohp: getVal('in-ohp'),
        legpress: getVal('in-legpress'),
        calf: getVal('in-calf'),
        pullup: getVal('in-pullup'),
        // Aerobic
        powerAerobic: getVal('in-power-aerobic'),
        durationAerobic: getVal('in-duration-aerobic'),
        hrAerobic: getVal('in-hr-aerobic'),
        // Anaerobic
        powerAnaerobic: getVal('in-power-anaerobic'),
        durationAnaerobic: getVal('in-duration-anaerobic'),
        hrAnaerobic: getVal('in-hr-anaerobic')
    };

    localStorage.setItem('bioMetricsState', JSON.stringify({
        inputs,
        history: state.history,
        perfHistory: state.perfHistory,
        scenario: state.scenario
    }));

    // Update performance display
    updatePerformance();
}

function loadState() {
    const saved = localStorage.getItem('bioMetricsState');
    if (saved) {
        try {
            const data = JSON.parse(saved);

            // Restore inputs
            if (data.inputs) {
                const fieldMap = {
                    'height': 'in-height',
                    'weight': 'in-weight',
                    'waist': 'in-waist',
                    'neck': 'in-neck',
                    'water': 'in-water',
                    'age': 'in-age',
                    'sex': 'in-sex',
                    'hrRest': 'in-hr-rest',
                    'hrMax': 'in-hr-max',
                    'goalFat': 'in-goal-fat',
                    'goalMuscle': 'in-goal-muscle',
                    'squat': 'in-squat',
                    'bench': 'in-bench',
                    'deadlift': 'in-deadlift',
                    'curl': 'in-curl',
                    'ohp': 'in-ohp',
                    'legpress': 'in-legpress',
                    'calf': 'in-calf',
                    'pullup': 'in-pullup',
                    'powerAerobic': 'in-power-aerobic',
                    'durationAerobic': 'in-duration-aerobic',
                    'hrAerobic': 'in-hr-aerobic',
                    'powerAnaerobic': 'in-power-anaerobic',
                    'durationAnaerobic': 'in-duration-anaerobic',
                    'hrAnaerobic': 'in-hr-anaerobic'
                };

                Object.entries(data.inputs).forEach(([key, val]) => {
                    const elId = fieldMap[key];
                    if (elId) {
                        const el = document.getElementById(elId);
                        if (el && val) el.value = val;
                    }
                });
            }

            // Restore history
            if (data.history) state.history = data.history;

            // Restore performance history
            if (data.perfHistory) state.perfHistory = data.perfHistory;

            // Restore scenario
            if (data.scenario) {
                state.scenario = data.scenario;
                setScenario(data.scenario);
            }
        } catch (e) {
            console.error('Failed to load state:', e);
        }
    }
}

function exportData() {
    const data = {
        exportDate: new Date().toISOString(),
        history: state.history
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `biometrics-export-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function clearData() {
    if (confirm('Are you sure you want to clear all saved data?')) {
        localStorage.removeItem('bioMetricsState');
        state.history = [];
        renderHistory();
        location.reload();
    }
}

// ============================================================
// BENCHMARK RULERS
// ============================================================
function updateBenchmarkRulers(fatPct, musclePct) {
    // Body Fat ruler: 6% to 35% range
    // Zones: Athlete 6-13 (0-25%), Fitness 13-17 (25-38%), Average 17-24 (38-62%), Obese 24-35 (62-100%)
    const fatMin = 6, fatMax = 35;
    const fatPos = Math.max(0, Math.min(100, ((fatPct - fatMin) / (fatMax - fatMin)) * 100));

    document.getElementById('fat-ruler-value').textContent = `${fatPct.toFixed(1)}%`;
    document.getElementById('fat-ruler-marker').style.left = `${fatPos}%`;

    // Muscle ruler: 20% to 50% range
    // Zones: Low 20-30 (0-33%), Average 30-35 (33-50%), Fit 35-40 (50-67%), Athletic 40-50 (67-100%)
    const muscleMin = 20, muscleMax = 50;
    const musclePos = Math.max(0, Math.min(100, ((musclePct - muscleMin) / (muscleMax - muscleMin)) * 100));

    document.getElementById('muscle-ruler-value').textContent = `${musclePct.toFixed(1)}%`;
    document.getElementById('muscle-ruler-marker').style.left = `${musclePos}%`;
}

// ============================================================
// PERFORMANCE
// ============================================================
function updatePerformance() {
    const squat = parseFloat(document.getElementById('in-squat').value) || 0;
    const bench = parseFloat(document.getElementById('in-bench').value) || 0;
    const deadlift = parseFloat(document.getElementById('in-deadlift').value) || 0;
    const powerAerobic = parseFloat(document.getElementById('in-power-aerobic').value) || 0;
    const powerAnaerobic = parseFloat(document.getElementById('in-power-anaerobic').value) || 0;
    const weight = parseFloat(document.getElementById('in-weight').value) || 74;

    // Total lift (Big 3)
    const totalLift = squat + bench + deadlift;
    document.getElementById('out-total-lift').textContent = totalLift > 0 ? `${totalLift} kg` : '-- kg';

    // Power/weight ratios
    const powerRatioAerobic = powerAerobic / weight;
    const powerRatioAnaerobic = powerAnaerobic / weight;
    document.getElementById('out-power-aerobic').textContent = powerAerobic > 0 ? `${powerRatioAerobic.toFixed(2)} W/kg` : '-- W/kg';
    document.getElementById('out-power-anaerobic').textContent = powerAnaerobic > 0 ? `${powerRatioAnaerobic.toFixed(2)} W/kg` : '-- W/kg';
}

// ============================================================
// SCROLL HIGHLIGHTING
// ============================================================
function initScrollHighlight() {
    const sections = document.querySelectorAll('section[id^="sec-"]');
    const navLinks = document.querySelectorAll('.nav-link');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.id;
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-section') === id) {
                        link.classList.add('active');
                    }
                });
            }
        });
    }, {
        rootMargin: '-20% 0px -70% 0px',
        threshold: 0
    });

    sections.forEach(section => observer.observe(section));
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    initCharts();
    initScrollHighlight();
    calculate();
    updatePerformance();
    renderHistory();
    renderPerfHistory();
    updateHistoricCharts();
});
</script>

</body>
</html>
