name: GitHub Pages Deployment (Static Files)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      # ============================================
      # SASS COMPILATION
      # ============================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ¨ Build CSS from Sass (Root)
        run: |
          echo "ğŸ“ Building root Sass..."
          cd 1.ops
          npm install
          npm run sass:build
          cd ..
          echo "âœ… Root style.css created"
          ls -lh style.css

      - name: ğŸ¨ Build CSS from Sass (cv_web)
        run: |
          echo "ğŸ“ Building cv_web Sass..."
          cd cv_web
          npm install
          npm run build
          cd ..
          echo "âœ… cv_web/style.css created"
          ls -lh cv_web/style.css

      # ============================================
      # MYFEED VUE APP BUILD
      # ============================================
      - name: ğŸš€ Build MyFeed Vue Application
        run: |
          echo "ğŸ“ Building MyFeed Vue app..."
          cd myfeed
          npm install
          npm run build
          cd ..
          echo "âœ… MyFeed production build created"
          ls -lh myfeed/dist/

      # ============================================
      # MYPROFILE SVELTEKIT APP BUILD
      # ============================================
      - name: ğŸ® Build MyGames SvelteKit Application
        run: |
          echo "ğŸ“ Building MyGames SvelteKit app..."
          cd mygames/1.1.ops
          chmod +x build.sh
          ./build.sh
          cd ../..
          echo "âœ… MyGames production build created"
          ls -lh mygames/1.3.svelte/build/
        env:
          NODE_ENV: production

      # ============================================
      # DEPLOYMENT PREPARATION
      # ============================================
      - name: ğŸŒ Setup Pages Environment
        uses: actions/configure-pages@v5

      - name: ğŸ“‚ Prepare Site for Deployment
        run: |
          echo "ğŸ“‹ Creating _site directory and copying all files..."
          mkdir -p _site

          # Create .nojekyll to prevent GitHub Pages from processing as Jekyll
          touch _site/.nojekyll
          echo "âœ… Created .nojekyll file"

          # Copy root files
          echo "Copying root HTML, CSS, and JS files..."
          cp -v index.html _site/ 2>/dev/null || true
          cp -v *.css _site/ 2>/dev/null || true
          cp -v *.js _site/ 2>/dev/null || true

          # Copy static directories
          echo "Copying static directories..."
          cp -r linktree _site/ 2>/dev/null || true
          cp -r cv_web _site/ 2>/dev/null || true
          cp -r cv_pdf _site/ 2>/dev/null || true
          cp -r 2.assets _site/assets 2>/dev/null || true
          cp -r others _site/ 2>/dev/null || true

          # Copy MyFeed Vue app build
          echo "Copying MyFeed app..."
          mkdir -p _site/myfeed
          cp -r myfeed/dist/* _site/myfeed/
          echo "âœ… MyFeed deployed to _site/myfeed/"
          ls -lah _site/myfeed/

          # Copy MyGames SvelteKit app build
          echo "Copying MyGames app..."
          mkdir -p _site/mygames
          cp -r mygames/1.3.svelte/build/* _site/mygames/
          echo "âœ… MyGames deployed to _site/mygames/"
          ls -lah _site/mygames/

          echo "âœ… All files prepared for deployment"
          echo "ğŸ“‹ Final site structure:"
          ls -lah _site/

      - name: â¬†ï¸ Upload Site Artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
