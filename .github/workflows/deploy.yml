name: GitHub Pages Deployment (CI)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to compare changes

      - name: ğŸ“‚ Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v41

      # ============================================
      # SASS COMPILATION (Conditional)
      # ============================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            src_static/scss/package-lock.json
            cv_web/src_static/scss/package-lock.json
            src_static/typescript/package-lock.json

      - name: ğŸ¨ Build CSS from Sass (Root)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'src_static/scss/')
        run: |
          echo "ğŸ“ Building root Sass..."
          cd src_static/scss
          npm install
          npm run sass:build
          cd ../..
          echo "âœ… Root style.css created"

      - name: ğŸ¨ Build CSS from Sass (cv_web)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'cv_web/src_static/scss/')
        run: |
          echo "ğŸ“ Building cv_web Sass..."
          cd cv_web/src_static/scss
          npm install
          npm run sass:build
          cd ../../..
          echo "âœ… cv_web/style.css created"

      # ============================================
      # TYPESCRIPT COMPILATION (Conditional)
      # ============================================
      - name: ğŸ“œ Build JS from TypeScript
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'src_static/typescript/')
        run: |
          echo "ğŸ“œ Building TypeScript..."
          cd src_static/typescript
          npm install
          npm run ts:build
          cd ../..
          echo "âœ… script.js created"

      # ============================================
      # MYFEED BUILD (Vue 3 + Vite - Conditional)
      # ============================================
      - name: ğŸ”¨ Build MyFeed (Vue 3 + Vite)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'myfeed/')
        run: |
          echo "ğŸ”¨ Building MyFeed Vue application..."
          cd myfeed
          npm install
          npm run build
          echo "âœ… MyFeed Vue build complete"

      - name: ğŸ”¨ Build MyProfile (SvelteKit)
        run: |
          echo "ğŸ”¨ Building MyProfile SvelteKit project..."
          cd myprofile/1.3.svelte
          npm install
          npm run build
          cd ../..
          echo "âœ… MyProfile build complete"

      - name: ğŸ”¨ Build Nexus (Vue 3 + Tailwind)
        run: |
          echo "ğŸ”¨ Building Nexus Holdings application..."
          cd nexus
          npm install
          npm run build
          cd ..
          echo "âœ… Nexus build complete"

      - name: ğŸ”¨ Build Cloud Dashboard (Sass + TypeScript)
        run: |
          echo "ğŸ”¨ Building Cloud Dashboard..."
          cd cloud
          npm install
          npm run build
          cd ..
          echo "âœ… Cloud Dashboard build complete"

      - name: ğŸ”¨ Build Feed Yourself (Static HTML)
        run: |
          echo "ğŸ”¨ Building Feed Yourself application..."
          cd feed_yourself/1.ops
          bash build.sh build
          cd ../..
          echo "âœ… Feed Yourself build complete"

      - name: ğŸŒ Setup Pages Environment
        uses: actions/configure-pages@v5

      - name: ğŸ“‚ Prepare Site for Deployment
        run: |
          echo "ğŸ“‹ Creating _site directory and copying all files..."
          mkdir -p _site
          # Copy all relevant files and directories (excluding myfeed for now)
          cp -r index.html style.css script.js linktree/ cv_web/ cv_pdf/ 2.assets/ others/ _site/ 2>/dev/null || true

          # Copy Matomo tracking scripts
          if [ -d "1.ops/matomo-tracking" ]; then
            echo "ğŸ“Š Copying Matomo tracking scripts..."
            mkdir -p _site/1.ops/matomo-tracking
            cp -r 1.ops/matomo-tracking/* _site/1.ops/matomo-tracking/
            echo "âœ… Matomo tracking scripts copied"
          fi

          # Copy MyFeed Vue build (if dist exists)
          if [ -d "myfeed/dist" ]; then
            echo "ğŸ“¦ Copying MyFeed Vue build..."
            mkdir -p _site/myfeed
            cp -r myfeed/dist/* _site/myfeed/
            echo "âœ… MyFeed Vue build copied to _site/myfeed/"
          else
            echo "â­ï¸  Skipping MyFeed copy (no dist directory found)"
          fi

          # Copy MyProfile SvelteKit build (if build exists)
          if [ -d "myprofile/1.3.svelte/build" ]; then
            echo "ğŸ“¦ Copying MyProfile SvelteKit build..."
            mkdir -p _site/myprofile
            cp -r myprofile/1.3.svelte/build/* _site/myprofile/
            echo "âœ… MyProfile build copied to _site/myprofile/"
          else
            echo "â­ï¸  Skipping MyProfile copy (no build directory found)"
          fi

          # Copy Nexus Vue build (if dist exists)
          if [ -d "nexus/dist" ]; then
            echo "ğŸ“¦ Copying Nexus Holdings build..."
            mkdir -p _site/nexus
            cp -r nexus/dist/* _site/nexus/
            echo "âœ… Nexus build copied to _site/nexus/"
          else
            echo "â­ï¸  Skipping Nexus copy (no dist directory found)"
          fi

          # Copy Cloud Dashboard build (if dist exists)
          if [ -d "cloud/dist" ]; then
            echo "ğŸ“¦ Copying Cloud Dashboard build..."
            mkdir -p _site/cloud
            cp -r cloud/dist/* _site/cloud/
            echo "âœ… Cloud Dashboard build copied to _site/cloud/"
          else
            echo "â­ï¸  Skipping Cloud Dashboard copy (no dist directory found)"
          fi

          # Copy Feed Yourself build (if dist exists)
          if [ -d "feed_yourself/dist" ]; then
            echo "ğŸ“¦ Copying Feed Yourself build..."
            mkdir -p _site/feed_yourself
            cp -r feed_yourself/dist/* _site/feed_yourself/
            echo "âœ… Feed Yourself build copied to _site/feed_yourself/"
          else
            echo "â­ï¸  Skipping Feed Yourself copy (no dist directory found)"
          fi

          echo "âœ… All files prepared for deployment"
          echo "ğŸ“Š Site structure:"
          ls -lah _site/
          echo ""
          echo "ğŸ“Š MyFeed contents:"
          ls -lah _site/myfeed/ 2>/dev/null || echo "No myfeed directory"

      - name: â¬†ï¸ Upload Site Artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4