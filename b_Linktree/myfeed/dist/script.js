"use strict";(()=>{var O=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],x=[{id:"github",name:"GitHub",color:"#238636",url:"https://github.com/diegonmarcos.atom",enabled:!0},{id:"youtube",name:"YouTube",color:"#ff0000",url:"",enabled:!1},{id:"lastfm",name:"Last.fm",color:"#d51007",url:"",enabled:!1},{id:"reddit",name:"Reddit",color:"#ff4500",url:"",enabled:!1},{id:"letterboxd",name:"Letterboxd",color:"#00d735",url:"",enabled:!1},{id:"mastodon",name:"Mastodon",color:"#6364ff",url:"",enabled:!1},{id:"goodreads",name:"Goodreads",color:"#553b08",url:"",enabled:!1},{id:"devto",name:"DEV.to",color:"#0a0a0a",url:"",enabled:!1}];async function W(e){try{let n=await fetch(e,{mode:"cors"});if(n.ok)return await n.text()}catch{}for(let n of O)try{let t=await fetch(n+encodeURIComponent(e));if(t.ok)return await t.text()}catch{console.warn(`Proxy ${n} failed`)}return null}function j(e){let t=new DOMParser().parseFromString(e,"text/xml"),s=[];return t.querySelectorAll("item").forEach((r,o)=>{if(o>=15)return;let i=r.querySelector("title")?.textContent||"",c=r.querySelector("link")?.textContent||"",l=r.querySelector("pubDate")?.textContent,d=r.querySelector("description")?.textContent||"";s.push({id:`rss-${o}`,title:i.replace(/<!\[CDATA\[|\]\]>/g,"").trim(),link:c,date:l?new Date(l):new Date,description:d.replace(/<[^>]*>/g,"").slice(0,100)})}),s.length===0&&t.querySelectorAll("entry").forEach((r,o)=>{if(o>=15)return;let i=r.querySelector("title")?.textContent||"",l=r.querySelector("link[href]")?.getAttribute("href")||"",d=r.querySelector("updated")?.textContent||r.querySelector("published")?.textContent;s.push({id:`atom-${o}`,title:i.trim(),link:l,date:d?new Date(d):new Date})}),s}var p="apps-feed-cache",J=5*60*1e3;function Z(e){try{let n=localStorage.getItem(p);if(n){let t=JSON.parse(n);if(t[e]&&Date.now()-t[e].timestamp<J)return t[e].items.map(s=>({...s,date:new Date(s.date)}))}}catch{}return null}function G(e,n){try{let t=localStorage.getItem(p),s=t?JSON.parse(t):{};s[e]={items:n,timestamp:Date.now()},localStorage.setItem(p,JSON.stringify(s))}catch{}}function Q(){localStorage.removeItem(p)}function b(e){let t=new Date().getTime()-e.getTime(),s=Math.floor(t/6e4),r=Math.floor(t/36e5),o=Math.floor(t/864e5);return s<1?"now":s<60?`${s}m`:r<24?`${r}h`:o<7?`${o}d`:e.toLocaleDateString()}function K(e){return`
    <div class="message-item">
      <div class="message-header">
        <span class="message-time">${b(e.date)}</span>
      </div>
      <a href="${e.link}" target="_blank" class="message-title">${e.title}</a>
      ${e.description?`<div class="message-body">${e.description}</div>`:""}
    </div>
  `}function X(){return'<div class="loading-state"><div class="skeleton-row"></div><div class="skeleton-row"></div></div>'}function _(e="No items"){return`<div class="empty-state">${e}</div>`}async function Y(e){if(!e.enabled||!e.url)return[];let n=Z(e.id);if(n)return n;try{let t=await W(e.url);if(!t)return[];let s=j(t);return G(e.id,s),s}catch(t){return console.warn(`Failed to fetch ${e.name}:`,t),[]}}async function A(e){let n=document.getElementById(`${e.id}-feed`),t=document.getElementById(`${e.id}-count`);if(!n)return;if(!e.enabled||!e.url){n.innerHTML=_("Configure in apps-feed.ts"),t&&(t.textContent="0");return}n.innerHTML=X();let s=await Y(e);s.length===0?n.innerHTML=_("No items"):n.innerHTML=s.map(K).join(""),t&&(t.textContent=String(s.length))}async function D(){await Promise.all(x.map(A));let e=document.getElementById("apps-last-update");e&&(e.textContent=`Updated ${b(new Date)}`);let n=document.getElementById("appsfeed-refresh");n&&n.addEventListener("click",async()=>{Q(),await Promise.all(x.map(A)),e&&(e.textContent=`Updated ${b(new Date)}`)})}var z=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],ee={world:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx1YlY4U0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},tech:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGRqTVhZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},science:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRFp0Y1RjU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},markets:{url:"https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx6TVdZU0FtVnVHZ0pWVXlnQVAB?hl=en-US&gl=US&ceid=US:en",source:"Google News"},hn:{url:"https://hnrss.org/newest?points=50",source:"Hacker News"}},E=new Map,te=5*60*1e3;async function ne(e){for(let n of z)try{let t=await fetch(n+encodeURIComponent(e));if(t.ok)return await t.text()}catch{console.warn(`Proxy ${n} failed for ${e}`)}return null}function se(e,n,t){let s=e.querySelector("title")?.textContent||"No title",r=e.querySelector("link")?.textContent||"",o=e.querySelector("pubDate")?.textContent||new Date().toISOString(),i=s.replace(/ - [^-]+$/,"");return{id:`news-${t}`,title:i,source:n,url:r,publishedAt:new Date(o)}}async function re(e){let n=ee[e];if(!n)return[];let t=E.get(e);if(t&&Date.now()-t.timestamp<te)return t.data;try{let s=await ne(n.url);if(!s)return t?.data||[];let i=new DOMParser().parseFromString(s,"text/xml").querySelectorAll("item"),c=[];return i.forEach((l,d)=>{d<15&&c.push(se(l,n.source,d))}),E.set(e,{data:c,timestamp:Date.now()}),c}catch(s){return console.error(`Error fetching RSS for ${e}:`,s),t?.data||[]}}function F(e){let t=new Date().getTime()-e.getTime(),s=Math.floor(t/6e4),r=Math.floor(t/36e5),o=Math.floor(t/864e5);return s<1?"now":s<60?`${s}m`:r<24?`${r}h`:o<7?`${o}d`:e.toLocaleDateString()}function oe(e){return`
    <div class="message-item">
      <div class="message-header">
        <span class="message-topic">${e.source}</span>
        <span class="message-time">${F(e.publishedAt)}</span>
      </div>
      <a href="${e.url}" target="_blank" class="message-title">${e.title}</a>
    </div>
  `}function ie(){return'<div class="loading-state"><div class="skeleton-row"></div><div class="skeleton-row"></div></div>'}function ae(){return'<div class="empty-state">No news available</div>'}async function $(){let e=["world","tech","science","markets","hn"];e.forEach(r=>{let o=document.getElementById(`${r}-feed`);o&&(o.innerHTML=ie())}),(await Promise.all(e.map(async r=>{let o=await re(r);return{category:r,items:o}}))).forEach(({category:r,items:o})=>{let i=document.getElementById(`${r}-feed`),c=document.getElementById(`${r}-count`);i&&(o.length===0?i.innerHTML=ae():i.innerHTML=o.map(oe).join(""),c&&(c.textContent=String(o.length)))});let t=document.getElementById("news-last-update");t&&(t.textContent=`Updated ${F(new Date)}`);let s=document.getElementById("newsfeed-refresh");s&&s.addEventListener("click",async()=>{E.clear(),await $()})}var m="https://alerts.diegonmarcos.com",ce="https://rss.diegonmarcos.com",le=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?"],de=["ssh","auth","sauron","authelia"],ue=["system","docker","npm","mailu","collector"],B=[{name:"gcp-arch",ip:"34.55.55.234"},{name:"oci-flex",ip:"84.235.234.87"},{name:"oci-micro-1",ip:"130.110.251.193"},{name:"oci-micro-2",ip:"129.151.228.66"}],H=["ssh","docker","system","sauron","collector","npm","authelia","mailu"],u=[],a=null,y=[],v=[],I="all",T="24h",k="",L="",M="",C=null,h=!0;async function g(e){try{let n=await fetch(e,{mode:"cors"});if(n.ok)return await n.text()}catch{}for(let n of le)try{let t=await fetch(n+encodeURIComponent(e));if(t.ok)return await t.text()}catch{console.warn(`Proxy ${n} failed`)}return null}function U(e){let n=typeof e=="string"?new Date(e):new Date(e*1e3),s=new Date().getTime()-n.getTime(),r=Math.floor(s/6e4),o=Math.floor(s/36e5),i=Math.floor(s/864e5);return r<1?"now":r<60?`${r}m ago`:o<24?`${o}h ago`:i<7?`${i}d ago`:n.toLocaleDateString()}function me(e){return new Date(e).toLocaleString()}function ge(e){let n=typeof e=="number"?e:e==="urgent"||e==="critical"?5:e==="high"?4:e==="default"?3:2;return n>=5?"priority-urgent":n>=4?"priority-high":n>=3?"priority-default":"priority-low"}function P(e){return{ssh:"#3fb950",auth:"#a371f7",sauron:"#f85149",docker:"#2496ed",system:"#8b949e",npm:"#f85149",mailu:"#d29922",authelia:"#a371f7",collector:"#58a6ff"}[e]||"#8b949e"}function q(e,n){return de.includes(e)||n==="auth"||n==="sauron"?"security":ue.includes(e)||n==="system"?"health":"debug"}function w(e,n=3e3){let t=document.getElementById("toast"),s=t?.querySelector(".toast-message");t&&s&&(s.textContent=e,t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),n))}async function fe(e){try{await navigator.clipboard.writeText(e),w("Copied to clipboard!")}catch{let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),w("Copied to clipboard!")}}async function pe(){try{let e=`${m}/api/alerts?since=${T}&limit=200`,n=await g(e);n&&(u=JSON.parse(n).alerts||[]);let t=`${m}/api/stats?since=${T}`,s=await g(t);s&&(a=JSON.parse(s));let r=`${m}/api/vms`,o=await g(r);o&&(y=JSON.parse(o).vms||[]);let i=`${m}/api/services`,c=await g(i);return c&&(v=JSON.parse(c).services||[]),!0}catch(e){return console.warn("API fetch failed, falling back to ntfy:",e),!1}}async function ye(){let e=["system","auth","sauron"],n=[];for(let t of e)try{let s=`${ce}/${t}/json?poll=1`,r=await g(s);if(r){let o=r.trim().split(`
`).filter(i=>i);for(let i of o)try{let c=JSON.parse(i);c.event==="message"&&n.push(c)}catch{}}}catch{console.warn(`Failed to fetch ntfy topic ${t}`)}u=n.map((t,s)=>({id:s,timestamp:new Date(t.time*1e3).toISOString(),vm:ve(t.message||t.title||""),service:he(t.topic),topic:t.topic,title:t.title||"Notification",message:t.message||"",priority:t.priority?.toString()||"default",tags:t.tags?.join(",")||"",log_cmd:"",log_path:"",acknowledged:0,ntfy_id:t.id})).sort((t,s)=>new Date(s.timestamp).getTime()-new Date(t.timestamp).getTime()),a={total:u.length,by_priority:{},by_service:{},by_vm:{}},u.forEach(t=>{a.by_priority[t.priority]=(a.by_priority[t.priority]||0)+1,a.by_service[t.service]=(a.by_service[t.service]||0)+1,a.by_vm[t.vm]=(a.by_vm[t.vm]||0)+1}),y=B.map(t=>({name:t.name,status:"unknown",last_seen:""})),v=H.map(t=>({name:t,vm:"",status:"unknown",last_seen:""}))}function ve(e){let n=e.match(/\[([\w-]+)\]/);return n?n[1]:"unknown"}function he(e){return e==="auth"?"ssh":e==="sauron"?"sauron":"system"}function we(){let e=document.querySelector("#counter-critical .counter-value"),n=document.querySelector("#counter-high .counter-value"),t=document.querySelector("#counter-default .counter-value"),s=document.querySelector("#counter-total .counter-value");if(a){let r=(a.by_priority.urgent||0)+(a.by_priority.critical||0)+(a.by_priority[5]||0),o=(a.by_priority.high||0)+(a.by_priority[4]||0),i=(a.by_priority.default||0)+(a.by_priority[3]||0);e&&(e.textContent=String(r)),n&&(n.textContent=String(o)),t&&(t.textContent=String(i)),s&&(s.textContent=String(a.total))}}function Se(){let e=document.getElementById("vm-status");if(!e)return;let n=y.length>0?y:B.map(t=>({name:t.name,status:"unknown",last_seen:""}));e.innerHTML=n.map(t=>{let s=t.status==="online"?"online":t.status==="offline"?"offline":"unknown",r=a?.by_vm[t.name]||0;return`
      <div class="status-card ${s}">
        <div class="status-indicator"></div>
        <div class="status-info">
          <span class="status-name">${t.name}</span>
          <span class="status-detail">${r} alerts</span>
        </div>
      </div>
    `}).join("")}function be(){let e=document.getElementById("service-status");if(!e)return;let n=v.length>0?v:H.map(t=>({name:t,vm:"",status:"unknown",last_seen:""}));e.innerHTML=n.map(t=>{let s=P(t.name),r=a?.by_service[t.name]||0;return`
      <div class="status-card service ${t.status==="active"?"online":t.status==="error"?"offline":"unknown"}" style="--service-color: ${s}">
        <div class="status-indicator" style="background: ${s}"></div>
        <div class="status-info">
          <span class="status-name">${t.name}</span>
          <span class="status-detail">${r} alerts</span>
        </div>
      </div>
    `}).join("")}function f(){let e=document.getElementById("alert-feed");if(!e)return;let n=u.filter(t=>{if(I!=="all"&&q(t.service,t.topic)!==I||L&&t.vm!==L||M&&t.service!==M)return!1;if(k){let s=k.toLowerCase();if(!`${t.title} ${t.message} ${t.vm} ${t.service}`.toLowerCase().includes(s))return!1}return!0});if(n.length===0){e.innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">&#128269;</div>
        <p>No alerts found</p>
        <span>Try adjusting your filters or time range</span>
      </div>
    `;return}e.innerHTML=n.map(t=>Ee(t)).join(""),e.querySelectorAll(".copy-btn").forEach(t=>{t.addEventListener("click",s=>{let o=s.currentTarget.dataset.copy||"";fe(o)})}),e.querySelectorAll(".ack-btn").forEach(t=>{t.addEventListener("click",async s=>{let r=s.currentTarget,o=r.dataset.alertId;if(o&&h)try{await fetch(`${m}/api/alerts/${o}/ack`,{method:"POST"}),r.closest(".alert-card")?.classList.add("acknowledged"),w("Alert acknowledged")}catch{w("Failed to acknowledge")}})})}function Ee(e){let n=ge(e.priority),t=P(e.service),s=q(e.service,e.topic),r=s==="security"?"&#128274;":s==="health"?"&#128153;":"&#128736;",o=e.acknowledged?"acknowledged":"";return`
    <div class="alert-card ${n} ${o}" data-category="${s}">
      <div class="alert-header">
        <div class="alert-meta">
          <span class="alert-category" title="${s}">${r}</span>
          <span class="alert-service" style="background: ${t}">${e.service}</span>
          <span class="alert-vm">${e.vm}</span>
          <span class="alert-topic">${e.topic}</span>
        </div>
        <div class="alert-time" title="${me(e.timestamp)}">
          ${U(e.timestamp)}
        </div>
      </div>

      <div class="alert-body">
        <div class="alert-title">${e.title}</div>
        ${e.message?`<div class="alert-message">${e.message}</div>`:""}
      </div>

      ${e.log_cmd?`
        <div class="alert-log-cmd">
          <code>${e.log_cmd}</code>
          <button class="copy-btn" data-copy="${R(e.log_cmd)}" title="Copy command">
            &#128203;
          </button>
        </div>
      `:""}

      <div class="alert-actions">
        ${e.tags?`<span class="alert-tags">${$e(e.tags)}</span>`:""}
        <div class="alert-buttons">
          ${!e.acknowledged&&h?`
            <button class="ack-btn" data-alert-id="${e.id}" title="Acknowledge">
              &#10003;
            </button>
          `:""}
          ${e.log_cmd?`
            <button class="copy-btn" data-copy="ssh ${Ce(e.vm)} '${R(e.log_cmd)}'" title="Copy SSH command">
              &#128187;
            </button>
          `:""}
        </div>
      </div>
    </div>
  `}function R(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function $e(e){return e?e.split(",").map(n=>`<span class="tag">${n.trim()}</span>`).join(""):""}function Ce(e){return{"gcp-arch":"diego@34.55.55.234","oci-flex":"ubuntu@84.235.234.87","oci-micro-1":"ubuntu@130.110.251.193","oci-micro-2":"ubuntu@129.151.228.66"}[e]||`user@${e}`}function Ie(){let e=document.getElementById("vm-filter"),n=document.getElementById("service-filter");if(e){let t=[...new Set(u.map(s=>s.vm))].filter(Boolean);e.innerHTML='<option value="">All VMs</option>'+t.map(s=>`<option value="${s}">${s}</option>`).join("")}if(n){let t=[...new Set(u.map(s=>s.service))].filter(Boolean);n.innerHTML='<option value="">All Services</option>'+t.map(s=>`<option value="${s}">${s}</option>`).join("")}}function Te(){let e=document.getElementById("last-update");e&&(e.textContent=`Updated ${U(new Date().toISOString())}`)}function N(e){let n=document.getElementById("live-indicator"),t=document.getElementById("refresh-icon");n&&n.classList.toggle("loading",e),t&&t.classList.toggle("spinning",e)}async function S(){N(!0),await pe()?h=!0:(h=!1,await ye()),we(),Se(),be(),f(),Ie(),Te(),N(!1)}function ke(){document.getElementById("refresh-btn")?.addEventListener("click",S);let n=document.getElementById("time-filter");n?.addEventListener("change",()=>{T=n.value,S()}),document.querySelectorAll(".tab-btn").forEach(i=>{i.addEventListener("click",()=>{document.querySelectorAll(".tab-btn").forEach(c=>c.classList.remove("active")),i.classList.add("active"),I=i.dataset.category||"all",f()})});let t=document.getElementById("search-input"),s;t?.addEventListener("input",()=>{clearTimeout(s),s=setTimeout(()=>{k=t.value,f()},300)});let r=document.getElementById("vm-filter");r?.addEventListener("change",()=>{L=r.value,f()});let o=document.getElementById("service-filter");o?.addEventListener("change",()=>{M=o.value,f()})}function V(){S(),ke(),C=setInterval(S,3e4),window.addEventListener("beforeunload",()=>{C&&clearInterval(C)})}function Le(){let e=window.location.pathname;return e.includes("appsfeed.html")?"appsfeed":e.includes("newsfeed.html")?"newsfeed":e.includes("cloudfeed.html")?"cloudfeed":"index"}document.addEventListener("DOMContentLoaded",()=>{switch(Le()){case"appsfeed":D();break;case"newsfeed":$();break;case"cloudfeed":V(),Me();break;default:break}});function Me(){let e=document.querySelectorAll(".mode-btn"),n=document.getElementById("api-mode"),t=document.getElementById("rss-mode");e.forEach(s=>{s.addEventListener("click",()=>{let r=s.dataset.mode;e.forEach(o=>o.classList.remove("active")),s.classList.add("active"),r==="api"?(n?.style.setProperty("display","block"),t?.style.setProperty("display","none")):(n?.style.setProperty("display","none"),t?.style.setProperty("display","block"))})})}})();
