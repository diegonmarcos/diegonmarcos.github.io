name: GitHub Pages Deployment (CI)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to compare changes

      - name: ğŸ“‚ Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v41

      # ============================================
      # SETUP NODE.JS
      # ============================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Generating merged package.json and installing..."
          bash deploy.sh deps
          echo "âœ… Dependencies installed"

      # ============================================
      # PROJECT BUILDS (All use build.sh)
      # ============================================
      - name: ğŸ”¨ Build Root Index (e-Root)
        id: build-c-root
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'e-Root/')
          || hashFiles('e-Root/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Root Index (e-Root)..."
          cd e-Root
          bash build.sh build
          cd ..
          echo "âœ… Root Index build complete"

      - name: ğŸ”¨ Build Landpage
        id: build-landpage
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'b-Profiles/landpage/')
          || hashFiles('b-Profiles/landpage/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Landpage..."
          cd b-Profiles/landpage
          bash build.sh build
          cd ../..
          echo "âœ… Landpage build complete"

      - name: ğŸ”¨ Build Linktree
        id: build-linktree
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'a-Portals/linktree/')
          || hashFiles('a-Portals/linktree/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Linktree..."
          cd a-Portals/linktree
          bash build.sh build
          cd ../..
          echo "âœ… Linktree build complete"

      - name: ğŸ”¨ Build Linktree Mindmap
        id: build-linktree-mindmap
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'a-Portals/linktree_mindmap/')
          || hashFiles('a-Portals/linktree_mindmap/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Linktree Mindmap..."
          cd a-Portals/linktree_mindmap
          bash build.sh build
          cd ../..
          echo "âœ… Linktree Mindmap build complete"

      - name: ğŸ”¨ Build Linktree Pixel World
        id: build-linktree-pixel-world
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'a-Portals/linktree_pixel-world/')
          || hashFiles('a-Portals/linktree_pixel-world/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Linktree Pixel World..."
          cd a-Portals/linktree_pixel-world
          bash build.sh build
          cd ../..
          echo "âœ… Linktree Pixel World build complete"

      - name: ğŸ”¨ Build CV Web
        id: build-cv-web
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'b-Profiles/cv_web/')
          || hashFiles('b-Profiles/cv_web/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building CV Web..."
          cd b-Profiles/cv_web
          bash build.sh build
          cd ../..
          echo "âœ… CV Web build complete"

      - name: ğŸ”¨ Build MyFeed
        id: build-myfeed
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/myfeed/')
          || hashFiles('c-Tools/myfeed/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyFeed..."
          cd c-Tools/myfeed
          bash build.sh build
          cd ../..
          echo "âœ… MyFeed build complete"

      - name: ğŸ”¨ Build MyGames
        id: build-mygames
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/mygames/')
          || hashFiles('c-Tools/mygames/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyGames..."
          cd c-Tools/mygames
          bash build.sh build
          cd ../..
          echo "âœ… MyGames build complete"

      - name: ğŸ”¨ Build Nexus
        id: build-nexus
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'b-Profiles/nexus/')
          || hashFiles('b-Profiles/nexus/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Nexus..."
          cd b-Profiles/nexus
          bash build.sh build
          cd ../..
          echo "âœ… Nexus build complete"

      - name: ğŸ”¨ Build Cloud Dashboard
        id: build-cloud
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'a-Portals/cloud/')
          || hashFiles('a-Portals/cloud/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Cloud Dashboard..."
          cd a-Portals/cloud
          bash build.sh build
          cd ../..
          echo "âœ… Cloud Dashboard build complete"

      - name: ğŸ”¨ Build Feed Yourself
        id: build-feed-yourself
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/feed_yourself/')
          || hashFiles('c-Tools/feed_yourself/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Feed Yourself..."
          cd c-Tools/feed_yourself
          bash build.sh build
          cd ../..
          echo "âœ… Feed Yourself build complete"

      - name: ğŸ”¨ Build Others
        id: build-others
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'e-Others/others/')
          || hashFiles('e-Others/others/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Others..."
          cd e-Others/others
          bash build.sh build
          cd ../..
          echo "âœ… Others build complete"

      - name: ğŸ”¨ Build Sailytics
        id: build-sailytics
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'e-Others/sailytics/')
          || hashFiles('e-Others/sailytics/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Sailytics..."
          cd e-Others/sailytics
          bash build.sh build
          cd ../..
          echo "âœ… Sailytics build complete"

      - name: ğŸ”¨ Build MyMail
        id: build-mymail
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Suite/mymail/')
          || hashFiles('c-Suite/mymail/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyMail..."
          cd c-Suite/mymail
          bash build.sh build
          cd ../..
          echo "âœ… MyMail build complete"

      - name: ğŸ”¨ Build MyPhotos
        id: build-myphotos
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Suite/myphotos/')
          || hashFiles('c-Suite/myphotos/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyPhotos..."
          cd c-Suite/myphotos
          bash build.sh build
          cd ../..
          echo "âœ… MyPhotos build complete"

      - name: ğŸ”¨ Build MyAnalytics
        id: build-myanalytics
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Suite/myanalytics/')
          || hashFiles('c-Suite/myanalytics/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyAnalytics..."
          cd c-Suite/myanalytics
          bash build.sh build
          cd ../..
          echo "âœ… MyAnalytics build complete"

      - name: ğŸ”¨ Build Suite
        id: build-suite
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Suite/suite/')
          || hashFiles('c-Suite/suite/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Suite..."
          cd c-Suite/suite
          bash build.sh build
          cd ../..
          echo "âœ… Suite build complete"

      - name: ğŸ”¨ Build Health Tracker
        id: build-health-tracker
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/health_tracker/')
          || hashFiles('c-Tools/health_tracker/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Health Tracker..."
          cd c-Tools/health_tracker
          bash build.sh build
          cd ../..
          echo "âœ… Health Tracker build complete"

      - name: ğŸ”¨ Build Market Watch
        id: build-market-watch
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/market_watch/')
          || hashFiles('c-Tools/market_watch/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Market Watch..."
          cd c-Tools/market_watch
          bash build.sh build
          cd ../..
          echo "âœ… Market Watch build complete"

      - name: ğŸ”¨ Build Central Bank
        id: build-central-bank
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/central_bank/')
          || hashFiles('c-Tools/central_bank/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Central Bank..."
          cd c-Tools/central_bank
          bash build.sh build
          cd ../..
          echo "âœ… Central Bank build complete"

      - name: ğŸ”¨ Build MyProfile
        id: build-myprofile
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'b-Profiles/myprofile/')
          || hashFiles('b-Profiles/myprofile/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyProfile..."
          cd b-Profiles/myprofile
          bash build.sh build
          cd ../..
          echo "âœ… MyProfile build complete"

      - name: ğŸ”¨ Build MyMovies (Vue 3)
        id: build-mymovies
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/mymovies/')
          || hashFiles('c-Tools/mymovies/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyMovies..."
          cd c-Tools/mymovies
          bash build.sh build
          cd ../..
          echo "âœ… MyMovies build complete"

      - name: ğŸ”¨ Build MyMusic (Vue 3)
        id: build-mymusic
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/mymusic/')
          || hashFiles('c-Tools/mymusic/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyMusic..."
          cd c-Tools/mymusic
          bash build.sh build
          cd ../..
          echo "âœ… MyMusic build complete"

      - name: ğŸ”¨ Build JSON Vision (Vue 3)
        id: build-json-vision
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Suite/json-vision/')
          || hashFiles('c-Suite/json-vision/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building JSON Vision..."
          cd c-Suite/json-vision
          bash build.sh build
          cd ../..
          echo "âœ… JSON Vision build complete"

      - name: ğŸ”¨ Build Carto (TypeScript + Sass)
        id: build-carto
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/carto/')
          || hashFiles('c-Tools/carto/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Carto..."
          cd c-Tools/carto
          bash build.sh build
          cd ../..
          echo "âœ… Carto build complete"

      - name: ğŸ”¨ Build MyTrips (Vue 3 + TypeScript + SCSS)
        id: build-mytrips
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/mytrips/')
          || hashFiles('c-Tools/mytrips/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyTrips..."
          cd c-Tools/mytrips
          bash build.sh build
          cd ../..
          echo "âœ… MyTrips build complete"

      - name: ğŸ”¨ Build Leafy (TypeScript + SCSS + Shaders)
        id: build-leafy
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'b-Profiles/leafy/')
          || hashFiles('b-Profiles/leafy/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Leafy..."
          cd b-Profiles/leafy
          bash build.sh build
          cd ../..
          echo "âœ… Leafy build complete"

      - name: ğŸ”¨ Build MyMaps SvelteKit (SvelteKit + MapLibre)
        id: build-mymaps-svelte
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/mymaps/')
          || hashFiles('c-Tools/mymaps/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building MyMaps SvelteKit..."
          cd c-Tools/mymaps
          bash build.sh build
          cd ../..
          echo "âœ… MyMaps SvelteKit build complete"

      - name: ğŸ”¨ Build Maps Classic (React + Vite)
        id: build-maps-classic
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/maps/')
          || hashFiles('c-Tools/maps/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Maps Classic..."
          cd c-Tools/maps
          bash build.sh build
          cd ../..
          echo "âœ… Maps Classic build complete"

      # ============================================
      # MISSING BUILD STEPS (Previously only had copy steps)
      # ============================================
      - name: ğŸ”¨ Build CV PDF
        id: build-cv-pdf
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'b-Profiles/cv_pdf/')
          || hashFiles('b-Profiles/cv_pdf/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building CV PDF..."
          cd b-Profiles/cv_pdf
          bash build.sh build
          cd ../..
          echo "âœ… CV PDF build complete"

      - name: ğŸ”¨ Build Astro
        id: build-astro
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'c-Tools/astro/')
          || hashFiles('c-Tools/astro/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Astro..."
          cd c-Tools/astro
          bash build.sh build
          cd ../..
          echo "âœ… Astro build complete"

      - name: ğŸ”¨ Build Skills & MCP Docs
        id: build-skills-mcp
        if: >-
          contains(steps.changed-files.outputs.all_changed_files, 'd-Cloud/skills_mcp/')
          || hashFiles('d-Cloud/skills_mcp/dist/**') == ''
        continue-on-error: true
        run: |
          echo "ğŸ”¨ Building Skills & MCP Docs..."
          cd d-Cloud/skills_mcp
          bash build.sh build
          cd ../..
          echo "âœ… Skills & MCP Docs build complete"

      - name: ğŸŒ Setup Pages Environment
        uses: actions/configure-pages@v5

      - name: ğŸ“‚ Deploy All Projects to _site
        run: |
          echo "============================================"
          echo "ğŸ“‚ DEPLOYING ALL PROJECTS TO _site"
          echo "============================================"

          mkdir -p _site
          FAILED=""
          COPIED=0
          SKIPPED=0

          # Project registry: path:deploy_name
          PROJECTS=(
            "e-Root:."
            "a-Portals/cloud:cloud"
            "a-Portals/linktree:linktree"
            "a-Portals/linktree_mindmap:linktree_mindmap"
            "a-Portals/linktree_pixel-world:linktree_pixel-world"
            "b-Profiles/cv_pdf:cv_pdf"
            "b-Profiles/cv_web:cv_web"
            "b-Profiles/landpage:landpage"
            "b-Profiles/leafy:leafy"
            "b-Profiles/myprofile:myprofile"
            "b-Profiles/nexus:nexus"
            "c-Suite/json-vision:json-vision"
            "c-Suite/myanalytics:myanalytics"
            "c-Suite/mymail:mymail"
            "c-Suite/myphotos:myphotos"
            "c-Suite/suite:suite"
            "c-Tools/astro:astro"
            "c-Tools/carto:carto"
            "c-Tools/central_bank:central_bank"
            "c-Tools/feed_yourself:feed_yourself"
            "c-Tools/health_tracker:health_tracker"
            "c-Tools/maps:maps"
            "c-Tools/market_watch:market_watch"
            "c-Tools/myfeed:myfeed"
            "c-Tools/mygames:mygames"
            "c-Tools/mymaps:mymaps"
            "c-Tools/mymovies:mymovies"
            "c-Tools/mymusic:mymusic"
            "c-Tools/mytrips:mytrips"
            "d-Cloud/api:api"
            "d-Cloud/skills_mcp:skills_mcp"
            "e-Others/others:others"
            "e-Others/sailytics:sailytics"
          )

          for entry in "${PROJECTS[@]}"; do
            SRC="${entry%%:*}"
            NAME="${entry##*:}"
            DIST="$SRC/dist"

            # Special cases
            [ "$SRC" = "d-Cloud/api" ] && DIST="$SRC/src"

            if [ ! -d "$DIST" ]; then
              echo "â­ï¸  $NAME (no dist/)"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            # Check dist has files
            if [ -z "$(ls -A "$DIST" 2>/dev/null)" ]; then
              echo "âš ï¸  $NAME (dist/ empty)"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            # Copy (dot-copy resolves symlinks, never fails on empty)
            if [ "$NAME" = "." ]; then
              cp -rL "$DIST"/. _site/ 2>/dev/null || true
            else
              mkdir -p "_site/$NAME"
              cp -rL "$DIST"/. "_site/$NAME/" 2>/dev/null || true
            fi

            # Validate
            TARGET="_site"
            [ "$NAME" != "." ] && TARGET="_site/$NAME"
            COUNT=$(find "$TARGET" -type f 2>/dev/null | wc -l)
            if [ "$COUNT" -gt 0 ]; then
              echo "âœ… $NAME ($COUNT files)"
              COPIED=$((COPIED + 1))
            else
              echo "âŒ $NAME (0 files after copy)"
              FAILED="$FAILED $NAME"
            fi
          done

          # Summary
          echo "========================================="
          echo "ğŸ“Š DEPLOY: $COPIED copied, $SKIPPED skipped"
          [ -n "$FAILED" ] && echo "âš ï¸ FAILED:$FAILED" && echo "::warning::Deploy failures:$FAILED"
          echo "========================================="

          # Clean broken symlinks
          find _site -type l ! -exec test -e {} \; -delete 2>/dev/null || true

          echo "ğŸ“Š Site structure:"
          ls -lah _site/ | head -20

      - name: â¬†ï¸ Upload Site Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
