name: GitHub Pages Deployment (CI)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to compare changes

      - name: üìÇ Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v41

      # ============================================
      # SASS COMPILATION (Conditional)
      # ============================================
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            1.ops/package-lock.json

      - name: üé® Build CSS from Sass (Root)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, '3.sass/')
        run: |
          echo "üìÅ Building root Sass..."
          cd 1.ops
          npm install
          npm run sass:build
          cd ..
          echo "‚úÖ Root style.css created"

      - name: üé® Build CSS from Sass (cv_web)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'cv_web/3.sass/')
        run: |
          echo "üìÅ Building cv_web Sass..."
          cd 1.ops
          npm install
          # This should be adapted if cv_web has a different build script
          # Assuming it uses the same for now
          npm run sass:build 
          cd ..
          echo "‚úÖ cv_web/style.css created"

      # ============================================
      # TYPESCRIPT COMPILATION (Conditional)
      # ============================================
      - name: üìú Build JS from TypeScript
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, '4.ts/')
        run: |
          echo "üìú Building TypeScript..."
          cd 1.ops
          npm install
          npm run ts:build
          cd ..
          echo "‚úÖ script.js created"

      # ============================================
      # JEKYLL BLOG BUILD (Conditional)
      # ============================================
      - name: üíé Setup Ruby and Jekyll
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'blog/')
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: üì¶ Install Jekyll
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'blog/')
        run: |
          gem install jekyll bundler

      - name: üî® Build Blog HTML (Jekyll)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'blog/')
        run: |
          cd blog/1.ops
          chmod +x build.sh
          ./build.sh build
          echo "‚úÖ Blog HTML files generated"

      - name: üî® Build MyProfile (SvelteKit)
        if: steps.changed-files.outputs.any_changed && contains(steps.changed-files.outputs.all_changed_files, 'myprofile/')
        run: |
          echo "üî® Building MyProfile SvelteKit project..."
          cd myprofile/1.3.svelte
          npm install
          npm run build
          cd ../../..
          echo "‚úÖ MyProfile build complete"

      - name: üåê Setup Pages Environment
        uses: actions/configure-pages@v5

      - name: üìÇ Prepare Site for Deployment
        run: |
          echo "üìã Creating _site directory and copying all files..."
          mkdir -p _site
          # Copy all relevant files and directories
          cp -r index.html style.css script.js linktree/ cv_web/ cv_pdf/ assets/ others/ blog/ _site/ 2>/dev/null || true
          
          # Create myprofile directory in _site and copy built assets (if build exists)
          if [ -d "myprofile/1.3.svelte/build" ]; then
            mkdir -p _site/myprofile
            cp -r myprofile/1.3.svelte/build/* _site/myprofile/
            echo "‚úÖ MyProfile built assets copied"
          else
            echo "‚è≠Ô∏è  Skipping MyProfile copy (no build directory found)"
          fi

          # Clean up source files from blog deployment
          find _site/blog -name "*.md" -type f -delete
          rm -f _site/blog/_config.yml
          rm -f _site/blog/build.sh
          rm -rf _site/blog/_layouts
          rm -rf _site/blog/.jekyll-cache
          
          echo "‚úÖ All files prepared for deployment"
          ls -lah _site/

      - name: ‚¨ÜÔ∏è Upload Site Artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4